# V4版本模型优化方案

## 当前状况分析

- **当前线上MAE**: 745.0925
- **预期范围**: 650-700
- **目标**: 500以下

虽然相比最初的版本已经有了显著改善，但仍有进一步优化的空间。

## V3模型问题诊断

通过V3分析脚本发现以下问题：

### 1. 价格分段不够精细
- 当前仅使用10000作为分界点，未能充分捕捉不同价格区间的数据特征
- 训练集价格分布显示：
  - <5K: 63.5%
  - 5K-10K: 19.1%
  - 10K-15K: 8.3%
  - 15K-20K: 4.3%
  - >20K: 4.8%

### 2. 特征工程仍有提升空间
- 缺乏足够的时间序列特征
- 交叉特征的复杂度不够
- 缺少非线性变换特征

### 3. 模型集成策略可以优化
- 当前仅使用LightGBM和XGBoost
- 缺少CatBoost等其他优秀模型
- 集成权重固定，未根据验证集表现动态调整

## V4优化策略

### 1. 多分段建模策略
将价格区间细分为5个段落，针对每个区间单独训练模型：
- **very_low** (0-5K): 63.5%的样本
- **low** (5K-10K): 19.1%的样本
- **medium** (10K-20K): 12.6%的样本
- **high** (20K-35K): 3.9%的样本
- **very_high** (35K+): 0.9%的样本

每个区间使用不同的特征集和模型参数，以更好地适应该区间的数据特征。

### 2. 增强特征工程
添加更多高级特征：

#### 时间序列特征
- km_per_year: 每年行驶公里数
- log_kilometer: 公里数对数变换
- log_car_age: 车龄对数变换

#### 复杂交叉特征
- power_km_ratio: 功率与公里数比值
- power_km_product: 功率与公里数乘积
- power_div_km: 调整后的功率与公里数比值

#### 统计特征
- v_mean: v_*特征的均值
- v_std: v_*特征的标准差
- v_max: v_*特征的最大值
- v_min: v_*特征的最小值
- v_range: v_*特征的范围
- v_skew: v_*特征的偏度

### 3. 模型集成优化
引入CatBoost模型，形成三模型集成：
- LightGBM: 40%权重
- XGBoost: 30%权重
- CatBoost: 30%权重

根据不同价格区间的验证集表现，动态调整权重。

### 4. 高级校准技术
实施两层校准：

#### 全局校准
基于整体均值差异进行校准：
```
calibrated_predictions = predictions - 0.6 * (pred_mean - train_mean)
```

#### 分段校准
针对每个价格区间进行局部校准：
```
segment_mean = calibrated_predictions[segment_mask].mean()
train_segment_mean = y_train[(y_train >= min_price) & (y_train < max_price)].mean()
calibrated_predictions[segment_mask] = calibrated_predictions[segment_mask] - 0.3 * (segment_mean - train_segment_mean)
```

## 模型参数优化

### 更强的正则化
- num_leaves: 从15降低到12
- max_depth: 从4降低到3
- min_data_in_leaf: 从200增加到250
- feature_fraction: 从0.6降低到0.5
- bagging_fraction: 从0.6降低到0.5
- lambda_l1: 从1.0增加到1.5
- lambda_l2: 从1.0增加到1.5

### 更低的学习率
- learning_rate: 从0.05降低到0.03

### 更少的迭代次数
- n_estimators: 保持150不变

## 预期效果

通过实施以上优化措施，预期可以将MAE进一步降低到以下范围：
- **V4优化后**: 680-720
- **中期优化后**: 620-680
- **长期优化后**: 550-620

## 实施计划

### 短期优化（已完成）
1. 实施多分段建模策略
2. 添加更多交叉特征和统计特征
3. 引入CatBoost模型
4. 实施高级校准技术

### 中期优化（建议）
1. 使用贝叶斯优化寻找最优超参数
2. 实现动态权重分配机制
3. 添加更多非线性特征变换

### 长期优化（建议）
1. 尝试深度学习模型（如神经网络）
2. 实现Stacking集成方法
3. 使用AutoML工具进行自动化特征工程和模型选择

## 风险与注意事项

1. **过拟合风险**：增加模型复杂度可能带来过拟合，需要在每次优化后及时验证
2. **计算资源**：增加模型数量和复杂度会增加训练时间和内存消耗
3. **模型解释性**：复杂的集成模型可能降低模型的解释性
4. **部署复杂性**：多模型集成会增加部署和维护的复杂性

## 结论

V4版本通过实施更精细的分段建模策略、增强特征工程、引入CatBoost模型和高级校准技术，有望将MAE从745.0925降低到680-720范围内。建议提交V4模型的预测结果进行验证，并根据线上表现进一步调整优化策略。