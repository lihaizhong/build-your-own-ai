<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é™¢ç—…åºŠä½¿ç”¨æƒ…å†µå¯è§†åŒ–å¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #bbe1fa 100%);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .dashboard-header {
            text-align: center;
            padding: 20px 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .dashboard-title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .update-time {
            font-size: 0.9em;
            opacity: 0.6;
        }
        
        /* å…³é”®æŒ‡æ ‡å¡ç‰‡æ ·å¼ */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
            margin-bottom: 10px;
        }
        
        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00d4ff;
        }
        
        .kpi-label {
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        .kpi-unit {
            font-size: 0.8em;
            opacity: 0.6;
            margin-top: 5px;
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            padding: 0 20px 20px;
            height: calc(100vh - 300px);
        }
        
        .chart-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #00d4ff;
        }
        
        .chart-content {
            flex: 1;
            min-height: 300px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr);
                height: auto;
            }
            
            .kpi-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .kpi-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-title {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">ğŸ¥ åŒ»é™¢ç—…åºŠä½¿ç”¨æƒ…å†µå¯è§†åŒ–å¤§å±</h1>
        <p class="dashboard-subtitle">å®æ—¶ç›‘æ§ç—…åºŠå ç”¨ç‡ä¸åˆ†å¸ƒæƒ…å†µ</p>
        <p class="update-time">æœ€åæ›´æ–°æ—¶é—´ï¼š<span id="updateTime"></span></p>
    </div>

    <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-value" id="totalBeds">-</div>
            <div class="kpi-label">æ€»åºŠä½æ•°</div>
            <div class="kpi-unit">å¼ </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="occupiedBeds">-</div>
            <div class="kpi-label">å·²å ç”¨åºŠä½</div>
            <div class="kpi-unit">å¼ </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="availableBedsKPI">-</div>
            <div class="kpi-label">ç©ºé—²åºŠä½</div>
            <div class="kpi-unit">å¼ </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="occupancyRate">-</div>
            <div class="kpi-label">æ•´ä½“å ç”¨ç‡</div>
            <div class="kpi-unit">%</div>
        </div>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="charts-container">
        <!-- å„ç§‘å®¤ç—…åºŠå ç”¨ç‡ç¯å½¢å›¾ -->
        <div class="chart-panel">
            <div class="chart-title">ğŸ“Š å„ç§‘å®¤ç—…åºŠå ç”¨ç‡åˆ†å¸ƒ</div>
            <div class="chart-content" id="departmentOccupancy"></div>
        </div>

        <!-- ç—…åºŠä½¿ç”¨ç‡è¶‹åŠ¿å›¾ -->
        <div class="chart-panel">
            <div class="chart-title">ğŸ“ˆ 24å°æ—¶ç—…åºŠå ç”¨ç‡è¶‹åŠ¿</div>
            <div class="chart-content" id="occupancyTrend"></div>
        </div>

        <!-- å„ç§‘å®¤ç©ºé—²åºŠä½æŸ±çŠ¶å›¾ -->
        <div class="chart-panel">
            <div class="chart-title">ğŸ›ï¸ å„ç§‘å®¤ç©ºé—²åºŠä½æ•°é‡</div>
            <div class="chart-content" id="availableBedsChart"></div>
        </div>

        <!-- ç—…åºŠåˆ†å¸ƒçƒ­åŠ›çŸ©é˜µ -->
        <div class="chart-panel">
            <div class="chart-title">ğŸ”¥ ç—…åºŠåˆ†å¸ƒçƒ­åŠ›å›¾</div>
            <div class="chart-content" id="bedDistribution"></div>
        </div>
    </div>

    <script>
        // å›¾è¡¨å®ä¾‹å­˜å‚¨
        const charts = {};
        
        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initCharts() {
            charts.departmentOccupancy = echarts.init(document.getElementById('departmentOccupancy'));
            charts.occupancyTrend = echarts.init(document.getElementById('occupancyTrend'));
            charts.availableBeds = echarts.init(document.getElementById('availableBedsChart'));
            charts.bedDistribution = echarts.init(document.getElementById('bedDistribution'));
            
            console.log('å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // åŠ è½½å…³é”®æŒ‡æ ‡æ•°æ®
        async function loadKeyIndicators() {
            try {
                const response = await fetch('/api/key_indicators');
                const data = await response.json();
                
                document.getElementById('totalBeds').textContent = data.total_beds;
                document.getElementById('occupiedBeds').textContent = data.occupied_beds;
                document.getElementById('availableBedsKPI').textContent = data.available_beds;
                document.getElementById('occupancyRate').textContent = data.occupancy_rate;
                
            } catch (error) {
                console.error('åŠ è½½å…³é”®æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç§‘å®¤å ç”¨ç‡ç¯å½¢å›¾
        async function loadDepartmentOccupancy() {
            try {
                const response = await fetch('/api/department_occupancy');
                const data = await response.json();
                
                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c}% ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        right: '10%',
                        top: 'center',
                        textStyle: {
                            color: '#fff',
                            fontSize: 12
                        }
                    },
                    series: [
                        {
                            name: 'ç§‘å®¤å ç”¨ç‡',
                            type: 'pie',
                            radius: ['45%', '75%'],
                            center: ['40%', '50%'],
                            avoidLabelOverlap: false,
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold',
                                    color: '#fff'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: data.map((item, index) => ({
                                value: item.value,
                                name: item.name,
                                itemStyle: {
                                    color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'][index % 8]
                                }
                            }))
                        }
                    ]
                };
                
                charts.departmentOccupancy.setOption(option);
            } catch (error) {
                console.error('åŠ è½½ç§‘å®¤å ç”¨ç‡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å ç”¨ç‡è¶‹åŠ¿å›¾
        async function loadOccupancyTrend() {
            try {
                const response = await fetch('/api/occupancy_trend');
                const data = await response.json();
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#6a7985'
                            }
                        }
                    },
                    legend: {
                        data: ['å ç”¨ç‡', 'å ç”¨åºŠä½æ•°'],
                        textStyle: { color: '#fff' }
                    },
                    xAxis: [
                        {
                            type: 'category',
                            boundaryGap: false,
                            data: data.times,
                            axisLabel: { color: '#fff' },
                            axisLine: { lineStyle: { color: '#fff' } }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: 'å ç”¨ç‡(%)',
                            min: 0,
                            max: 100,
                            axisLabel: { color: '#fff' },
                            axisLine: { lineStyle: { color: '#fff' } },
                            splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }
                        },
                        {
                            type: 'value',
                            name: 'åºŠä½æ•°',
                            axisLabel: { color: '#fff' },
                            axisLine: { lineStyle: { color: '#fff' } }
                        }
                    ],
                    series: [
                        {
                            name: 'å ç”¨ç‡',
                            type: 'line',
                            stack: 'Total',
                            smooth: true,
                            lineStyle: {
                                width: 3,
                                color: '#00d4ff'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [{
                                        offset: 0, color: 'rgba(0, 212, 255, 0.6)'
                                    }, {
                                        offset: 1, color: 'rgba(0, 212, 255, 0.1)'
                                    }]
                                }
                            },
                            data: data.occupancy_rates
                        },
                        {
                            name: 'å ç”¨åºŠä½æ•°',
                            type: 'line',
                            yAxisIndex: 1,
                            smooth: true,
                            lineStyle: {
                                width: 2,
                                color: '#ff6b6b'
                            },
                            data: data.occupied_counts
                        }
                    ]
                };
                
                charts.occupancyTrend.setOption(option);
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç©ºé—²åºŠä½æŸ±çŠ¶å›¾
        async function loadAvailableBeds() {
            try {
                const response = await fetch('/api/available_beds');
                const data = await response.json();
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '20%',
                        right: '10%',
                        top: '10%',
                        bottom: '10%'
                    },
                    xAxis: {
                        type: 'value',
                        boundaryGap: [0, 0.01],
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#fff' } },
                        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }
                    },
                    yAxis: {
                        type: 'category',
                        data: data.departments,
                        axisLabel: { color: '#fff' },
                        axisLine: { lineStyle: { color: '#fff' } }
                    },
                    series: [
                        {
                            name: 'ç©ºé—²åºŠä½',
                            type: 'bar',
                            data: data.available_counts.map((value, index) => ({
                                value: value,
                                itemStyle: {
                                    color: data.colors[index]
                                }
                            })),
                            label: {
                                show: true,
                                position: 'right',
                                color: '#fff',
                                fontSize: 12,
                                formatter: '{c}å¼ '
                            }
                        }
                    ]
                };
                
                charts.availableBeds.setOption(option);
            } catch (error) {
                console.error('åŠ è½½ç©ºé—²åºŠä½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç—…åºŠåˆ†å¸ƒçƒ­åŠ›å›¾
        async function loadBedDistribution() {
            try {
                const response = await fetch('/api/bed_distribution');
                const data = await response.json();
                
                const option = {
                    tooltip: {
                        position: 'top',
                        formatter: function(params) {
                            return data.departments[params.data[0]] + '<br/>' +
                                   data.floors[params.data[1]] + '<br/>' +
                                   'å ç”¨ç‡: ' + params.data[2] + '%';
                        }
                    },
                    grid: {
                        height: '60%',
                        top: '10%'
                    },
                    xAxis: {
                        type: 'category',
                        data: data.departments,
                        splitArea: {
                            show: true
                        },
                        axisLabel: {
                            color: '#fff',
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'category',
                        data: data.floors,
                        splitArea: {
                            show: true
                        },
                        axisLabel: {
                            color: '#fff'
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: 100,
                        calculable: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: '5%',
                        textStyle: {
                            color: '#fff'
                        },
                        inRange: {
                            color: ['#2ed573', '#ffa502', '#ff4757']
                        }
                    },
                    series: [{
                        name: 'ç—…åºŠå ç”¨ç‡',
                        type: 'heatmap',
                        data: data.data,
                        label: {
                            show: true,
                            color: '#fff',
                            fontSize: 10,
                            formatter: '{c}%'
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }]
                };
                
                charts.bedDistribution.setOption(option);
            } catch (error) {
                console.error('åŠ è½½åˆ†å¸ƒçƒ­åŠ›å›¾æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åˆå§‹åŒ–ä»ªè¡¨æ¿æ•°æ®
        async function initDashboard() {
            try {
                console.log('æ­£åœ¨åˆå§‹åŒ–ä»ªè¡¨æ¿...');
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadKeyIndicators(),
                    loadDepartmentOccupancy(),
                    loadOccupancyTrend(),
                    loadAvailableBeds(),
                    loadBedDistribution()
                ]);
                
                // è®¾ç½®æ›´æ–°æ—¶é—´
                document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
                
                console.log('ä»ªè¡¨æ¿åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('ä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
        function resizeCharts() {
            Object.values(charts).forEach(chart => {
                chart.resize();
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            initCharts();
            initDashboard();
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å›¾è¡¨
            window.addEventListener('resize', resizeCharts);
        });
        
        // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯3åˆ†é’Ÿï¼‰
        setInterval(function() {
            initDashboard();
        }, 3 * 60 * 1000);
    </script>
</body>
</html>