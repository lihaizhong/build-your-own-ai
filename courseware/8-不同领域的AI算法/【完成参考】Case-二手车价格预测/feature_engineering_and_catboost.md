# feature_engineering_and_catboost.py 代码逻辑说明

本文件实现了二手车价格预测的特征工程与 CatBoost 建模流程，主要包括数据加载、特征工程、特征选择、模型训练、评估与预测等步骤。以下为详细逻辑说明：

---

## 1. 数据加载与预处理

- **load_data()**
  - 加载原始训练集和测试集（CSV 文件）。
  - 输出数据形状。

- **preprocess_data(train_data, test_data)**
  - 合并训练集和测试集，便于统一做特征工程。
  - 标记数据来源（train/test），保存 SaleID 和训练集价格 y。

---

## 2. 特征工程

- **create_time_features(data)**
  - 处理注册日期和创建日期，生成车辆年龄（天/年）、注册/创建年月日、是否新车、季节、每年行驶公里数、车龄分段等时间相关特征。

- **create_car_features(data)**
  - 对数值特征缺失值进行填充和标记。
  - 将 model 转为数值型。
  - 生成品牌与车型组合特征。
  - 计算车辆距当前年份的车龄。
  - 对部分数值特征做异常值处理。

- **create_statistical_features(data, train_idx)**
  - 仅用训练集数据，统计品牌的均价、中位数、标准差、样本数。
  - 合并统计特征到总数据。
  - 生成品牌均价相对全局均价的比例特征。

- **encode_categorical_features(data)**
  - 对主要类别特征（如 model、brand、bodyType 等）做缺失值填充和频率编码。
  - 转为字符串类型，便于 CatBoost 识别。

---

## 3. 特征选择与数据保存

- **feature_selection(data, categorical_cols)**
  - 删除无用列（如 regDate、creatDate、price、SaleID、name、offerType、seller、source）。
  - 确保所有分类特征被正确标记（如 age_segment、brand_model）。
  - 转换分类特征为 category 类型。

- **数据分离与保存**
  - 按 source 分离训练集和测试集。
  - 划分训练集和验证集。
  - 用 joblib 保存处理后的特征、标签、测试集 SaleID、分类特征列表。

---

## 4. CatBoost 模型训练与评估

- **train_catboost_model(X_train, X_val, y_train, y_val, cat_features)**
  - 构建 CatBoostRegressor，设置参数。
  - 用训练集训练模型，验证集做 early stopping。
  - 保存模型。

- **evaluate_model(model, X_val, y_val, cat_features)**
  - 用验证集评估模型，输出 RMSE、MAE、R2。
  - 绘制预测值与实际值对比图。

- **plot_feature_importance(model, X_train)**
  - 输出特征重要性排名，保存前 20 特征重要性图和 CSV。

---

## 5. 测试集预测与提交

- **predict_test_data(model, X_test, test_ids, cat_features)**
  - 用训练好的模型预测测试集。
  - 生成提交文件（SaleID, price），保存为 CSV。

---

## 6. 其他说明

- 代码中包含部分可视化、调试和特征探索的注释。
- 所有中文注释和输出均已检查，避免乱码。

---

## 7. 可进一步挖掘的重要特征工程建议

基于当前项目和数据集，除了已有的时间、车辆、统计和类别特征外，还可以考虑以下有价值的特征工程方向：

1. **交互特征与多维组合特征**
   - 品牌 × 车身类型、品牌 × 变速箱、车龄 × 行驶里程等交互项，捕捉变量间的非线性关系。
   - 车型 × 排量、燃油类型 × 变速箱等组合特征。

2. **价格相关的历史统计特征**
   - 同品牌/车型/车龄段的历史均价、中位数、最大/最小值、方差等。
   - 近似车辆（如同品牌、同车龄、同公里数）在训练集中的价格分布特征。

3. **地理位置与区域特征**
   - 如果有地理信息（如城市、地区），可引入区域经济水平、二手车市场活跃度等外部数据。
   - 区域内品牌/车型的流行度、均价等。

4. **车辆使用强度与保养相关特征**
   - 单位年限行驶里程（已实现），可进一步细分如"每月行驶里程"、"公里数/车龄分段"。
   - 是否有重大维修、事故记录（如有数据）。

5. **车辆配置与附加值特征**
   - 车辆配置（如天窗、导航、座椅加热等）可通过文本挖掘或外部数据补充。
   - 车辆颜色、内饰等影响溢价的细节特征。

6. **时间序列与市场波动特征**
   - 车辆挂牌时间与市场淡旺季（如春节、暑期等）关联。
   - 结合宏观经济、油价、政策等外部时序数据。

7. **异常检测与置信度特征**
   - 通过聚类或孤立森林等方法识别异常车辆，生成"异常分数"特征。
   - 预测价格与同类均价的偏离程度作为置信度参考。

8. **文本与图片特征（如有）**
   - 车辆描述文本的关键词提取、情感分析。
   - 车辆图片的外观评分、损伤检测等（需有图片数据）。

9. **特征选择与降维**
   - 利用模型特征重要性、相关性分析、PCA等方法筛选最有价值的特征，减少冗余。

---

**建议：**
- 针对业务理解和数据可用性，优先尝试交互特征、历史统计特征和区域特征。
- 持续关注模型特征重要性，动态调整特征工程策略。
- 若有外部数据（如市场行情、车辆配置库），可进一步丰富特征体系。

这些特征工程方向有助于提升模型表现和泛化能力，值得在二手车价格预测项目中深入探索。

---

本脚本实现了从原始数据到特征工程、模型训练、评估、预测和结果输出的完整流程，适合二手车价格预测等结构化数据回归任务的参考和复用。 