<!-- Generated by SpecStory -->

# 自动选择图表类型和数据筛选 (2025-06-18 08:41:49)

_**User**_

在 ExcSQLTool中的call中自动对提取到的数据df进行了可视化（柱状图）
但如果len(df)较大，需要自动采用折线图进行呈现。且横坐标可以做一些筛选，比如选取10个点
改写的代码，写入到 stock_query_assistant-2.py


---

_**Assistant**_

```diff
- 
+ import os
+ import asyncio
+ from typing import Optional
+ import dashscope
+ from qwen_agent.agents import Assistant
+ from qwen_agent.gui import WebUI
+ import pandas as pd
+ from sqlalchemy import create_engine
+ from qwen_agent.tools.base import BaseTool, register_tool
+ import matplotlib.pyplot as plt
+ import io
+ import base64
+ import time
+ import numpy as np
+ 
+ # 解决中文显示问题
+ plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'SimSun', 'Arial Unicode MS']  # 优先使用的中文字体
+ plt.rcParams['axes.unicode_minus'] = False  # 解决负号显示问题
+ 
+ # 配置 DashScope
+ # 如需使用大模型，可设置环境变量 DASHSCOPE_API_KEY
+ # dashscope.api_key = os.getenv('DASHSCOPE_API_KEY', '')
+ dashscope.timeout = 30  # 设置超时时间为 30 秒
+ 
+ # ====== 股票查询助手 system prompt 和函数描述 ======
+ system_prompt = """我是股票查询助手，以下是关于股票价格表相关的字段，我可能会编写对应的SQL，对数据进行查询
+ -- 股票价格表
+ CREATE TABLE stock_price (
+     ts_code VARCHAR(20),           -- 股票代码
+     trade_date VARCHAR(10),        -- 交易日期
+     open DECIMAL(10,2),            -- 开盘价
+     high DECIMAL(10,2),            -- 最高价
+     low DECIMAL(10,2),             -- 最低价
+     close DECIMAL(10,2),           -- 收盘价
+     pre_close DECIMAL(10,2),       -- 昨收价
+     change DECIMAL(10,2),          -- 涨跌额
+     pct_chg DECIMAL(6,2),          -- 涨跌幅(%)
+     vol BIGINT,                    -- 成交量（手）
+     amount DECIMAL(20,2),          -- 成交额（千元）
+     stock_name VARCHAR(40)         -- 股票名称
+ );
+ 我将回答用户关于股票价格相关的问题，并自动生成可视化图表。
+ """
+ 
+ functions_desc = [
+     {
+         "name": "exc_sql",
+         "description": "对于生成的SQL，进行SQL查询",
+         "parameters": {
+             "type": "object",
+             "properties": {
+                 "sql_input": {
+                     "type": "string",
+                     "description": "生成的SQL语句",
+                 }
+             },
+             "required": ["sql_input"],
+         },
+     },
+ ]
+ 
+ # ====== exc_sql 工具类实现 ======
+ @register_tool('exc_sql')
+ class ExcSQLTool(BaseTool):
+     """
+     SQL查询工具，执行传入的SQL语句并返回结果，并自动进行可视化。
+     """
+     description = '对于生成的SQL，进行SQL查询，并自动可视化'
+     parameters = [{
+         'name': 'sql_input',
+         'type': 'string',
+         'description': '生成的SQL语句',
+         'required': True
+     }]
+ 
+     def call(self, params: str, **kwargs) -> str:
+         import json
+         import matplotlib.pyplot as plt
+         import io, os, time
+         import numpy as np
+         args = json.loads(params)
+         sql_input = args['sql_input']
+         database = args.get('database', 'stock')
+         engine = create_engine(
+             f'mysql+mysqlconnector://student123:student321@rm-uf6z891lon6dxuqblqo.mysql.rds.aliyuncs.com:3306/{database}?charset=utf8mb4',
+             connect_args={'connect_timeout': 10}, pool_size=10, max_overflow=20
+         )
+         try:
+             df = pd.read_sql(sql_input, engine)
+             md = df.head(10).to_markdown(index=False)
+             # 自动创建目录
+             save_dir = os.path.join(os.path.dirname(__file__), 'image_show')
+             os.makedirs(save_dir, exist_ok=True)
+             filename = f'stock_bar_{int(time.time()*1000)}.png'
+             save_path = os.path.join(save_dir, filename)
+             # 判断数据量，选择合适的可视化方式
+             if len(df) > 20:
+                 # 数据量较大，采用折线图，并对横坐标采样
+                 generate_line_chart_png(df, save_path, max_xticks=10)
+             else:
+                 # 数据量较小，采用柱状图
+                 generate_chart_png(df, save_path)
+             img_path = os.path.join('image_show', filename)
+             img_md = f'![图表]({img_path})'
+             return f"{md}\n\n{img_md}"
+         except Exception as e:
+             return f"SQL执行或可视化出错: {str(e)}"
+ 
+ # ========== 通用柱状图可视化函数 ========== 
+ def generate_chart_png(df_sql, save_path):
+     """
+     通用柱状图可视化函数，适用于数据量较小的情况。
+     """
+     columns = df_sql.columns
+     x = np.arange(len(df_sql))
+     # 获取object类型
+     object_columns = df_sql.select_dtypes(include='O').columns.tolist()
+     if columns[0] in object_columns:
+         object_columns.remove(columns[0])
+     num_columns = df_sql.select_dtypes(exclude='O').columns.tolist()
+     if len(object_columns) > 0:
+         # 对数据进行透视，以便为每个股票和日期创建堆积柱状图
+         pivot_df = df_sql.pivot_table(index=columns[0], columns=object_columns, 
+                                       values=num_columns, 
+                                       fill_value=0)
+         # 绘制堆积柱状图
+         fig, ax = plt.subplots(figsize=(10, 6))
+         bottoms = None
+         for col in pivot_df.columns:
+             ax.bar(pivot_df.index, pivot_df[col], bottom=bottoms, label=str(col))
+             if bottoms is None:
+                 bottoms = pivot_df[col].copy()
+             else:
+                 bottoms += pivot_df[col]
+     else:
+         bottom = np.zeros(len(df_sql))
+         for column in columns[1:]:
+             plt.bar(x, df_sql[column], bottom=bottom, label=column)
+             bottom += df_sql[column]
+         plt.xticks(x, df_sql[columns[0]])
+     plt.legend()
+     plt.title("股票价格统计")
+     plt.xlabel(columns[0])
+     plt.ylabel("数值")
+     plt.xticks(rotation=45)
+     plt.tight_layout()
+     plt.savefig(save_path)
+     plt.close()
+ 
+ # ========== 折线图可视化函数 ========== 
+ def generate_line_chart_png(df_sql, save_path, max_xticks=10):
+     """
+     通用折线图可视化函数，适用于数据量较大的情况。横坐标自动采样。
+     参数：
+         df_sql: 查询结果的DataFrame
+         save_path: 图片保存路径
+         max_xticks: 横坐标最多显示的点数
+     """
+     columns = df_sql.columns
+     x = np.arange(len(df_sql))
+     # 横坐标采样索引
+     if len(df_sql) > max_xticks:
+         step = max(1, len(df_sql) // max_xticks)
+         sampled_idx = np.arange(0, len(df_sql), step)
+         # 保证最后一个点也显示
+         if sampled_idx[-1] != len(df_sql) - 1:
+             sampled_idx = np.append(sampled_idx, len(df_sql) - 1)
+     else:
+         sampled_idx = np.arange(len(df_sql))
+     # 绘制折线图
+     plt.figure(figsize=(10, 6))
+     for column in columns[1:]:
+         plt.plot(x, df_sql[column], label=column)
+     # 设置采样后的横坐标标签
+     plt.xticks(sampled_idx, df_sql[columns[0]].iloc[sampled_idx], rotation=45)
+     plt.legend()
+     plt.title("股票价格走势")
+     plt.xlabel(columns[0])
+     plt.ylabel("数值")
+     plt.tight_layout()
+     plt.savefig(save_path)
+     plt.close()
+ 
+ # ====== 初始化股票查询助手服务 ======
+ def init_agent_service():
+     """初始化股票查询助手服务"""
+     llm_cfg = {
+         'model': 'qwen-turbo-2025-04-28',
+         'timeout': 30,
+         'retry_count': 3,
+     }
+     try:
+         bot = Assistant(
+             llm=llm_cfg,
+             name='股票查询助手',
+             description='股票价格查询与分析',
+             system_message=system_prompt,
+             function_list=['exc_sql'],
+         )
+         print("助手初始化成功！")
+         return bot
+     except Exception as e:
+         print(f"助手初始化失败: {str(e)}")
+         raise
+ 
+ def app_gui():
+     """图形界面模式，提供 Web 图形界面"""
+     try:
+         print("正在启动 Web 界面...")
+         # 初始化助手
+         bot = init_agent_service()
+         # 配置聊天界面，列举3个典型股票查询问题
+         chatbot_config = {
+             'prompt.suggestions': [
+                 '查询2024年全年贵州茅台的收盘价走势',
+                 '统计2024年4月国泰君安的日均成交量',
+                 '对比2024年中芯国际和贵州茅台的涨跌幅',
+             ]
+         }
+         print("Web 界面准备就绪，正在启动服务...")
+         # 启动 Web 界面
+         WebUI(
+             bot,
+             chatbot_config=chatbot_config
+         ).run()
+     except Exception as e:
+         print(f"启动 Web 界面失败: {str(e)}")
+         print("请检查网络连接和 API Key 配置")
+ 
+ if __name__ == '__main__':
+     app_gui() 
```

---

已完成改写，核心改动如下：

- 在 `ExcSQLTool.call` 方法中，自动判断查询结果 `df` 的长度：
  - 若数据量大于 20，则调用 `generate_line_chart_png` 生成折线图，并对横坐标采样（最多显示 10 个点）。
  - 否则，仍采用原有的柱状图逻辑。
- 新增 `generate_line_chart_png` 函数，专门用于大数据量的折线图可视化，并自动采样横坐标。
- 保留了原有的 `generate_chart_png` 柱状图逻辑，未影响小数据量的可视化效果。
- 所有新增注释均为中文，且已检查无中文乱码。

你可以在 `stock_query_assistant-2.py` 中查看和使用新逻辑。若需进一步自定义采样点数或图表样式，可继续告知！

---

