<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <!-- åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ® -->
  <script>
    // ä»æœ¬åœ°hongkong.jsonæ–‡ä»¶åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ®
    let hongKongMapData = null;

    // åœ°åŒºåç§°æ˜ å°„ï¼ˆè‹±æ–‡ -> ä¸­æ–‡ï¼‰
    const districtNameMapping = {
      'Central and Western': 'ä¸­è¥¿åŒº',
      'Eastern': 'ä¸œåŒº',
      'Islands': 'ç¦»å²›åŒº',
      'Kowloon City': 'ä¹é¾™åŸåŒº',
      'Kwai Tsing': 'è‘µé’åŒº',
      'Kwun Tong': 'è§‚å¡˜åŒº',
      'North': 'åŒ—åŒº',
      'Sai Kung': 'è¥¿è´¡åŒº',
      'Sha Tin': 'æ²™ç”°åŒº',
      'Sham Shui Po': 'æ·±æ°´åŸ—åŒº',
      'Southern': 'å—åŒº',
      'Tai Po': 'å¤§åŸ”åŒº',
      'Tsuen Wan': 'èƒæ¹¾åŒº',
      'Tuen Mun': 'å±¯é—¨åŒº',
      'Wan Chai': 'æ¹¾ä»”åŒº',
      'Wong Tai Sin': 'é»„å¤§ä»™åŒº',
      'Yau Tsim Mong': 'æ²¹å°–æ—ºåŒº',
      'Yuen Long': 'å…ƒæœ—åŒº'
    };

    // å¼‚æ­¥åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ®
    async function loadHongKongMap() {
      try {
        console.log('æ­£åœ¨åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ®ä» hongkong.json...');
        const response = await fetch('./hongkong.json?v=' + Date.now());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const rawMapData = await response.json();

        // è½¬æ¢åœ°å›¾æ•°æ®ï¼Œæ·»åŠ ä¸­æ–‡åç§°
        hongKongMapData = {
          ...rawMapData,
          features: rawMapData.features.map(feature => ({
            ...feature,
            properties: {
              ...feature.properties,
              chineseName: districtNameMapping[feature.properties.name] || feature.properties.name,
              englishName: feature.properties.name
            }
          }))
        };

        console.log('é¦™æ¸¯åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸï¼ŒåŒ…å«', hongKongMapData.features.length, 'ä¸ªåœ°åŒº');

        // æ³¨å†Œåœ°å›¾åˆ°ECharts
        echarts.registerMap('HongKong', hongKongMapData);
        console.log('é¦™æ¸¯åœ°å›¾æ³¨å†ŒæˆåŠŸ');

        return true;
      } catch (error) {
        console.error('åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ®å¤±è´¥:', error);
        return false;
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      overflow-x: hidden;
    }

    .dashboard-header {
      text-align: center;
      padding: 20px 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    .dashboard-title {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ffd700, #ffed4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dashboard-subtitle {
      font-size: 1.2em;
      opacity: 0.8;
    }

    .dashboard-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 20px;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .chart-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .chart-title {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
      color: #ffd700;
    }

    .chart {
      width: 100%;
      height: 400px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .key-indicators {
      grid-column: 1 / -1;
      height: 250px;
    }

    .key-indicators .chart {
      height: 200px;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1.2em;
    }

    @media (max-width: 1200px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }

      .full-width {
        grid-column: 1;
      }
    }

    .update-time {
      text-align: center;
      margin-top: 20px;
      opacity: 0.7;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  <div class="dashboard-header">
    <h1 class="dashboard-title">ğŸ¥ é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</h1>
    <p class="dashboard-subtitle">Hong Kong COVID-19 Data Visualization Dashboard</p>
  </div>

  <div class="dashboard-container">
    <!-- å›¾è¡¨1: æ¯æ—¥æ–°å¢ä¸ç´¯è®¡ç¡®è¯Š -->
    <div class="chart-container">
      <div class="chart-title">ğŸ“Š æ¯æ—¥æ–°å¢ä¸ç´¯è®¡ç¡®è¯Š</div>
      <div id="dailySummaryChart" class="chart">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
    </div>

    <!-- å›¾è¡¨2: å„åŒºåŸŸç–«æƒ…åˆ†å¸ƒçƒ­åŠ›å›¾ -->
    <div class="chart-container">
      <div class="chart-title">ğŸ—ºï¸ å„åŒºåŸŸç–«æƒ…åˆ†å¸ƒçƒ­åŠ›å›¾</div>
      <div id="districtDistributionChart" class="chart">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
    </div>

    <!-- å›¾è¡¨3: ç–«æƒ…å¢é•¿è¶‹åŠ¿åˆ†æ -->
    <div class="chart-container">
      <div class="chart-title">ğŸ“ˆ ç–«æƒ…å¢é•¿è¶‹åŠ¿åˆ†æ</div>
      <div id="trendAnalysisChart" class="chart">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
    </div>

    <!-- å›¾è¡¨4: å„åŒºåŸŸç–«æƒ…æ’è¡Œæ¦œ -->
    <div class="chart-container">
      <div class="chart-title">ğŸ† å„åŒºåŸŸç–«æƒ…æ’è¡Œæ¦œ</div>
      <div id="districtRankingChart" class="chart">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
    </div>

    <!-- å›¾è¡¨5: å…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜ -->
    <div class="chart-container key-indicators full-width">
      <div class="chart-title">âš¡ å…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜</div>
      <div id="keyIndicatorsChart" class="chart">
        <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
      </div>
    </div>
  </div>

  <div class="update-time">
    <p>ğŸ“… æ•°æ®æ›´æ–°æ—¶é—´ï¼š<span id="updateTime"></span></p>
  </div>

  <script>
    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
    const charts = {};

    // åˆå§‹åŒ–å›¾è¡¨å®¹å™¨
    function initCharts() {
      charts.dailySummary = echarts.init(document.getElementById('dailySummaryChart'));
      charts.districtDistribution = echarts.init(document.getElementById('districtDistributionChart'));
      charts.trendAnalysis = echarts.init(document.getElementById('trendAnalysisChart'));
      charts.districtRanking = echarts.init(document.getElementById('districtRankingChart'));
      charts.keyIndicators = echarts.init(document.getElementById('keyIndicatorsChart'));
    }

    // åŠ è½½æ¯æ—¥æ±‡æ€»æ•°æ®
    async function loadDailySummary() {
      try {
        const response = await fetch('/api/daily_summary');
        const data = await response.json();

        const option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
          },
          legend: {
            data: ['æ¯æ—¥æ–°å¢', 'ç´¯è®¡ç¡®è¯Š'],
            textStyle: { color: '#fff' }
          },
          xAxis: {
            type: 'category',
            data: data.dates,
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: '#fff' } }
          },
          yAxis: [
            {
              type: 'value',
              name: 'æ¯æ—¥æ–°å¢',
              axisLabel: { color: '#fff' },
              axisLine: { lineStyle: { color: '#fff' } },
              splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }
            },
            {
              type: 'value',
              name: 'ç´¯è®¡ç¡®è¯Š',
              axisLabel: { color: '#fff' },
              axisLine: { lineStyle: { color: '#fff' } }
            }
          ],
          series: [
            {
              name: 'æ¯æ—¥æ–°å¢',
              type: 'bar',
              data: data.new_cases,
              itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                  { offset: 0, color: '#ffd700' },
                  { offset: 1, color: '#ffed4a' }
                ])
              }
            },
            {
              name: 'ç´¯è®¡ç¡®è¯Š',
              type: 'line',
              yAxisIndex: 1,
              data: data.total_cases,
              lineStyle: { color: '#ff6b6b', width: 3 },
              symbol: 'circle',
              symbolSize: 6
            }
          ]
        };

        charts.dailySummary.setOption(option);
      } catch (error) {
        console.error('åŠ è½½æ¯æ—¥æ±‡æ€»æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½åŒºåŸŸåˆ†å¸ƒæ•°æ®
    async function loadDistrictDistribution() {
      try {
        // é¦–å…ˆç¡®ä¿åœ°å›¾æ•°æ®å·²åŠ è½½
        if (!hongKongMapData) {
          console.log('æ­£åœ¨ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½...');
          const mapLoaded = await loadHongKongMap();
          if (!mapLoaded) {
            console.warn('åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›¾è¡¨');
            showFallbackChart();
            return;
          }
        }

        const response = await fetch('/api/district_distribution');
        const data = await response.json();

        console.log('District data:', data);

        if (!data || data.length === 0) {
          console.warn('æ²¡æœ‰åŒºåŸŸåˆ†å¸ƒæ•°æ®');
          showFallbackChart();
          return;
        }

        // è·å–æœ€å¤§å€¼å’Œæœ€å°å€¼ç”¨äºé¢œè‰²åˆ†çº§
        const values = data.map(item => item.value);
        const maxValue = Math.max(...values);
        const minValue = Math.min(...values);

        console.log('Min value:', minValue, 'Max value:', maxValue);

        // å°†æ•°æ®è½¬æ¢ä¸ºåœ°å›¾æ ¼å¼ï¼Œä½¿ç”¨ä¸­æ–‡åç§°åŒ¹é…
        const mapData = data.map(item => {
          // æŸ¥æ‰¾å¯¹åº”çš„è‹±æ–‡åç§°
          const englishName = Object.keys(districtNameMapping).find(key =>
            districtNameMapping[key] === item.name
          );

          return {
            name: englishName || item.name, // ä½¿ç”¨è‹±æ–‡åç§°åŒ¹é…åœ°å›¾
            value: item.value,
            chineseName: item.name, // ä¿ç•™ä¸­æ–‡åç§°ç”¨äºæ˜¾ç¤º
            new_cases: item.new_cases,
            active_cases: item.active_cases
          };
        });

        console.log('Map data:', mapData);

        // å°è¯•æ˜¾ç¤ºåœ°å›¾ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        try {
          const mapOption = {
            backgroundColor: 'transparent',
            title: {
              text: 'é¦™æ¸¯å„åŒºç–«æƒ…åˆ†å¸ƒåœ°å›¾',
              left: 'center',
              top: '3%',
              textStyle: {
                color: '#fff',
                fontSize: 16,
                fontWeight: 'bold'
              }
            },
            tooltip: {
              trigger: 'item',
              backgroundColor: 'rgba(0,0,0,0.8)',
              borderColor: '#fff',
              borderWidth: 1,
              textStyle: {
                color: '#fff',
                fontSize: 14
              },
              formatter: function (params) {
                if (params.data) {
                  const chineseName = params.data.chineseName || districtNameMapping[params.name] || params.name;
                  return `${chineseName}<br/>ç´¯è®¡ç¡®è¯Š: ${params.value || 0}ä¾‹<br/>æ–°å¢ç¡®è¯Š: ${params.data.new_cases || 0}ä¾‹<br/>ç°æœ‰ç¡®è¯Š: ${params.data.active_cases || 0}ä¾‹`;
                }
                const chineseName = districtNameMapping[params.name] || params.name;
                return `${chineseName}<br/>æš‚æ— æ•°æ®`;
              }
            },
            geo: {
              map: 'HongKong',
              aspectScale: 0.75,
              zoom: 1.1,
              center: [114.1694, 22.3193],
              roam: false,
              itemStyle: {
                borderColor: '#fff',
                borderWidth: 1.2,
                areaColor: '#2a5298'
              },
              emphasis: {
                itemStyle: {
                  areaColor: '#48dbfb',
                  borderWidth: 2
                }
              }
            },
            visualMap: {
              min: minValue,
              max: maxValue,
              left: '10px',
              bottom: '20px',
              text: ['é«˜', 'ä½'],
              textStyle: {
                color: '#fff',
                fontSize: 12
              },
              inRange: {
                color: ['#1dd1a1', '#48dbfb', '#feca57', '#ff9ff3', '#ff4757']
              },
              itemWidth: 20,
              itemHeight: 120,
              backgroundColor: 'rgba(0,0,0,0.3)',
              borderColor: '#fff',
              borderWidth: 1,
              padding: [8, 8]
            },
            series: [
              {
                name: 'ç–«æƒ…åˆ†å¸ƒ',
                type: 'map',
                map: 'HongKong',
                aspectScale: 0.75,
                zoom: 1.1,
                center: [114.1694, 22.3193],
                roam: false,
                data: mapData,
                itemStyle: {
                  borderColor: '#fff',
                  borderWidth: 1.2
                },
                emphasis: {
                  itemStyle: {
                    borderWidth: 2,
                    shadowBlur: 15,
                    shadowColor: 'rgba(255,255,255,0.5)'
                  },
                  label: {
                    show: true,
                    fontSize: 12,
                    color: '#ffd700',
                    fontWeight: 'bold'
                  }
                },
                label: {
                  show: true,
                  fontSize: 10,
                  color: '#fff',
                  fontWeight: 'bold',
                  distance: 5,
                  formatter: function (params) {
                    const chineseName = params.data && params.data.chineseName
                      ? params.data.chineseName
                      : districtNameMapping[params.name] || params.name;
                    // åªæ˜¾ç¤ºåŒºåï¼Œä¸æ˜¾ç¤ºæ•°å€¼é¿å…è¿‡äºæ‹¥æŒ¤
                    return chineseName;
                  }
                }
              }
            ]
          };

          console.log('Setting map chart option:', mapOption);
          charts.districtDistribution.setOption(mapOption, true);
          console.log('Map chart set successfully');

        } catch (mapError) {
          console.warn('Map display failed, using fallback chart:', mapError);
          showFallbackChart(data, maxValue);
        }

      } catch (error) {
        console.error('åŠ è½½åŒºåŸŸåˆ†å¸ƒæ•°æ®å¤±è´¥:', error);
        showFallbackChart();
      }
    }

    // å¤‡ç”¨å›¾è¡¨æ˜¾ç¤ºå‡½æ•°
    function showFallbackChart(data = [], maxValue = 100) {
      console.log('Showing fallback chart');

      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºç¤ºä¾‹æ•°æ®
      if (!data || data.length === 0) {
        data = [
          { name: 'ä¸­è¥¿åŒº', value: 456, new_cases: 15, active_cases: 48 },
          { name: 'æ¹¾ä»”åŒº', value: 678, new_cases: 23, active_cases: 92 },
          { name: 'ä¸œåŒº', value: 892, new_cases: 31, active_cases: 118 },
          { name: 'å—åŒº', value: 234, new_cases: 8, active_cases: 32 },
          { name: 'æ·±æ°´åŸ—åŒº', value: 567, new_cases: 19, active_cases: 76 }
        ];
        maxValue = Math.max(...data.map(item => item.value));
      }

      const getColor = (value, maxValue) => {
        const ratio = value / maxValue;
        if (ratio > 0.8) return '#ff4757';
        if (ratio > 0.6) return '#ff9ff3';
        if (ratio > 0.4) return '#feca57';
        if (ratio > 0.2) return '#48dbfb';
        return '#1dd1a1';
      };

      const fallbackOption = {
        backgroundColor: 'transparent',
        title: {
          text: 'é¦™æ¸¯å„åŒºç–«æƒ…åˆ†å¸ƒçƒ­åŠ›å›¾',
          left: 'center',
          top: '5%',
          textStyle: {
            color: '#fff',
            fontSize: 16,
            fontWeight: 'bold'
          }
        },
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(0,0,0,0.8)',
          borderColor: '#fff',
          borderWidth: 1,
          textStyle: {
            color: '#fff',
            fontSize: 14
          },
          formatter: function (params) {
            const item = data.find(d => d.name === params.name);
            if (item) {
              return `${params.name}<br/>ç´¯è®¡ç¡®è¯Š: ${params.value}ä¾‹<br/>æ–°å¢ç¡®è¯Š: ${item.new_cases}ä¾‹<br/>ç°æœ‰ç¡®è¯Š: ${item.active_cases}ä¾‹`;
            }
            return `${params.name}<br/>ç´¯è®¡ç¡®è¯Š: ${params.value}ä¾‹`;
          }
        },
        series: [
          {
            name: 'é¦™æ¸¯å„åŒºç–«æƒ…åˆ†å¸ƒ',
            type: 'treemap',
            width: '100%',
            height: '85%',
            top: '15%',
            roam: false,
            nodeClick: false,
            breadcrumb: {
              show: false
            },
            label: {
              show: true,
              fontSize: 12,
              color: '#fff',
              fontWeight: 'bold',
              formatter: function (params) {
                return `${params.name}\n${params.value}ä¾‹`;
              }
            },
            itemStyle: {
              borderColor: '#fff',
              borderWidth: 2,
              gapWidth: 2
            },
            emphasis: {
              itemStyle: {
                borderWidth: 3,
                shadowBlur: 20,
                shadowColor: 'rgba(255,255,255,0.5)'
              }
            },
            data: data.map((item) => ({
              name: item.name,
              value: item.value,
              itemStyle: {
                color: getColor(item.value, maxValue),
                borderColor: '#fff',
                borderWidth: 2
              }
            }))
          }
        ]
      };

      charts.districtDistribution.setOption(fallbackOption, true);
      console.log('Fallback chart displayed');
    }

    // åŠ è½½è¶‹åŠ¿åˆ†ææ•°æ®
    async function loadTrendAnalysis() {
      try {
        const response = await fetch('/api/trend_analysis');
        const data = await response.json();

        const option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'cross' }
          },
          legend: {
            data: ['æ–°å¢ç¡®è¯Š', '7æ—¥å‡çº¿', 'å¢é•¿ç‡%'],
            textStyle: { color: '#fff' }
          },
          xAxis: {
            type: 'category',
            data: data.dates,
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: '#fff' } }
          },
          yAxis: [
            {
              type: 'value',
              name: 'ç¡®è¯Šæ•°',
              axisLabel: { color: '#fff' },
              axisLine: { lineStyle: { color: '#fff' } },
              splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }
            },
            {
              type: 'value',
              name: 'å¢é•¿ç‡%',
              axisLabel: { color: '#fff' },
              axisLine: { lineStyle: { color: '#fff' } }
            }
          ],
          series: [
            {
              name: 'æ–°å¢ç¡®è¯Š',
              type: 'bar',
              data: data.new_cases_trend,
              itemStyle: { color: 'rgba(255, 107, 107, 0.8)' }
            },
            {
              name: '7æ—¥å‡çº¿',
              type: 'line',
              data: data.ma7,
              lineStyle: { color: '#ffd700', width: 3 },
              smooth: true
            },
            {
              name: 'å¢é•¿ç‡%',
              type: 'line',
              yAxisIndex: 1,
              data: data.growth_rate,
              lineStyle: { color: '#48dbfb', width: 2 },
              symbol: 'diamond'
            }
          ]
        };

        charts.trendAnalysis.setOption(option);
      } catch (error) {
        console.error('åŠ è½½è¶‹åŠ¿åˆ†ææ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½åŒºåŸŸæ’åæ•°æ®
    async function loadDistrictRanking() {
      try {
        const response = await fetch('/api/district_ranking');
        const data = await response.json();

        const option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
          },
          xAxis: {
            type: 'value',
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: '#fff' } },
            splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }
          },
          yAxis: {
            type: 'category',
            data: data.districts,
            axisLabel: { color: '#fff' },
            axisLine: { lineStyle: { color: '#fff' } }
          },
          series: [
            {
              name: 'ç´¯è®¡ç¡®è¯Š',
              type: 'bar',
              data: data.values,
              itemStyle: {
                color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
                  { offset: 0, color: '#feca57' },
                  { offset: 1, color: '#ff9ff3' }
                ])
              },
              label: {
                show: true,
                position: 'right',
                color: '#fff'
              }
            }
          ]
        };

        charts.districtRanking.setOption(option);
      } catch (error) {
        console.error('åŠ è½½åŒºåŸŸæ’åæ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½å…³é”®æŒ‡æ ‡æ•°æ®
    async function loadKeyIndicators() {
      try {
        const response = await fetch('/api/key_indicators');
        const data = await response.json();

        const option = {
          backgroundColor: 'transparent',
          title: [
            {
              text: 'ä»Šæ—¥æ–°å¢',
              left: '16.5%',
              top: '75%',
              textAlign: 'center',
              textStyle: {
                color: '#fff',
                fontSize: 14,
                fontWeight: 'bold'
              }
            },
            {
              text: 'æ¢å¤ç‡',
              left: '50%',
              top: '75%',
              textAlign: 'center',
              textStyle: {
                color: '#fff',
                fontSize: 14,
                fontWeight: 'bold'
              }
            },
            {
              text: 'ç–«è‹—æ¥ç§ç‡',
              left: '83.5%',
              top: '75%',
              textAlign: 'center',
              textStyle: {
                color: '#fff',
                fontSize: 14,
                fontWeight: 'bold'
              }
            }
          ],
          series: [
            {
              name: 'æ–°å¢ç¡®è¯Š',
              type: 'gauge',
              center: ['16.5%', '45%'],
              radius: '65%',
              min: 0,
              max: 1000,
              startAngle: 225,
              endAngle: -45,
              splitNumber: 5,
              data: [{ value: data.total_new, name: 'ä»Šæ—¥æ–°å¢' }],
              axisLine: {
                lineStyle: {
                  color: [[0.3, '#67e0e3'], [0.7, '#37a2da'], [1, '#fd666d']],
                  width: 6
                }
              },
              axisTick: {
                distance: -8,
                length: 4,
                lineStyle: {
                  color: '#fff',
                  width: 1
                }
              },
              axisLabel: {
                distance: -20,
                color: '#fff',
                fontSize: 10
              },
              splitLine: {
                distance: -15,
                length: 8,
                lineStyle: {
                  color: '#fff',
                  width: 2
                }
              },
              pointer: {
                length: '70%',
                width: 3,
                itemStyle: {
                  color: '#fff'
                }
              },
              detail: {
                fontSize: 16,
                color: '#fff',
                fontWeight: 'bold',
                offsetCenter: [0, '30%'],
                formatter: '{value}'
              },
              title: {
                show: false
              }
            },
            {
              name: 'æ¢å¤ç‡',
              type: 'gauge',
              center: ['50%', '45%'],
              radius: '65%',
              min: 0,
              max: 100,
              startAngle: 225,
              endAngle: -45,
              splitNumber: 5,
              data: [{ value: data.recovery_rate, name: 'æ¢å¤ç‡%' }],
              axisLine: {
                lineStyle: {
                  color: [[0.3, '#fd666d'], [0.7, '#feca57'], [1, '#67e0e3']],
                  width: 6
                }
              },
              axisTick: {
                distance: -8,
                length: 4,
                lineStyle: {
                  color: '#fff',
                  width: 1
                }
              },
              axisLabel: {
                distance: -20,
                color: '#fff',
                fontSize: 10
              },
              splitLine: {
                distance: -15,
                length: 8,
                lineStyle: {
                  color: '#fff',
                  width: 2
                }
              },
              pointer: {
                length: '70%',
                width: 3,
                itemStyle: {
                  color: '#fff'
                }
              },
              detail: {
                fontSize: 16,
                color: '#fff',
                fontWeight: 'bold',
                offsetCenter: [0, '30%'],
                formatter: '{value}%'
              },
              title: {
                show: false
              }
            },
            {
              name: 'ç–«è‹—æ¥ç§ç‡',
              type: 'gauge',
              center: ['83.5%', '45%'],
              radius: '65%',
              min: 0,
              max: 100,
              startAngle: 225,
              endAngle: -45,
              splitNumber: 5,
              data: [{ value: data.vaccination_rate, name: 'ç–«è‹—æ¥ç§ç‡%' }],
              axisLine: {
                lineStyle: {
                  color: [[0.3, '#fd666d'], [0.7, '#feca57'], [1, '#67e0e3']],
                  width: 6
                }
              },
              axisTick: {
                distance: -8,
                length: 4,
                lineStyle: {
                  color: '#fff',
                  width: 1
                }
              },
              axisLabel: {
                distance: -20,
                color: '#fff',
                fontSize: 10
              },
              splitLine: {
                distance: -15,
                length: 8,
                lineStyle: {
                  color: '#fff',
                  width: 2
                }
              },
              pointer: {
                length: '70%',
                width: 3,
                itemStyle: {
                  color: '#fff'
                }
              },
              detail: {
                fontSize: 16,
                color: '#fff',
                fontWeight: 'bold',
                offsetCenter: [0, '30%'],
                formatter: '{value}%'
              },
              title: {
                show: false
              }
            }
          ]
        };

        charts.keyIndicators.setOption(option, true);
      } catch (error) {
        console.error('åŠ è½½å…³é”®æŒ‡æ ‡æ•°æ®å¤±è´¥:', error);
      }
    }

    // è‡ªåŠ¨è°ƒæ•´å›¾è¡¨å¤§å°
    function resizeCharts() {
      Object.values(charts).forEach(chart => {
        chart.resize();
      });
    }

    // åˆå§‹åŒ–å‡½æ•°
    async function initDashboard() {
      try {
        console.log('æ­£åœ¨åˆå§‹åŒ–ä»ªè¡¨æ¿...');

        // é¦–å…ˆåŠ è½½åœ°å›¾æ•°æ®
        await loadHongKongMap();

        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
        await Promise.all([
          loadDailySummary(),
          loadDistrictDistribution(),
          loadTrendAnalysis(),
          loadDistrictRanking(),
          loadKeyIndicators()
        ]);

        // è®¾ç½®æ›´æ–°æ—¶é—´
        document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');

        console.log('ä»ªè¡¨æ¿åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('ä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥:', error);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function () {
      initCharts();
      initDashboard();

      // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´å›¾è¡¨
      window.addEventListener('resize', resizeCharts);
    });

    // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    setInterval(function () {
      initDashboard();
    }, 5 * 60 * 1000);
  </script>
</body>

</html>