# 迪士尼RAG问答助手 - 技术架构

## 架构概览

迪士尼RAG问答助手采用**四层架构设计**，每一层职责明确、相互独立，便于维护和扩展。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                │
│                    (CLI / 交互式问答)                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Step4: 生成层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │PromptBuilder │→ │AnswerGenerator│→ │ RAGPipeline  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Step3: 检索层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │TextRetriever │  │ImageRetriever│  │HybridRetriever│          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Step2: 向量化层                              │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │  TextEmbeddingModel  │  │ ImageEmbeddingModel  │            │
│  │   (1024维向量)        │  │    (512维向量)       │            │
│  └──────────────────────┘  └──────────────────────┘            │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │    FAISS文本索引      │  │    FAISS图像索引     │            │
│  └──────────────────────┘  └──────────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Step1: 数据层                                │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │  DocumentProcessor   │  │   ImageProcessor     │            │
│  │  (Word/文本处理)      │  │    (OCR识别)         │            │
│  └──────────────────────┘  └──────────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step1: 数据层

### 架构设计

数据层负责从原始数据源提取和处理信息，是整个RAG系统的基础。

```python
# 数据层核心组件
┌─────────────────────────────────────────────────────────┐
│                    数据处理层                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐        ┌─────────────────┐        │
│  │DocumentProcessor│        │ ImageProcessor  │        │
│  │                 │        │                 │        │
│  │ - process_file()│        │ - process_image()│       │
│  │ - _process_docx │        │ - OCR识别       │        │
│  │ - _process_text │        │ - 图像提取      │        │
│  └────────┬────────┘        └────────┬────────┘        │
│           │                          │                  │
│           ▼                          ▼                  │
│  ┌─────────────────┐        ┌─────────────────┐        │
│  │   TextChunk     │        │   ImageData     │        │
│  │   文本块数据     │        │   图像数据      │        │
│  └─────────────────┘        └─────────────────┘        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 文档处理器 (DocumentProcessor)

#### 核心功能

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| 文档解析 | 支持多种文档格式 | python-docx, 内置IO |
| 文本分块 | 保持语义完整性 | 自定义分块算法 |
| 表格提取 | 转换为Markdown | 遍历docx表格元素 |
| 元数据管理 | 文件哈希、来源追踪 | 文件hash + 时间戳 |

#### 文本块数据结构

```python
@dataclass
class TextChunk:
    """文本块数据类"""
    text: str                    # 文本内容
    source: str                  # 来源文件路径
    page: Optional[int] = None   # 页码/段落编号
    chunk_id: Optional[str]      # 唯一标识
    metadata: Dict[str, Any]     # 元数据
```

### 图像处理器 (ImageProcessor)

#### 核心功能

| 功能 | 说明 | 实现方式 |
|------|------|----------|
| 图像加载 | 支持多种图像格式 | Pillow |
| OCR识别 | 提取图像中的文字 | Tesseract |
| 元数据提取 | 文件大小、哈希等 | os.path, hashlib |

#### 图像数据结构

```python
@dataclass
class ImageData:
    """图像数据类"""
    image_path: Path             # 图像路径
    ocr_text: str = ""           # OCR识别文本
    embedding: List[float]       # 图像向量
    metadata: Dict[str, Any]     # 元数据
```

---

## Step2: 向量化层

### 架构设计

向量化层将文本和图像转换为向量表示，是检索的核心。

```python
# 向量化层架构
┌─────────────────────────────────────────────────────────┐
│                      向量化层                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │              TextEmbeddingModel                   │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  模型: text-embedding-v4 (阿里云百炼)             │  │
│  │  维度: 1024                                       │  │
│  │  方法: embed_text(), embed_texts()               │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │              ImageEmbeddingModel                  │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  模型: CLIP ViT-B/32 (OpenAI)                    │  │
│  │  维度: 512                                        │  │
│  │  方法: embed_image(), embed_text_for_image_search()│ │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │                  VectorStore                      │  │
│  ├──────────────────────────────────────────────────┤  │
│  │  - build_text_index()  构建文本索引              │  │
│  │  - build_image_index() 构建图像索引              │  │
│  │  - save_indexes()      保存索引                  │  │
│  │  - load_indexes()      加载索引                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 文本Embedding模型

#### 技术选型

| 属性 | 值 | 说明 |
|------|-----|------|
| 服务商 | 阿里云百炼 | 国内访问稳定 |
| 模型 | text-embedding-v4 | 最新版本 |
| 向量维度 | 1024 | 高精度表示 |
| 最大长度 | 8192 tokens | 支持长文本 |

#### 工作流程

```
文本输入 → API调用 → 向量返回 → 归一化 → 存储到FAISS
```

### 图像Embedding模型 (CLIP)

#### 技术选型

| 属性 | 值 | 说明 |
|------|-----|------|
| 模型 | CLIP ViT-B/32 | OpenAI开源 |
| 向量维度 | 512 | 视觉特征 |
| 本地运行 | 是 | 无需API调用 |
| 跨模态 | 支持 | 文本→图像检索 |

#### CLIP模型特点

```
┌─────────────────────────────────────────────────────┐
│                    CLIP模型                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌───────────────┐      ┌───────────────┐          │
│  │   图像编码器   │      │   文本编码器   │          │
│  │  (Vision      │      │  (Text        │          │
│  │  Transformer) │      │  Transformer) │          │
│  └───────┬───────┘      └───────┬───────┘          │
│          │                      │                   │
│          ▼                      ▼                   │
│  ┌───────────────────────────────────────┐         │
│  │           共享向量空间 (512维)          │         │
│  │   图像和文本在同一空间中进行相似度计算   │         │
│  └───────────────────────────────────────┘         │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### FAISS索引系统

#### 索引类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| IndexFlatL2 | 暴力搜索，精确结果 | 小规模数据 (< 100万) |
| IndexFlatIP | 内积相似度 | 归一化向量 |
| IndexIVFFlat | 聚类加速 | 大规模数据 |

#### 双索引设计

```python
# 文本索引
text_index = FAISSIndex(
    embedding_dim=1024,
    index_type="IndexFlatL2"
)

# 图像索引
image_index = FAISSIndex(
    embedding_dim=512,
    index_type="IndexFlatL2"
)
```

#### 索引文件结构

```
user_data/indexes/
├── text_index.faiss      # 文本向量索引
├── text_documents.pkl    # 文本文档元数据
├── image_index.faiss     # 图像向量索引
└── image_documents.pkl   # 图像元数据
```

---

## Step3: 检索层

### 架构设计

检索层负责从向量索引中检索相关内容，支持文本、图像和混合检索。

```python
# 检索层架构
┌─────────────────────────────────────────────────────────┐
│                       检索层                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │               HybridRetriever                    │   │
│  │  ┌─────────────────────────────────────────┐    │   │
│  │  │          _should_trigger_image_search()  │    │   │
│  │  │         关键词检测 → 触发图像检索         │    │   │
│  │  └─────────────────────────────────────────┘    │   │
│  │              │                    │              │   │
│  │              ▼                    ▼              │   │
│  │  ┌─────────────────┐  ┌─────────────────┐       │   │
│  │  │ TextRetriever   │  │ ImageRetriever  │       │   │
│  │  │                 │  │                 │       │   │
│  │  │ - retrieve()    │  │ - retrieve_by_text()    │ │
│  │  │ - 文本向量检索  │  │ - retrieve_by_image()   │ │
│  │  └────────┬────────┘  └────────┬────────┘       │   │
│  │           │                    │                 │   │
│  │           └──────────┬─────────┘                 │   │
│  │                      ▼                           │   │
│  │           ┌─────────────────────┐                │   │
│  │           │  RetrievalResult    │                │   │
│  │           │  检索结果数据类      │                │   │
│  │           └─────────────────────┘                │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 文本检索器 (TextRetriever)

#### 检索流程

```
用户查询 → 文本Embedding → FAISS搜索 → 相似度计算 → 结果过滤
```

#### 相似度计算

```python
# L2距离转相似度
similarity = 1.0 / (1.0 + distance)

# 其中 distance 是 L2 距离，越小越相似
# similarity 范围: (0, 1]，越大越相似
```

### 图像检索器 (ImageRetriever)

#### 跨模态检索

```
┌──────────────────────────────────────────────────────┐
│                 图像检索流程                          │
├──────────────────────────────────────────────────────┤
│                                                      │
│  用户查询: "展示一下迪士尼的海报"                     │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────┐                                 │
│  │ CLIP文本编码器   │                                 │
│  │ (与图像共享空间) │                                 │
│  └────────┬────────┘                                 │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────┐                                 │
│  │  512维文本向量   │                                 │
│  └────────┬────────┘                                 │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────┐                                 │
│  │ FAISS图像索引搜索│                                 │
│  └────────┬────────┘                                 │
│           │                                          │
│           ▼                                          │
│  ┌─────────────────┐                                 │
│  │   相似图像列表   │                                 │
│  │  (海报图片)      │                                 │
│  └─────────────────┘                                 │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### 混合检索器 (HybridRetriever)

#### 关键词触发机制

```python
# 默认触发关键词
image_keywords = [
    "海报", "图片", "图像", 
    "照片", "截图", "展示"
]

# 检测逻辑
def _should_trigger_image_search(self, query: str) -> bool:
    for keyword in self.image_keywords:
        if keyword.lower() in query.lower():
            return True
    return False
```

#### 检索结果合并

```python
# 混合检索返回结构
{
    "text": [
        RetrievalResult(content="...", source="...", score=0.85),
        # ... 更多文本结果
    ],
    "image": [
        RetrievalResult(content="...", source="...", score=0.82),
        # ... 更多图像结果
    ]
}
```

---

## Step4: 生成层

### 架构设计

生成层负责组织上下文并调用LLM生成答案。

```python
# 生成层架构
┌─────────────────────────────────────────────────────────┐
│                       生成层                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                 RAGPipeline                      │   │
│  │  ┌───────────────────────────────────────────┐  │   │
│  │  │ 1. 检索: retriever.retrieve(query)        │  │   │
│  │  │ 2. 上下文: prompt_builder.build_context() │  │   │
│  │  │ 3. 生成: generator.generate()             │  │   │
│  │  └───────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐      │
│  │   PromptBuilder     │  │  AnswerGenerator    │      │
│  │                     │  │                     │      │
│  │ - build_context()   │  │ - generate()        │      │
│  │ - build_prompt()    │  │ - generate_stream() │      │
│  │ - 系统提示词构建    │  │ - LLM调用           │      │
│  └─────────────────────┘  └─────────────────────┘      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 提示词构建器 (PromptBuilder)

#### 系统提示词

```python
system_prompt = """你是一个专业的迪士尼知识问答助手，能够基于提供的文档和图像信息回答用户的问题。

你的职责：
1. 基于提供的上下文信息准确回答用户问题
2. 如果上下文中没有相关信息，明确说明你不知道
3. 回答要清晰、简洁、准确
4. 对于图像相关信息，可以描述图像内容
5. 保持专业和友好的态度
"""
```

#### 上下文组织

```python
def build_context(self, results: Dict[str, List[RetrievalResult]]) -> str:
    context_parts = []
    
    # 添加文本上下文
    if results.get("text"):
        context_parts.append("【相关文档信息】")
        for i, result in enumerate(results["text"], 1):
            context_parts.append(
                f"文档{i} (来源: {result.source}, 相似度: {result.score:.3f}):\n"
                f"{result.content}"
            )
    
    # 添加图像上下文
    if results.get("image"):
        context_parts.append("\n【相关图像信息】")
        for i, result in enumerate(results["image"], 1):
            context_parts.append(
                f"图像{i} (来源: {result.source}, 相似度: {result.score:.3f}):\n"
                f"{result.content}"
            )
    
    return "\n".join(context_parts)
```

### 答案生成器 (AnswerGenerator)

#### LLM配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| model | qwen-max | 通义千问模型 |
| temperature | 0.7 | 控制随机性 |
| max_tokens | 2000 | 最大输出长度 |

#### API调用

```python
# OpenAI兼容接口
client = OpenAI(
    api_key=self.api_key,
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

response = client.chat.completions.create(
    model=self.model,
    messages=[
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt}
    ],
    temperature=temperature,
    max_tokens=max_tokens
)
```

### RAG管道 (RAGPipeline)

#### 完整流程

```python
def query(self, question: str) -> Dict[str, Any]:
    # Step 1: 检索
    retrieval_results = self.retriever.retrieve(query=question)
    
    # Step 2: 构建上下文
    context = self.prompt_builder.build_context(retrieval_results)
    
    # Step 3: 生成答案
    answer = self.generator.generate(
        query=question,
        results=retrieval_results
    )
    
    return {
        "answer": answer,
        "context": context,
        "question": question
    }
```

---

## 技术栈详解

### 核心依赖

```toml
[project.dependencies]
# 框架
langchain = ">=1.2.9"
langchain-community = ">=0.1.0"
langchain-core = ">=0.1.0"

# 向量数据库
faiss-cpu = ">=1.13.2"

# 大模型API
dashscope = ">=1.25.11"
openai = ">=1.0.0"

# 视觉模型
transformers = ">=5.1.0"
torch = ">=2.10.0"

# 文档处理
python-docx = ">=1.2.0"
pytesseract = ">=0.3.13"
pillow = ">=10.0.0"

# 工具
python-dotenv = ">=1.0.0"
loguru = ">=0.7.0"
```

### 配置管理

```python
@dataclass
class Config:
    # 路径配置
    project_root: Path
    documents_dir: Path
    images_dir: Path
    indexes_dir: Path
    
    # Embedding配置
    text_embedding_model: str = "text-embedding-v4"
    text_embedding_dim: int = 1024
    image_embedding_dim: int = 512
    
    # 检索配置
    top_k: int = 5
    score_threshold: float = 0.7
    
    # LLM配置
    llm_model: str = "qwen-max"
    llm_temperature: float = 0.7
    llm_max_tokens: int = 2000
```

---

## 扩展架构设计

### 模块化设计

```
code/
├── config.py          # 配置模块 (可扩展配置源)
├── data_processor.py  # 数据处理 (可添加新格式支持)
├── embedding.py       # 向量化 (可替换Embedding模型)
├── retrieval.py       # 检索 (可添加新检索策略)
├── generator.py       # 生成 (可替换LLM)
└── main.py           # 入口 (可扩展接口)
```

### 插件化扩展点

| 扩展点 | 当前实现 | 可替换方案 |
|--------|----------|------------|
| 文档处理 | python-docx | PyPDF, unstructured |
| 文本Embedding | DashScope | OpenAI, 本地模型 |
| 图像Embedding | CLIP | BLIP, DINO |
| 向量数据库 | FAISS | Milvus, Pinecone |
| LLM | 通义千问 | GPT-4, Claude |

---

## 性能优化策略

### 向量化优化

1. **批量处理**: 支持批量向量化减少API调用
2. **缓存机制**: 相同文本不重复向量化
3. **异步处理**: 图像向量化可异步执行

### 检索优化

1. **索引预加载**: 启动时加载索引到内存
2. **结果缓存**: 高频查询结果缓存
3. **并行检索**: 文本和图像检索并行执行

### 生成优化

1. **流式输出**: 减少用户等待时间
2. **上下文截断**: 控制Token数量
3. **多轮对话**: 支持上下文记忆

---

*最后更新: 2026年2月15日*
*文档版本: v1.0*
