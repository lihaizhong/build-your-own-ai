# 迪士尼RAG问答助手 - 使用指南

## 环境准备

### 系统要求

| 要求 | 说明 |
|------|------|
| Python | >= 3.11 |
| 操作系统 | macOS / Linux / Windows |
| 内存 | >= 8GB (推荐16GB) |
| 磁盘 | >= 2GB 可用空间 |

### 依赖安装

项目使用根目录的虚拟环境，确保已安装所需依赖：

```bash
# 进入项目根目录
cd /path/to/build-your-own-ai

# 激活虚拟环境
source .venv/bin/activate  # macOS/Linux
# 或
.venv\Scripts\activate     # Windows

# 验证依赖已安装
uv pip list | grep -E "langchain|faiss|dashscope|transformers"
```

### 必需依赖

```toml
# 核心依赖（已在根目录pyproject.toml中配置）
langchain >= 1.2.9           # LLM框架
langchain-community >= 0.1.0  # 社区集成
faiss-cpu >= 1.13.2          # 向量数据库
dashscope >= 1.25.11         # 阿里云API
transformers >= 5.1.0        # CLIP模型
torch >= 2.10.0              # 深度学习框架
python-docx >= 1.2.0         # Word处理
pytesseract >= 0.3.13        # OCR识别
pillow >= 10.0.0             # 图像处理
```

### 可选依赖

```bash
# GPU加速（如有NVIDIA显卡）
uv add faiss-gpu

# 更快的Tokenization
uv add tiktoken
```

---

## API密钥配置

### 获取DashScope API密钥

1. 访问 [阿里云百炼平台](https://bailian.console.aliyun.com/)
2. 登录/注册阿里云账号
3. 开通DashScope服务
4. 在控制台创建API Key

### 配置环境变量

在项目根目录创建或编辑 `.env` 文件：

```bash
# 在项目根目录
cd /path/to/build-your-own-ai

# 创建/编辑.env文件
cat > .env << 'EOF'
DASHSCOPE_API_KEY=sk-your-api-key-here
EOF
```

### 验证配置

```bash
# 测试API密钥是否有效
python -c "
import os
from dotenv import load_dotenv
load_dotenv()
api_key = os.environ.get('DASHSCOPE_API_KEY')
print(f'API Key: {api_key[:10]}...' if api_key else 'API Key not found')
"
```

---

## 快速开始

### 5分钟体验流程

```bash
# Step 1: 进入项目目录
cd practice/15-CASE-迪士尼RAG助手

# Step 2: 构建索引（首次使用必须）
python -m code.main --build

# Step 3: 开始问答
python -m code.main --interactive
```

### 详细执行步骤

#### Step 1: 构建索引

```bash
python -m code.main --build
```

输出示例：
```
╔══════════════════════════════════════════════════════════╗
║                                                          ║
║            Disney RAG 问答助手 v1.0.0                   ║
║                                                          ║
╚══════════════════════════════════════════════════════════╝

============================================================
开始构建索引
============================================================

【Step 1】处理文档...
找到 4 个文档文件
处理完成: 1-上海迪士尼门票规则.docx，生成 8 个文本块
处理完成: 2-迪士尼老人票价规定.docx，生成 5 个文本块
处理完成: 3-迪士尼乐园游玩攻略清单.docx，生成 12 个文本块
处理完成: 4-上海迪士尼乐园酒店会员制度.docx，生成 6 个文本块
文档处理完成，共生成 31 个文本块

【Step 2】处理图像...
找到 5 个图像文件
处理完成: lion_king_poster.jpg
处理完成: snow_white_poster.jpg
处理完成: disney_castle.jpg
处理完成: mickey_mouse.png
处理完成: disney_characters.jpg
图像处理完成，共处理 5 个图像

【Step 3】保存索引...
索引已保存: user_data/indexes/text_index.faiss (向量数: 31)
索引已保存: user_data/indexes/image_index.faiss (向量数: 5)

============================================================
索引构建完成
============================================================
```

#### Step 2: 交互式问答

```bash
python -m code.main --interactive
```

输出示例：
```
╔══════════════════════════════════════════════════════════╗
║                                                          ║
║            Disney RAG 问答助手 v1.0.0                   ║
║                                                          ║
║       基于向量数据库的智能问答系统                       ║
║       支持文档处理、图像检索和混合问答                   ║
║                                                          ║
╚══════════════════════════════════════════════════════════╝

输入 'quit' 或 'exit' 退出
输入 'help' 查看帮助信息
============================================================

请输入您的问题: 迪士尼有哪些经典动画电影？
```

#### Step 3: 单次查询

```bash
python -m code.main --query "上海迪士尼门票价格是多少？"
```

---

## 使用方式详解

### 交互式问答模式

交互模式适合连续提问和多轮对话：

```bash
python -m code.main --interactive
# 或
python -m code.main -i
```

#### 可用命令

| 命令 | 说明 |
|------|------|
| `quit` / `exit` / `退出` | 退出程序 |
| `help` / `帮助` | 显示帮助信息 |
| Ctrl+C | 强制退出 |

#### 示例对话

```
请输入您的问题: 迪士尼乐园在哪里？

============================================================
正在查询: 迪士尼乐园在哪里？
============================================================

问题: 迪士尼乐园在哪里？

答案:
迪士尼乐园遍布全球，共有六个主要度假区：

1. 加州迪士尼乐园 (美国阿纳海姆) - 1955年开幕
2. 华特迪士尼世界 (美国佛罗里达) - 1971年开幕
3. 东京迪士尼度假区 (日本) - 1983年开幕
4. 巴黎迪士尼乐园 (法国) - 1992年开幕
5. 香港迪士尼乐园 (中国) - 2005年开幕
6. 上海迪士尼度假区 (中国) - 2016年开幕

请输入您的问题: quit
再见！
```

### 单次查询模式

单次查询适合快速获取答案：

```bash
python -m code.main --query "你的问题"
# 或
python -m code.main -q "你的问题"
```

#### 示例

```bash
# 查询门票信息
python -m code.main -q "上海迪士尼门票价格"

# 查询酒店信息
python -m code.main -q "迪士尼乐园酒店有什么设施"

# 触发图像检索
python -m code.main -q "展示一下迪士尼的海报"
```

### 仅构建文本索引

跳过图像处理，加快索引构建：

```bash
python -m code.main --build-text-only
```

---

## 数据管理

### 添加文档

#### 支持的文档格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| Word文档 | `.docx` | 支持段落和表格提取 |
| 文本文件 | `.txt` | 纯文本文件 |
| Markdown | `.md` | Markdown文档 |

#### 添加步骤

```bash
# 1. 将文档放入 data/documents/ 目录
cp your_document.docx data/documents/

# 2. 重新构建索引
python -m code.main --build
```

### 添加图像

#### 支持的图像格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| PNG | `.png` | 无损压缩 |
| JPEG | `.jpg`, `.jpeg` | 有损压缩 |
| GIF | `.gif` | 动画支持 |
| BMP | `.bmp` | 位图 |
| WebP | `.webp` | 新型格式 |

#### 添加步骤

```bash
# 1. 将图像放入 data/images/ 目录
cp your_image.jpg data/images/

# 2. 重新构建索引
python -m code.main --build
```

### 索引管理

#### 索引文件位置

```
user_data/indexes/
├── text_index.faiss      # 文本向量索引
├── text_documents.pkl    # 文本文档数据
├── image_index.faiss     # 图像向量索引
└── image_documents.pkl   # 图像数据
```

#### 清理索引

```bash
# 删除所有索引
rm -rf user_data/indexes/*

# 重新构建
python -m code.main --build
```

---

## 图像检索

### 触发方式

图像检索通过关键词自动触发：

```python
# 默认关键词列表
image_keywords = ["海报", "图片", "图像", "照片", "截图", "展示"]
```

### 使用示例

#### 查询海报

```
请输入您的问题: 展示一下迪士尼的海报

============================================================
正在查询: 展示一下迪士尼的海报
============================================================

问题: 展示一下迪士尼的海报

答案:
迪士尼有众多经典电影的海报，包括：

1. 《白雪公主与七个小矮人》海报
2. 《狮子王》海报
3. 《冰雪奇缘》海报
4. 《小美人鱼》海报

相关图像信息：
- 图像1 (来源: data/images/lion_king_poster.jpg, 相似度: 0.856)
- 图像2 (来源: data/images/snow_white_poster.jpg, 相似度: 0.832)
```

#### 查询照片

```
请输入您的问题: 有没有迪士尼城堡的照片

============================================================
正在查询: 有没有迪士尼城堡的照片
============================================================

问题: 有没有迪士尼城堡的照片

答案:
找到了迪士尼城堡的相关照片：

相关图像信息：
- 图像1 (来源: data/images/disney_castle.jpg, 相似度: 0.789)
```

### 自定义关键词

修改 `code/config.py`：

```python
config.image_keywords = [
    "海报", "图片", "图像", "照片", "截图", "展示",
    "壁纸", "图标", "封面"  # 添加新关键词
]
```

---

## 高级配置

### 检索参数调整

```python
# code/config.py

# 检索结果数量
config.top_k = 10  # 默认 5

# 相似度阈值
config.score_threshold = 0.6  # 默认 0.7，降低可获得更多结果
```

### LLM参数调整

```python
# code/config.py

# 模型选择
config.llm_model = "qwen-max"  # 或 "deepseek-chat"

# 温度参数（0-1，越低越确定）
config.llm_temperature = 0.5  # 默认 0.7

# 最大输出长度
config.llm_max_tokens = 3000  # 默认 2000
```

### Embedding配置

```python
# code/config.py

# 文本Embedding模型
config.text_embedding_model = "text-embedding-v4"  # 最新版
config.text_embedding_dim = 1024  # 向量维度

# 图像Embedding模型
config.clip_model_name = "clip-vit-base-patch32"  # CLIP模型
config.image_embedding_dim = 512  # 向量维度
```

---

## 代码接口使用

### 基本使用

```python
from pathlib import Path
import sys

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent))

from code.config import config, load_env_config
from code.embedding import VectorStore
from code.retrieval import HybridRetriever
from code.generator import AnswerGenerator, RAGPipeline

# 加载环境变量
load_env_config()

# 加载索引
vector_store = VectorStore()
vector_store.load_indexes()

# 创建RAG管道
retriever = HybridRetriever(vector_store)
generator = AnswerGenerator()
pipeline = RAGPipeline(retriever, generator)

# 执行查询
result = pipeline.query("迪士尼有哪些经典动画电影？")
print(pipeline.format_response(result))
```

### 流式输出

```python
# 流式生成答案
for chunk in pipeline.query_stream("上海迪士尼门票价格是多少？"):
    print(chunk, end="", flush=True)
```

### 自定义检索

```python
# 仅文本检索
text_results = retriever.text_retriever.retrieve(
    query="迪士尼乐园",
    top_k=10,
    score_threshold=0.6
)

# 仅图像检索
image_results = retriever.image_retriever.retrieve_by_text(
    query="迪士尼海报",
    top_k=5
)

# 混合检索
results = retriever.retrieve(
    query="迪士尼城堡的照片",
    force_image_search=True  # 强制触发图像检索
)
```

---

## 常见问题解决

### Q1: API密钥无效

**问题**: `API Key invalid` 或 `Authentication failed`

**解决方案**:
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY

# 确认.env文件存在
cat .env

# 重新加载环境变量
source .env 2>/dev/null || export $(cat .env | xargs)
```

### Q2: 索引文件不存在

**问题**: `Index file not found`

**解决方案**:
```bash
# 重新构建索引
python -m code.main --build
```

### Q3: 图像处理失败

**问题**: `Image processing failed` 或 CLIP模型加载失败

**解决方案**:
```bash
# 仅构建文本索引
python -m code.main --build-text-only

# 或检查CLIP模型
python -c "from transformers import CLIPModel; CLIPModel.from_pretrained('openai/clip-vit-base-patch32')"
```

### Q4: OCR识别失败

**问题**: Tesseract OCR错误

**解决方案**:
```bash
# macOS
brew install tesseract
brew install tesseract-lang

# Ubuntu
sudo apt-get install tesseract-ocr
sudo apt-get install tesseract-ocr-chi-sim

# Windows
# 下载安装包: https://github.com/UB-Mannheim/tesseract/wiki
```

### Q5: 内存不足

**问题**: `MemoryError` 或系统卡顿

**解决方案**:
```python
# 减少batch size
config.llm_max_tokens = 1000

# 或使用更小的模型
config.clip_model_name = "clip-vit-base-patch16"  # 更小更快的CLIP
```

---

## 性能调优

### 向量化优化

```python
# 批量向量化（减少API调用次数）
embeddings = text_embedding_model.embed_texts(texts)  # 批量
# 而不是
for text in texts:
    embedding = text_embedding_model.embed_text(text)  # 单个
```

### 检索优化

```python
# 调整top_k减少计算量
config.top_k = 3  # 减少返回结果

# 提高阈值过滤更多结果
config.score_threshold = 0.8
```

### 索引优化

```python
# 使用IVF索引加速大规模检索
config.index_type = "IndexIVFFlat"
config.nlist = 100  # 聚类中心数
```

---

## 日志和调试

### 查看日志

```bash
# 日志文件位置
ls output/logs/

# 查看最新日志
tail -f output/logs/disney_rag_*.log
```

### 调试模式

```python
# 启用详细日志
from loguru import logger
logger.add(sys.stdout, level="DEBUG")
```

### 验证系统状态

```python
# 检查索引状态
vector_store = VectorStore()
vector_store.load_indexes()

print(f"文本索引: {vector_store.text_index.size} 个向量")
print(f"图像索引: {vector_store.image_index.size} 个向量")
```

---

*最后更新: 2026年2月15日*
*文档版本: v1.0*
