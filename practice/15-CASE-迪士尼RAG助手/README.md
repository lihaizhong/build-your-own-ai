# è¿ªå£«å°¼RAGé—®ç­”åŠ©æ‰‹

åŸºäºRAGï¼ˆRetrieval-Augmented Generationï¼‰æŠ€æœ¯çš„åŸç”Ÿåº”ç”¨ï¼Œæ”¯æŒæ–‡æ¡£å¤„ç†ã€å›¾åƒæ£€ç´¢å’Œæ··åˆé—®ç­”ã€‚

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„RAGé—®ç­”ç³»ç»Ÿï¼Œé€šè¿‡FAISSå‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£å’Œå›¾åƒï¼Œç»“åˆå¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå‡†ç¡®çš„ç­”æ¡ˆã€‚ç³»ç»Ÿæ”¯æŒè¿ªå£«å°¼ç›¸å…³çš„çŸ¥è¯†åº“é—®ç­”ï¼Œå…·å¤‡æ–‡æ¡£å¤„ç†ã€å›¾åƒOCRã€æ··åˆæ£€ç´¢ç­‰é«˜çº§åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### Step1: æ•°æ®å±‚
- ğŸ“„ **æ–‡æ¡£å¤„ç†**: æ”¯æŒWordæ–‡æ¡£(.docx)ã€æ–‡æœ¬æ–‡ä»¶(.txt, .md)çš„è§£æ
- ğŸ–¼ï¸ **å›¾åƒå¤„ç†**: æ”¯æŒå›¾ç‰‡OCRï¼ˆTesseractï¼‰å’Œå›¾åƒæå–
- ğŸ“Š **è¡¨æ ¼æå–**: å°†Wordæ–‡æ¡£ä¸­çš„è¡¨æ ¼è½¬æ¢ä¸ºMarkdownæ ¼å¼

### Step2: å‘é‡åŒ–å±‚
- ğŸ¯ **æ–‡æœ¬Embedding**: ä½¿ç”¨é˜¿é‡Œäº‘ç™¾ç‚¼text-embedding-v4æ¨¡å‹ï¼ˆ1024ç»´ï¼‰
- ğŸŒŸ **å›¾åƒEmbedding**: ä½¿ç”¨CLIPæ¨¡å‹æå–å›¾åƒç‰¹å¾ï¼ˆ512ç»´ï¼‰
- ğŸ—„ï¸ **åŒç´¢å¼•ç³»ç»Ÿ**: FAISSåˆ†åˆ«æ„å»ºæ–‡æœ¬å’Œå›¾åƒçš„å‘é‡ç´¢å¼•

### Step3: æ£€ç´¢å±‚
- ğŸ” **æ··åˆæ£€ç´¢**: æ–‡æœ¬æŸ¥è¯¢ä½¿ç”¨è¯­ä¹‰ç›¸ä¼¼åº¦ï¼Œå›¾åƒæŸ¥è¯¢ä½¿ç”¨CLIPç¼–ç å™¨
- âš¡ **å…³é”®è¯è§¦å‘**: æ£€æµ‹ç‰¹å®šå…³é”®è¯ï¼ˆå¦‚"æµ·æŠ¥"ã€"å›¾ç‰‡"ï¼‰è§¦å‘å›¾åƒæ£€ç´¢
- ğŸ“ˆ **ç›¸ä¼¼åº¦è®¡ç®—**: L2è·ç¦»è½¬ç›¸ä¼¼åº¦ï¼Œæ”¯æŒåˆ†æ•°é˜ˆå€¼è¿‡æ»¤

### Step4: ç”Ÿæˆå±‚
- ğŸ¤– **ä¸Šä¸‹æ–‡ç»„ç»‡**: å°†æ£€ç´¢ç»“æœç»„ç»‡æˆç»“æ„åŒ–æç¤º
- ğŸ’¬ **æ™ºèƒ½é—®ç­”**: åŸºäºæ£€ç´¢ç»“æœç”Ÿæˆå‡†ç¡®çš„ç­”æ¡ˆ
- ğŸ”„ **æµå¼è¾“å‡º**: æ”¯æŒæµå¼ç”Ÿæˆç­”æ¡ˆ

## é¡¹ç›®ç»“æ„

```
15-CASE-è¿ªå£«å°¼RAGåŠ©æ‰‹/
â”œâ”€â”€ code/                       # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py            # æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ utils.py               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ data_processor.py      # æ•°æ®å¤„ç†å±‚ï¼ˆStep1ï¼‰
â”‚   â”œâ”€â”€ embedding.py           # å‘é‡åŒ–å±‚ï¼ˆStep2ï¼‰
â”‚   â”œâ”€â”€ retrieval.py           # æ£€ç´¢å±‚ï¼ˆStep3ï¼‰
â”‚   â”œâ”€â”€ generator.py           # ç”Ÿæˆå±‚ï¼ˆStep4ï¼‰
â”‚   â””â”€â”€ main.py                # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ data/                       # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ documents/             # æ–‡æ¡£æ•°æ®
â”‚   â””â”€â”€ images/                # å›¾åƒæ•°æ®
â”œâ”€â”€ docs/                       # æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ USAGE.md               # ä½¿ç”¨æŒ‡å—
â”œâ”€â”€ user_data/                  # ç”¨æˆ·æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ indexes/               # FAISSç´¢å¼•æ–‡ä»¶
â”‚   â””â”€â”€ cache/                 # ç¼“å­˜ç›®å½•
â”œâ”€â”€ output/                     # è¾“å‡ºç›®å½•
â”‚   â””â”€â”€ logs/                  # æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ tests/                      # æµ‹è¯•ç›®å½•
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
```

## ç¯å¢ƒè¦æ±‚

- Python >= 3.11
- uv åŒ…ç®¡ç†å™¨
- æ ¹ç›®å½•çš„è™šæ‹Ÿç¯å¢ƒ

## å¿«é€Ÿå¼€å§‹

### 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ

```bash
# æ¿€æ´»æ ¹ç›®å½•çš„è™šæ‹Ÿç¯å¢ƒ
cd /Users/lihaizhong/Documents/Project/build-your-own-x/build-your-own-ai
source .venv/bin/activate
```

### 2. å®‰è£…ä¾èµ–

ç¡®ä¿æ ¹ç›®å½•çš„ `pyproject.toml` åŒ…å«å¿…è¦çš„ä¾èµ–ï¼š

```toml
dependencies = [
    "langchain>=0.1.0",
    "langchain-community>=0.1.0",
    "langchain-core>=0.1.0",
    "langchain-openai>=0.1.0",
    "faiss-cpu>=1.7.4",
    "PyPDF2>=3.0.0",
    "python-docx>=0.8.11",
    "pytesseract>=0.3.10",
    "python-dotenv>=1.0.0",
    "dashscope>=1.22.1",
    "numpy>=1.24.0",
    "pandas>=2.0.0",
    "pillow>=10.0.0",
    "torch>=2.0.0",
    "transformers>=4.30.0",
    "openai>=1.0.0",
    "loguru>=0.7.0",
]
```

å¦‚æœç¼ºå°‘ä¾èµ–ï¼Œè¿è¡Œï¼š

```bash
uv add langchain langchain-community langchain-core langchain-openai
uv add faiss-cpu PyPDF2 python-docx pytesseract
uv add python-dotenv dashscope numpy pandas
uv add pillow torch transformers openai loguru
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

ç¡®ä¿æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶åŒ…å«ï¼š

```env
DASHSCOPE_API_KEY=your_dashscope_api_key_here
```

### 4. å‡†å¤‡æ•°æ®

é¡¹ç›®å·²åŒ…å«ç¤ºä¾‹æ–‡æ¡£å’ŒWordæ–‡ä»¶ï¼š
- `data/documents/` - æ–‡æ¡£ç›®å½•
- `data/images/` - å›¾åƒç›®å½•
- `data/1-ä¸Šæµ·è¿ªå£«å°¼é—¨ç¥¨è§„åˆ™.docx`
- `data/2-è¿ªå£«å°¼è€äººç¥¨ä»·è§„å®š.docx`
- `data/3-è¿ªå£«å°¼ä¹å›­æ¸¸ç©æ”»ç•¥æ¸…å•.docx`
- `data/4-ä¸Šæµ·è¿ªå£«å°¼ä¹å›­é…’åº—ä¼šå‘˜åˆ¶åº¦.docx`

ä½ å¯ä»¥æ·»åŠ è‡ªå·±çš„æ–‡æ¡£å’Œå›¾åƒï¼š

```bash
# æ–‡æ¡£æ”¾å…¥ data/documents/
cp your_document.docx data/documents/

# å›¾åƒæ”¾å…¥ data/images/
cp your_image.png data/images/
```

### 5. æ„å»ºç´¢å¼•

```bash
cd practice/15-CASE-è¿ªå£«å°¼RAGåŠ©æ‰‹
python -m code.main --build
```

### 6. è¿è¡Œé—®ç­”

#### äº¤äº’æ¨¡å¼

```bash
python -m code.main --interactive
```

#### å•æ¬¡æŸ¥è¯¢

```bash
python -m code.main --query "è¿ªå£«å°¼æœ‰å“ªäº›ç»å…¸åŠ¨ç”»ç”µå½±ï¼Ÿ"
```

## æŠ€æœ¯æ ˆ

- **LangChain**: å¤§æ¨¡å‹åº”ç”¨å¼€å‘æ¡†æ¶
- **FAISS**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
- **DashScope**: é˜¿é‡Œäº‘é€šä¹‰åƒé—®APIï¼ˆæ–‡æœ¬Embeddingå’ŒLLMï¼‰
- **OpenAI**: å…¼å®¹APIå®¢æˆ·ç«¯
- **Transformers**: CLIPæ¨¡å‹ï¼ˆå›¾åƒEmbeddingï¼‰
- **Tesseract**: OCRæ–‡æœ¬è¯†åˆ«
- **PyTorch**: æ·±åº¦å­¦ä¹ æ¡†æ¶

## æ¨¡å—è¯´æ˜

### æ•°æ®å¤„ç†å±‚ (`data_processor.py`)

- `DocumentProcessor`: æ–‡æ¡£å¤„ç†å™¨ï¼Œæ”¯æŒWordå’Œæ–‡æœ¬æ–‡ä»¶
- `ImageProcessor`: å›¾åƒå¤„ç†å™¨ï¼Œæ”¯æŒOCRè¯†åˆ«
- `TextChunk`: æ–‡æœ¬å—æ•°æ®ç±»
- `ImageData`: å›¾åƒæ•°æ®ç±»

### å‘é‡åŒ–å±‚ (`embedding.py`)

- `TextEmbeddingModel`: æ–‡æœ¬å‘é‡åŒ–ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ï¼‰
- `ImageEmbeddingModel`: å›¾åƒå‘é‡åŒ–ï¼ˆCLIPï¼‰
- `FAISSIndex`: FAISSç´¢å¼•ç®¡ç†
- `VectorStore`: å‘é‡å­˜å‚¨ç®¡ç†å™¨

### æ£€ç´¢å±‚ (`retrieval.py`)

- `TextRetriever`: æ–‡æœ¬æ£€ç´¢å™¨
- `ImageRetriever`: å›¾åƒæ£€ç´¢å™¨
- `HybridRetriever`: æ··åˆæ£€ç´¢å™¨
- `RetrievalResult`: æ£€ç´¢ç»“æœæ•°æ®ç±»

### ç”Ÿæˆå±‚ (`generator.py`)

- `PromptBuilder`: æç¤ºè¯æ„å»ºå™¨
- `AnswerGenerator`: ç­”æ¡ˆç”Ÿæˆå™¨
- `RAGPipeline`: RAGæµç¨‹ç®¡é“

### ä¸»ç¨‹åº (`main.py`)

æä¾›å‘½ä»¤è¡Œç•Œé¢ï¼š
- `--build`: æ„å»ºç´¢å¼•
- `--interactive`: äº¤äº’å¼é—®ç­”
- `--query`: å•æ¬¡æŸ¥è¯¢

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: æ–‡æœ¬é—®ç­”

```bash
$ python -m code.main -q "è¿ªå£«å°¼æœ‰å“ªäº›ç»å…¸åŠ¨ç”»ç”µå½±ï¼Ÿ"

é—®é¢˜: è¿ªå£«å°¼æœ‰å“ªäº›ç»å…¸åŠ¨ç”»ç”µå½±ï¼Ÿ

ç­”æ¡ˆ:
è¿ªå£«å°¼æœ‰è®¸å¤šç»å…¸åŠ¨ç”»ç”µå½±ï¼ŒåŒ…æ‹¬ï¼š

1. ç±³è€é¼ ç³»åˆ— - 1928å¹´åˆ›é€ çš„ç»å…¸è§’è‰²
2. ã€Šç™½é›ªå…¬ä¸»ä¸ä¸ƒä¸ªå°çŸ®äººã€‹(1937) - è¿ªå£«å°¼ç¬¬ä¸€éƒ¨åŠ¨ç”»é•¿ç‰‡
3. ã€Šæœ¨å¶å¥‡é‡è®°ã€‹(1940)
4. ã€Šç°å§‘å¨˜ã€‹(1950)
5. ã€Šç¡ç¾äººã€‹(1959)
6. ã€Šå°ç¾äººé±¼ã€‹(1989)
7. ã€Šç‹®å­ç‹ã€‹(1994)
```

### ç¤ºä¾‹2: å›¾åƒè§¦å‘æ£€ç´¢

```bash
$ python -m code.main -q "å±•ç¤ºä¸€ä¸‹è¿ªå£«å°¼çš„æµ·æŠ¥"

é—®é¢˜: å±•ç¤ºä¸€ä¸‹è¿ªå£«å°¼çš„æµ·æŠ¥

ç­”æ¡ˆ:
è¿ªå£«å°¼æœ‰ä¼—å¤šç»å…¸ç”µå½±çš„æµ·æŠ¥...

ç›¸å…³å›¾åƒä¿¡æ¯ï¼š
- å›¾åƒ1 (æ¥æº: data/images/lion_king_poster.jpg, ç›¸ä¼¼åº¦: 0.856)
- å›¾åƒ2 (æ¥æº: data/images/snow_white_poster.jpg, ç›¸ä¼¼åº¦: 0.832)
```

## é…ç½®è¯´æ˜

ä¸»è¦é…ç½®åœ¨ `code/config.py` ä¸­ï¼š

```python
@dataclass
class Config:
    # è·¯å¾„é…ç½®
    project_root: Path = get_project_root()
    data_dir: Path | None = None
    documents_dir: Path | None = None  # é»˜è®¤: data/documents
    images_dir: Path | None = None     # é»˜è®¤: data/images
    indexes_dir: Path | None = None    # é»˜è®¤: user_data/indexes
    cache_dir: Path | None = None      # é»˜è®¤: user_data/cache
    output_dir: Path | None = None     # é»˜è®¤: output
    
    # Embeddingé…ç½®
    text_embedding_model: str = "text-embedding-v4"
    text_embedding_dim: int = 1024
    image_embedding_dim: int = 512
    clip_model_name: str = "ViT-B/32"
    
    # æ£€ç´¢é…ç½®
    top_k: int = 5
    score_threshold: float = 0.7
    
    # å›¾åƒæ£€ç´¢å…³é”®è¯
    image_keywords: list = ["æµ·æŠ¥", "å›¾ç‰‡", "å›¾åƒ", "ç…§ç‰‡", "æˆªå›¾", "å±•ç¤º"]
```

## è¯¦ç»†ä½¿ç”¨æŒ‡å—

æ›´å¤šè¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ [USAGE.md](./docs/USAGE.md)ã€‚

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°æ–‡æ¡£ï¼Ÿ

å°†æ–‡æ¡£æ–‡ä»¶æ”¾å…¥ `data/documents/` ç›®å½•ï¼Œç„¶åé‡æ–°æ„å»ºç´¢å¼•ã€‚

### Q2: ç´¢å¼•æ–‡ä»¶ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ

ç´¢å¼•æ–‡ä»¶ä¿å­˜åœ¨ `user_data/indexes/` ç›®å½•ã€‚

### Q3: æ”¯æŒå“ªäº›æ–‡æ¡£æ ¼å¼ï¼Ÿ

æ”¯æŒ `.docx`ã€`.txt`ã€`.md` æ ¼å¼ã€‚

### Q4: æ”¯æŒå“ªäº›å›¾åƒæ ¼å¼ï¼Ÿ

æ”¯æŒ `.png`ã€`.jpg`ã€`.jpeg`ã€`.gif`ã€`.bmp`ã€`.webp` æ ¼å¼ã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„LICENSEæ–‡ä»¶ä¸­å®šä¹‰çš„è®¸å¯è¯ã€‚

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-02-10)
- âœ¨ å®Œæ•´çš„RAGæµç¨‹å®ç°
- ğŸ“„ æ”¯æŒWordæ–‡æ¡£å¤„ç†
- ğŸ–¼ï¸ æ”¯æŒå›¾åƒOCRå’Œå‘é‡åŒ–
- ğŸ” æ··åˆæ£€ç´¢å’Œå…³é”®è¯è§¦å‘
- ğŸ’¬ äº¤äº’å¼é—®ç­”ç•Œé¢
- ğŸ“š å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£