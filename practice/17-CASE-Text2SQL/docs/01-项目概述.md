# Text2SQL智能查询系统 - 项目概述

## 项目简介

Text2SQL智能查询系统是一个基于大语言模型(LLM)的自然语言转SQL查询工具，能够让用户通过自然语言提问来查询数据库，无需编写SQL语句。该项目使用Few-shot学习技术，通过预置的问答示例提高SQL生成的准确性，支持多种LLM提供商，提供了完整的交互式命令行界面。

## 核心功能

### 1. 自然语言转SQL
- 支持中文自然语言查询
- 智能理解用户意图
- 自动生成标准SQL语句

### 2. Few-shot学习
- 预置12条训练数据作为示例
- 动态查找相似问题辅助生成
- 支持自定义训练数据扩展

### 3. 多LLM提供商支持
- 通义千问(DashScope)
- OpenAI GPT系列
- Ollama本地模型

### 4. 交互式界面
- 命令行交互界面
- 历史查询记录
- 表结构查看
- 实时SQL执行

### 5. 数据库支持
- SQLite本地数据库
- 可扩展MySQL支持
- 自动加载表结构

## 应用场景

### 1. 数据分析
- 业务人员自助查询
- 无需掌握SQL语法
- 快速获取数据洞察

### 2. 报表系统
- 自然语言生成报表查询
- 灵活的查询条件
- 即时结果展示

### 3. 企业知识库
- 结合数据库的智能问答
- 业务数据快速检索
- 辅助决策支持

### 4. 开发辅助
- SQL语句学习参考
- 快速原型开发
- 数据库查询调试

## 技术特点

### 1. 独立实现
- 不依赖vanna库
- 轻量级架构设计
- 易于理解和扩展

### 2. Few-shot学习
- 预置高质量示例
- 动态示例选择
- 提高生成准确性

### 3. 多模型支持
- 云端API调用
- 本地模型部署
- 灵活切换配置

### 4. 游戏数据场景
- 王者荣耀英雄数据
- 贴近实际应用场景
- 丰富的查询示例

## 项目结构

```
17-CASE-Text2SQL/
├── code/                       # 核心代码目录
│   ├── __init__.py            # 模块初始化和示例
│   ├── text2sql_vanna.py      # 核心Text2SQL实现
│   ├── cli.py                 # 交互式命令行界面
│   └── prepare_data.py        # 数据准备脚本
├── data/                       # 数据目录
│   └── heros.db               # SQLite数据库
├── docs/                       # 文档目录
│   ├── 00-文档索引.md
│   ├── 01-项目概述.md
│   ├── 02-技术架构.md
│   ├── 03-使用指南.md
│   ├── 04-代码实现.md
│   ├── 05-测试和部署.md
│   └── database_schema.md     # 数据库表结构
├── output/                     # 输出目录
└── README.md                   # 项目说明文档
```

## 技术栈

### 核心技术
- **Python 3.11+**: 主要编程语言
- **SQLite**: 本地数据库
- **OpenAI SDK**: LLM API调用

### 依赖库
- **openai >= 1.0.0**: OpenAI兼容API
- **loguru >= 0.7.0**: 日志记录
- **python-dotenv >= 1.0.0**: 环境变量管理
- **rich >= 13.0.0**: 终端美化输出
- **tabulate >= 0.9.0**: 表格格式化

### LLM提供商配置

| 提供商 | 环境变量 | 默认模型 |
|--------|----------|----------|
| 通义千问 | `DASHSCOPE_API_KEY` | `qwen-turbo` |
| OpenAI | `OPENAI_API_KEY` | `gpt-4o-mini` |
| Ollama | 本地服务 | `deepseek-r1:7b` |

## 数据库设计

### 表结构

#### heros表 - 英雄基本信息
| 字段 | 类型 | 说明 |
|------|------|------|
| hero_id | INTEGER | 英雄ID（主键） |
| hero_name | TEXT | 英雄名称 |
| role | TEXT | 定位（战士/法师/射手/辅助/坦克/刺客） |
| health | INTEGER | 生命值 |
| attack_damage | INTEGER | 攻击力 |
| is_free | BOOLEAN | 是否周免 |
| price | INTEGER | 价格（金币） |
| region | TEXT | 所属阵营 |

#### hero_skills表 - 英雄技能
| 字段 | 类型 | 说明 |
|------|------|------|
| skill_id | INTEGER | 技能ID（主键） |
| hero_id | INTEGER | 英雄ID（外键） |
| skill_name | TEXT | 技能名称 |
| skill_type | TEXT | 技能类型 |
| cooldown | REAL | 冷却时间 |
| damage_type | TEXT | 伤害类型 |

#### match_records表 - 比赛记录
| 字段 | 类型 | 说明 |
|------|------|------|
| match_id | INTEGER | 比赛ID（主键） |
| hero_id | INTEGER | 英雄ID（外键） |
| kill_count | INTEGER | 击杀数 |
| death_count | INTEGER | 死亡数 |
| win | BOOLEAN | 是否获胜 |
| match_date | TEXT | 比赛日期 |

### 示例数据

数据库包含30个王者荣耀英雄数据，覆盖6种定位：
- **战士**: 亚瑟、吕布、典韦、关羽、老夫子
- **法师**: 妲己、安琪拉、王昭君、貂蝉、小乔
- **射手**: 后羿、鲁班七号、孙尚香、马可波罗、狄仁杰
- **辅助**: 蔡文姬、明世隐、瑶、大乔、庄周
- **坦克**: 张飞、程咬金、廉颇、白起、项羽
- **刺客**: 阿轲、李白、韩信、娜可露露、孙悟空

## 性能指标

### SQL生成性能
- **响应时间**: 1-5秒（取决于LLM响应）
- **准确率**: >85%（基于Few-shot学习）
- **支持查询**: SELECT、JOIN、GROUP BY、ORDER BY等

### 资源占用
- **内存**: <100MB
- **CPU**: 低占用
- **网络**: 仅LLM API调用

### 数据库规模
- **英雄数据**: 30条记录
- **技能数据**: 120条记录
- **比赛记录**: 100条记录
- **训练数据**: 12条Few-shot示例

## 项目价值

### 1. 学习价值
- 深入理解Text2SQL技术
- 掌握Few-shot提示词工程
- 学习LLM应用开发模式

### 2. 实用价值
- 快速构建自然语言查询系统
- 支持多种LLM提供商
- 可扩展到企业级应用

### 3. 技术价值
- 展示LLM在数据库领域的应用
- 提供轻量级实现方案
- 可作为教学和演示项目

## 查询示例

### 基础查询
```
用户: 查询所有战士类英雄的名称和生命值
SQL:  SELECT hero_name, health FROM heros WHERE role = '战士'

用户: 查询生命值最高的前5个英雄
SQL:  SELECT hero_name, health FROM heros ORDER BY health DESC LIMIT 5

用户: 统计各个定位的英雄数量
SQL:  SELECT role, COUNT(*) as count FROM heros GROUP BY role
```

### 复杂查询
```
用户: 查询所有周免英雄的技能信息
SQL:  SELECT h.hero_name, s.skill_name, s.skill_type 
      FROM heros h 
      JOIN hero_skills s ON h.hero_id = s.hero_id 
      WHERE h.is_free = 1

用户: 查询胜率最高的英雄
SQL:  SELECT h.hero_name, 
             COUNT(*) as total,
             SUM(CASE WHEN m.win = 1 THEN 1 ELSE 0 END) as wins
      FROM heros h 
      JOIN match_records m ON h.hero_id = m.hero_id 
      GROUP BY h.hero_id 
      ORDER BY wins*1.0/total DESC 
      LIMIT 1
```

## 发展规划

### 短期目标
- [x] 完成核心功能开发
- [x] 支持多种LLM提供商
- [ ] 添加MySQL数据库支持
- [ ] 优化SQL生成准确性

### 中期目标
- [ ] 支持更多SQL语法
- [ ] 添加查询结果可视化
- [ ] 实现语义缓存机制
- [ ] 支持多表关联查询优化

### 长期目标
- [ ] 构建完整的Text2SQL平台
- [ ] 支持自然语言数据修改
- [ ] 集成到企业BI系统
- [ ] 支持多语言查询

---

*最后更新: 2026年2月15日*
*项目版本: v1.0*
*技术支持: build-your-own-ai项目团队*
