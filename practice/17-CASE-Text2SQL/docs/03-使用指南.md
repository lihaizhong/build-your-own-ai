# Text2SQL智能查询系统 - 使用指南

## 环境准备

### 1. 系统要求
- **Python**: 3.11+（推荐3.14）
- **操作系统**: macOS / Linux / Windows
- **网络**: 需要访问LLM API（或使用本地Ollama）

### 2. 依赖安装

#### 使用uv（推荐）
```bash
# 在项目根目录
cd practice/17-CASE-Text2SQL

# 使用根目录的虚拟环境
# 或创建独立环境
uv venv --python 3.11
source .venv/bin/activate

# 安装依赖
uv pip install openai loguru python-dotenv rich tabulate
```

#### 使用pip
```bash
pip install openai loguru python-dotenv rich tabulate
```

### 3. API密钥配置

#### 创建环境变量文件
在项目根目录创建 `.env` 文件：

```bash
# 在项目根目录
cd /path/to/build-your-own-ai

# 创建 .env 文件
cat > .env << EOF
# 通义千问（推荐）
DASHSCOPE_API_KEY=your_dashscope_key

# OpenAI（可选）
OPENAI_API_KEY=your_openai_key

# Ollama无需配置，使用本地服务
EOF
```

#### 获取API密钥
- **通义千问**: 访问 [阿里云DashScope控制台](https://dashscope.console.aliyun.com/)
- **OpenAI**: 访问 [OpenAI API Keys](https://platform.openai.com/api-keys)
- **Ollama**: 本地安装后自动可用

### 4. 数据库准备
```bash
# 进入项目目录
cd practice/17-CASE-Text2SQL

# 运行数据准备脚本（如数据库不存在）
uv run python code/prepare_data.py
```

### 5. 验证环境
```bash
# 运行示例代码
uv run python code/__init__.py

# 或启动交互界面
uv run python code/cli.py
```

## 快速开始

### 1. 基础使用

#### 启动交互界面
```bash
cd practice/17-CASE-Text2SQL
uv run python code/cli.py
```

**预期输出：**
```
╔══════════════════════════════════════════════════════════╗
║           Text2SQL 智能查询系统 v1.0.0                   ║
║                                                          ║
║     将自然语言转换为SQL查询，支持多种LLM提供商           ║
╚══════════════════════════════════════════════════════════╝

数据库: data/heros.db
表: heros, hero_skills, hero_items, match_records

输入 'help' 查看帮助，输入 'quit' 退出

请输入问题或命令: 
```

### 2. Python代码调用

#### 基础示例
```python
from code.text2sql_vanna import create_vanna

# 创建实例（使用通义千问）
vanna = create_vanna(llm_provider="dashscope")

# 生成SQL
sql = vanna.generate_sql("查询所有战士类英雄")
print(f"生成的SQL: {sql}")

# 执行查询
results = vanna.run_sql(sql)
print(f"查询结果: {results}")
```

#### 完整问答
```python
# 完整的问答流程
result = vanna.ask("查询生命值最高的前5个英雄")

print(f"问题: {result['question']}")
print(f"SQL: {result['sql']}")
print(f"结果: {result['results']}")
```

### 3. 使用不同LLM提供商

#### 通义千问（推荐）
```python
vanna = create_vanna(llm_provider="dashscope")
```

#### OpenAI
```python
vanna = create_vanna(llm_provider="openai")
```

#### Ollama本地模型
```python
vanna = create_vanna(llm_provider="ollama")
```

## 交互式使用

### 1. 支持的命令

| 命令 | 说明 |
|------|------|
| `history` | 查看历史查询记录 |
| `train` | 添加自定义训练数据 |
| `schema` | 查看数据库表结构 |
| `help` | 显示帮助信息 |
| `quit` / `exit` | 退出程序 |

### 2. 查询示例

#### 基础查询
```
请输入问题或命令: 查询所有战士类英雄的名称和生命值

生成的SQL:
SELECT hero_name, health FROM heros WHERE role = '战士'

查询结果:
┌────────────┬────────┐
│ hero_name  │ health │
├────────────┼────────┤
│ 亚瑟       │ 3500   │
│ 吕布       │ 3800   │
│ 典韦       │ 3600   │
│ 关羽       │ 3550   │
│ 老夫子     │ 3450   │
└────────────┴────────┘
```

#### 聚合查询
```
请输入问题或命令: 统计各个定位的英雄数量

生成的SQL:
SELECT role, COUNT(*) as count FROM heros GROUP BY role

查询结果:
┌────────┬───────┐
│ role   │ count │
├────────┼───────┤
│ 战士   │ 5     │
│ 法师   │ 5     │
│ 射手   │ 5     │
│ 辅助   │ 5     │
│ 坦克   │ 5     │
│ 刺客   │ 5     │
└────────┴───────┘
```

#### 关联查询
```
请输入问题或命令: 查询所有周免英雄的技能信息

生成的SQL:
SELECT h.hero_name, s.skill_name, s.skill_type 
FROM heros h 
JOIN hero_skills s ON h.hero_id = s.hero_id 
WHERE h.is_free = 1

查询结果:
┌────────────┬──────────────┬─────────────┐
│ hero_name  │ skill_name   │ skill_type  │
├────────────┼──────────────┼─────────────┤
│ 亚瑟       │ 誓约之盾     │ 控制        │
│ 亚瑟       │ 回旋打击     │ 伤害        │
│ ...        │ ...          │ ...         │
└────────────┴──────────────┴─────────────┘
```

### 3. 查看历史记录
```
请输入问题或命令: history

历史查询记录:
1. 查询所有战士类英雄
2. 统计各个定位的英雄数量
3. 查询生命值最高的前5个英雄
```

### 4. 查看表结构
```
请输入问题或命令: schema

数据库表结构:
heros(hero_id INTEGER, hero_name TEXT, role TEXT, health INTEGER, ...)
hero_skills(skill_id INTEGER, hero_id INTEGER, skill_name TEXT, ...)
hero_items(id INTEGER, hero_id INTEGER, item_name TEXT, ...)
match_records(match_id INTEGER, hero_id INTEGER, kill_count INTEGER, ...)
```

## 自定义训练数据

### 1. 添加训练数据（交互模式）
```
请输入问题或命令: train

请输入问题: 查询价格在10000金币以上的英雄
请输入SQL: SELECT * FROM heros WHERE price > 10000

训练数据已添加！
```

### 2. 通过代码添加
```python
# 添加自定义训练数据
vanna.train(
    question="查询价格在10000金币以上的英雄",
    sql="SELECT * FROM heros WHERE price > 10000"
)

# 添加更多示例
vanna.train(
    question="查询来自长城守卫军的英雄",
    sql="SELECT * FROM heros WHERE region = '长城守卫军'"
)
```

### 3. 批量导入训练数据
```python
# 批量添加训练数据
training_examples = [
    {"question": "查询平均攻击力最高的定位", 
     "sql": "SELECT role, AVG(attack_damage) as avg_attack FROM heros GROUP BY role ORDER BY avg_attack DESC LIMIT 1"},
    {"question": "查询技能冷却时间最短的英雄", 
     "sql": "SELECT h.hero_name, s.skill_name, s.cooldown FROM heros h JOIN hero_skills s ON h.hero_id = s.hero_id ORDER BY s.cooldown ASC LIMIT 1"},
]

for example in training_examples:
    vanna.train(example["question"], example["sql"])
```

## API调用详解

### 1. SimpleVanna类API

#### `generate_sql(question: str) -> str`
生成SQL语句。

**参数：**
- `question` (str): 自然语言问题

**返回：**
- `str`: 生成的SQL语句

**示例：**
```python
sql = vanna.generate_sql("查询所有法师")
# 返回: "SELECT * FROM heros WHERE role = '法师'"
```

#### `run_sql(sql: str) -> list`
执行SQL查询。

**参数：**
- `sql` (str): SQL语句

**返回：**
- `list`: 查询结果列表

**示例：**
```python
results = vanna.run_sql("SELECT * FROM heros LIMIT 5")
# 返回: [{"hero_id": 1, "hero_name": "亚瑟", ...}, ...]
```

#### `ask(question: str) -> dict`
完整的问答流程。

**参数：**
- `question` (str): 自然语言问题

**返回：**
- `dict`: 包含问题、SQL、结果、错误信息的字典

**示例：**
```python
result = vanna.ask("查询生命值最高的英雄")
# 返回:
# {
#     "question": "查询生命值最高的英雄",
#     "sql": "SELECT * FROM heros ORDER BY health DESC LIMIT 1",
#     "results": [...],
#     "error": None
# }
```

#### `train(question: str, sql: str)`
添加训练数据。

**参数：**
- `question` (str): 问题
- `sql` (str): 对应的SQL语句

### 2. create_vanna工厂函数

```python
from code.text2sql_vanna import create_vanna

# 创建使用通义千问的实例
vanna = create_vanna(llm_provider="dashscope")

# 创建使用OpenAI的实例
vanna = create_vanna(llm_provider="openai")

# 创建使用Ollama的实例
vanna = create_vanna(llm_provider="ollama")

# 自定义模型
vanna = create_vanna(
    llm_provider="dashscope",
    model="qwen-max"  # 使用更强大的模型
)
```

## LLM提供商配置

### 1. 通义千问（DashScope）

**特点：**
- 中文理解能力强
- 响应速度快
- 价格实惠

**配置：**
```bash
# .env文件
DASHSCOPE_API_KEY=sk-your-api-key
```

**可用模型：**
- `qwen-turbo` - 快速响应（默认）
- `qwen-plus` - 平衡性能
- `qwen-max` - 最强能力

### 2. OpenAI

**特点：**
- 英文能力强
- 模型选择多
- 社区支持好

**配置：**
```bash
# .env文件
OPENAI_API_KEY=sk-your-api-key
```

**可用模型：**
- `gpt-4o-mini` - 轻量级（默认）
- `gpt-4o` - 标准版
- `gpt-4-turbo` - 高性能

### 3. Ollama本地模型

**特点：**
- 完全本地化
- 无网络依赖
- 数据安全

**安装：**
```bash
# 安装Ollama
curl -fsSL https://ollama.com/install.sh | sh

# 下载模型
ollama pull deepseek-r1:7b
```

**可用模型：**
- `deepseek-r1:7b` - DeepSeek（默认）
- `qwen2.5:7b` - 通义千问本地版
- `llama3.1:8b` - LLaMA

## 常见问题解决

### 1. API密钥问题

**问题：** `DASHSCOPE_API_KEY未设置`

**解决方案：**
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY

# 或在代码中检查
import os
print(os.environ.get("DASHSCOPE_API_KEY"))

# 确保在项目根目录的.env文件中设置了API Key
```

### 2. 数据库不存在

**问题：** `数据库文件不存在: data/heros.db`

**解决方案：**
```bash
# 运行数据准备脚本
cd practice/17-CASE-Text2SQL
uv run python code/prepare_data.py
```

### 3. SQL生成错误

**问题：** 生成的SQL语法错误或字段名错误

**解决方案：**
1. 添加更多训练数据
2. 使用更强大的LLM模型
3. 检查表结构是否正确

### 4. Ollama连接失败

**问题：** `无法连接到Ollama服务`

**解决方案：**
```bash
# 检查Ollama服务状态
ollama list

# 启动Ollama服务
ollama serve

# 确认模型已下载
ollama pull deepseek-r1:7b
```

## 性能优化

### 1. 使用更快的模型
```python
# 使用turbo版本提高响应速度
vanna = create_vanna(llm_provider="dashscope", model="qwen-turbo")
```

### 2. 添加高质量训练数据
```python
# 添加针对性的训练示例
vanna.train(
    question="查询本周胜率最高的英雄",
    sql="""
        SELECT h.hero_name, 
               SUM(CASE WHEN m.win = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) as win_rate
        FROM heros h 
        JOIN match_records m ON h.hero_id = m.hero_id 
        WHERE m.match_date >= date('now', '-7 days')
        GROUP BY h.hero_id 
        ORDER BY win_rate DESC 
        LIMIT 1
    """
)
```

### 3. 使用本地模型
```python
# 使用Ollama本地模型，避免网络延迟
vanna = create_vanna(llm_provider="ollama")
```

## 扩展使用

### 1. 连接MySQL数据库
```python
import mysql.connector

# 修改数据库连接方法
def connect_mysql():
    return mysql.connector.connect(
        host="localhost",
        user="root",
        password="password",
        database="game_db"
    )
```

### 2. 集成到Web应用
```python
from flask import Flask, request, jsonify

app = Flask(__name__)
vanna = create_vanna(llm_provider="dashscope")

@app.route("/query", methods=["POST"])
def query():
    question = request.json.get("question")
    result = vanna.ask(question)
    return jsonify(result)

if __name__ == "__main__":
    app.run(debug=True)
```

---

*最后更新: 2026年2月15日*
*文档版本: v1.0*
*维护团队: build-your-own-ai项目团队*
