# Difyæœ¬åœ°åŒ–éƒ¨ç½²å’Œåº”ç”¨ - ä½¿ç”¨æŒ‡å—

## ç¯å¢ƒå‡†å¤‡

### 1. ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Pythonç‰ˆæœ¬**: 3.11+
- **å†…å­˜**: æœ€å°4GBï¼Œæ¨è8GB+
- **å­˜å‚¨ç©ºé—´**: æœ€å°1GB

### 2. ä¾èµ–å®‰è£…

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨uvï¼ˆæ¨èï¼‰
```bash
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd /path/to/build-your-own-ai

# å®‰è£…ä¾èµ–ï¼ˆé¡¹ç›®å…±äº«æ ¹ç›®å½•è™šæ‹Ÿç¯å¢ƒï¼‰
uv sync

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate  # Linux/Mac
# æˆ–
.venv\Scripts\activate     # Windows
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨pip
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å®‰è£…ä¾èµ–
pip install requests python-dotenv cozepy
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

#### åˆ›å»º.envæ–‡ä»¶
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env
```

#### é…ç½®ç¯å¢ƒå˜é‡
```bash
# Difyé…ç½®
DIFY_BASE_URL=https://api.dify.ai/v1
DIFY_API_KEY=your_dify_api_key

# Cozeé…ç½®
COZE_API_TOKEN=your_coze_api_token
COZE_BOT_ID=your_bot_id
COZE_CN_BASE_URL=https://api.coze.cn

# é»˜è®¤ç”¨æˆ·ID
DEFAULT_USER_ID=default_user
```

#### è·å–APIå¯†é’¥

**Difyå¹³å°ï¼š**
1. ç™»å½•Difyå¹³å°ï¼ˆhttps://dify.ai æˆ–æœ¬åœ°éƒ¨ç½²ï¼‰
2. è¿›å…¥åº”ç”¨è¯¦æƒ…é¡µ
3. ç‚¹å‡»ã€ŒAPIè®¿é—®ã€
4. å¤åˆ¶APIå¯†é’¥

**Cozeå¹³å°ï¼š**
1. ç™»å½•Cozeå¹³å°ï¼ˆhttps://www.coze.cnï¼‰
2. è¿›å…¥æ™ºèƒ½ä½“è¯¦æƒ…é¡µ
3. è·å–Bot IDå’ŒAPI Token

## å¿«é€Ÿå¼€å§‹

### 1. Difyå·¥ä½œæµåº”ç”¨è°ƒç”¨

#### å®Œæ•´è¿è¡Œæµç¨‹
```bash
# 1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd practice/06-CASE-Difyæœ¬åœ°åŒ–éƒ¨ç½²å’Œåº”ç”¨

# 3. è¿è¡Œå·¥ä½œæµç¤ºä¾‹
uv run python code/dify_workflow_example.py
```

#### é¢„æœŸè¾“å‡º
```
å‘é€æ¶ˆæ¯ï¼šç¦»ç¦»åŸä¸Šè‰
è¯·æ±‚URL: https://api.dify.ai/v1/workflows/run
è¯·æ±‚å¤´: {'Authorization': 'Bearer app-xxx...', 'Content-Type': 'application/json'}
å“åº”çŠ¶æ€ç : 200
å·¥ä½œæµå›å¤: ä¸€å²ä¸€æ¯è£ï¼Œé‡ç«çƒ§ä¸å°½ï¼Œæ˜¥é£å¹åˆç”Ÿ...
å·¥ä½œæµè¿è¡ŒID: wr_20260221_xxxxx
```

### 2. Dify Chatåº”ç”¨è°ƒç”¨

#### åŸºæœ¬ä½¿ç”¨
```python
from dify_agent_client import DifyAgentClient

# åˆ›å»ºå®¢æˆ·ç«¯
client = DifyAgentClient(
    base_url="https://api.dify.ai/v1",
    api_key="your_api_key"
)

# å‘é€æ¶ˆæ¯
result = client.chat_completion(
    user_input="ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±",
    user_id="user_001"
)

print(f"å›å¤: {result['answer']}")
print(f"ä¼šè¯ID: {result['conversation_id']}")
```

#### å¤šè½®å¯¹è¯
```python
# ç¬¬ä¸€æ¬¡å¯¹è¯
result1 = client.chat_completion(
    user_input="æˆ‘æƒ³äº†è§£Python",
    user_id="user_001"
)
conversation_id = result1['conversation_id']

# ç»§ç»­å¯¹è¯ï¼ˆä½¿ç”¨ç›¸åŒçš„conversation_idï¼‰
result2 = client.chat_completion(
    user_input="å®ƒæœ‰å“ªäº›ä¼˜ç‚¹ï¼Ÿ",
    user_id="user_001",
    conversation_id=conversation_id
)
```

### 3. Cozeæ™ºèƒ½ä½“è°ƒç”¨

#### äº¤äº’å¼èŠå¤©
```bash
# è¿è¡Œäº¤äº’å¼èŠå¤©
uv run python code/coze_client.py
```

#### é¢„æœŸè¾“å‡º
```
ğŸš€ Cozeæ™ºèƒ½ä½“äº¤äº’å¼èŠå¤©å¯åŠ¨ï¼
ğŸ’¡ è¾“å…¥ 'quit' æˆ– 'exit' é€€å‡ºç¨‹åº
ğŸ’¡ è¾“å…¥ 'stream' åˆ‡æ¢åˆ°æµå¼æ¨¡å¼
ğŸ’¡ è¾“å…¥ 'normal' åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼
ğŸ’¡ è¾“å…¥ 'info' æŸ¥çœ‹æ™ºèƒ½ä½“ä¿¡æ¯
------------------------------------------------------------
âœ… Cozeå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
ğŸ“ APIåœ°å€: https://api.coze.cn
ğŸ¤– æ™ºèƒ½ä½“ID: bot_xxxxx

ğŸ¤– æ™ºèƒ½ä½“åç§°: AIåŠ©æ‰‹
ğŸ“ æ™ºèƒ½ä½“æè¿°: ä¸€ä¸ªæ™ºèƒ½é—®ç­”åŠ©æ‰‹
------------------------------------------------------------

[æ™®é€š] è¯·è¾“å…¥æ‚¨çš„é—®é¢˜: ä½ å¥½
ğŸ¤– ç”¨æˆ·: ä½ å¥½
ğŸ¤– æ™ºèƒ½ä½“: ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
```

## APIè°ƒç”¨æŒ‡å—

### 1. Dify APIè°ƒç”¨

#### è‡ªåŠ¨æ£€æµ‹åº”ç”¨ç±»å‹
```python
# è‡ªåŠ¨æ£€æµ‹åº”ç”¨ç±»å‹ï¼ˆæ¨èï¼‰
result = client.chat_completion(
    user_input="ä½ å¥½",
    user_id="user_001",
    app_type="auto"  # è‡ªåŠ¨æ£€æµ‹Chat/Completion/Workflow
)
```

#### æŒ‡å®šåº”ç”¨ç±»å‹
```python
# Chatåº”ç”¨
result = client.chat_completion(
    user_input="ä½ å¥½",
    user_id="user_001",
    app_type="chat"
)

# Completionåº”ç”¨
result = client.chat_completion(
    user_input="è¯·ç»­å†™è¿™ä¸ªæ•…äº‹",
    user_id="user_001",
    app_type="completion"
)

# Workflowåº”ç”¨
result = client.chat_completion(
    user_input="åˆ†æè¿™æ®µæ–‡æœ¬",
    user_id="user_001",
    app_type="workflow"
)
```

#### æµå¼å“åº”
```python
# ä½¿ç”¨æµå¼å“åº”
result = client.chat_completion(
    user_input="å†™ä¸€é¦–è¯—",
    user_id="user_001",
    stream=True  # å¯ç”¨æµå¼å“åº”
)
```

#### å·¥ä½œæµç›´æ¥è°ƒç”¨
```python
# ç›´æ¥è¿è¡Œå·¥ä½œæµ
result = client.run_workflow(
    inputs={
        "query": "åˆ†æè¿™æ®µæ–‡æœ¬çš„æƒ…æ„Ÿ",
        "text": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¿ƒæƒ…å¾ˆæ„‰å¿«"
    },
    user_id="user_001"
)

print(f"ç»“æœ: {result['outputs']}")
```

### 2. Coze APIè°ƒç”¨

#### æ™®é€šèŠå¤©
```python
from coze_client import CozeClient

client = CozeClient()

# æ™®é€šèŠå¤©
response = client.chat("ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±")
print(response)
```

#### æµå¼èŠå¤©
```python
# æµå¼èŠå¤©
for chunk in client.chat_stream("å†™ä¸€é¦–å…³äºæ˜¥å¤©çš„è¯—"):
    print(chunk, end="", flush=True)
```

#### å¸¦å†å²è®°å½•èŠå¤©
```python
# å¸¦å†å²è®°å½•çš„èŠå¤©
messages = [
    {"role": "user", "content": "æˆ‘å«å°æ˜"},
    {"role": "assistant", "content": "ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ "},
    {"role": "user", "content": "ä½ è®°å¾—æˆ‘çš„åå­—å—ï¼Ÿ"}
]

response = client.chat_with_history(messages)
print(response)
```

#### è·å–æ™ºèƒ½ä½“ä¿¡æ¯
```python
# è·å–æ™ºèƒ½ä½“ä¿¡æ¯
bot_info = client.get_bot_info()
print(f"åç§°: {bot_info['name']}")
print(f"æè¿°: {bot_info['description']}")
```

## å¸¸è§é—®é¢˜è§£å†³

### 1. APIå¯†é’¥é”™è¯¯

#### é—®é¢˜ç°è±¡
```
HTTP 401: Unauthorized
```

#### è§£å†³æ–¹æ¡ˆ
```bash
# 1. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
cat .env

# 2. ç¡®è®¤APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
# Dify: åœ¨åº”ç”¨è®¾ç½®ä¸­é‡æ–°ç”ŸæˆAPIå¯†é’¥
# Coze: æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ

# 3. éªŒè¯ç¯å¢ƒå˜é‡åŠ è½½
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print(os.getenv('DIFY_API_KEY'))"
```

### 2. ç«¯ç‚¹é€‰æ‹©é”™è¯¯

#### é—®é¢˜ç°è±¡
```
not_chat_app: This application is not a chat application
```

#### è§£å†³æ–¹æ¡ˆ
```python
# ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹æ¨¡å¼
result = client.chat_completion(
    user_input="ä½ å¥½",
    app_type="auto"  # è‡ªåŠ¨æ£€æµ‹æ­£ç¡®çš„ç«¯ç‚¹
)

# æˆ–æ‰‹åŠ¨æŒ‡å®šæ­£ç¡®çš„åº”ç”¨ç±»å‹
result = client.chat_completion(
    user_input="ä½ å¥½",
    app_type="workflow"  # æ˜ç¡®æŒ‡å®šworkflowç±»å‹
)
```

### 3. æµå¼å“åº”è§£æé”™è¯¯

#### é—®é¢˜ç°è±¡
```
JSONè§£æé”™è¯¯: Expecting value
```

#### è§£å†³æ–¹æ¡ˆ
```python
# æ£€æŸ¥SSEæ•°æ®æ ¼å¼
def debug_streaming_response(response):
    for line in response.iter_lines():
        if line:
            print(f"åŸå§‹æ•°æ®: {line}")
            if line.startswith(b"data: "):
                try:
                    data = json.loads(line[6:])
                    print(f"è§£ææ•°æ®: {data}")
                except json.JSONDecodeError as e:
                    print(f"è§£æå¤±è´¥: {e}")
```

### 4. è¶…æ—¶é—®é¢˜

#### é—®é¢˜ç°è±¡
```
TimeoutError: Request timed out
```

#### è§£å†³æ–¹æ¡ˆ
```python
# å¢åŠ è¶…æ—¶æ—¶é—´
response = requests.post(url, headers=headers, json=payload, timeout=120)  # 120ç§’

# æˆ–ä½¿ç”¨å¼‚æ­¥å¤„ç†
# å…ˆæäº¤ä»»åŠ¡ï¼Œå†è½®è¯¢ç»“æœ
```

### 5. ä¼šè¯ä¸Šä¸‹æ–‡ä¸¢å¤±

#### é—®é¢˜ç°è±¡
```
å¤šè½®å¯¹è¯æ—¶ï¼Œæ¨¡å‹ä¸è®°å¾—ä¹‹å‰çš„å†…å®¹
```

#### è§£å†³æ–¹æ¡ˆ
```python
# ç¡®ä¿ä¼ é€’æ­£ç¡®çš„conversation_id
result1 = client.chat_completion("ä½ å¥½", user_id="user_001")
conversation_id = result1['conversation_id']

# åç»­å¯¹è¯ä½¿ç”¨ç›¸åŒçš„conversation_id
result2 = client.chat_completion(
    "ä½ åˆšæ‰è¯´äº†ä»€ä¹ˆï¼Ÿ",
    user_id="user_001",
    conversation_id=conversation_id  # å…³é”®ï¼
)
```

## æ€§èƒ½è°ƒä¼˜

### 1. è¿æ¥å¤ç”¨

```python
import requests
from requests.adapters import HTTPAdapter

# åˆ›å»ºSessionå¤ç”¨è¿æ¥
session = requests.Session()
session.mount('https://', HTTPAdapter(
    pool_connections=10,
    pool_maxsize=100,
    max_retries=3
))

# ä½¿ç”¨sessionå‘é€è¯·æ±‚
response = session.post(url, headers=headers, json=payload)
```

### 2. æ‰¹é‡è¯·æ±‚

```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def batch_chat(client, queries: list, max_workers: int = 5):
    """æ‰¹é‡èŠå¤©è¯·æ±‚"""
    results = []
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        futures = {
            executor.submit(client.chat_completion, query): query
            for query in queries
        }
        for future in as_completed(futures):
            results.append(future.result())
    return results
```

### 3. ç¼“å­˜ä¼˜åŒ–

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_bot_info_cached(bot_id: str):
    """ç¼“å­˜æ™ºèƒ½ä½“ä¿¡æ¯"""
    return client.get_bot_info()
```

## ç›‘æ§å’Œè°ƒè¯•

### 1. è¯·æ±‚æ—¥å¿—

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# è®°å½•è¯·æ±‚
logger.debug(f"è¯·æ±‚URL: {url}")
logger.debug(f"è¯·æ±‚å¤´: {headers}")
logger.debug(f"è¯·æ±‚ä½“: {json.dumps(payload, ensure_ascii=False)}")
```

### 2. æ€§èƒ½ç›‘æ§

```python
import time

def monitor_performance(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        
        duration = end_time - start_time
        print(f"â±ï¸ {func.__name__} æ‰§è¡Œæ—¶é—´: {duration:.2f}ç§’")
        
        return result
    return wrapper

@monitor_performance
def chat_with_monitor(message: str):
    return client.chat_completion(message)
```

### 3. é”™è¯¯è¿½è¸ª

```python
def safe_api_call(func, *args, **kwargs):
    """å®‰å…¨çš„APIè°ƒç”¨åŒ…è£…å™¨"""
    try:
        result = func(*args, **kwargs)
        if result.get("error"):
            logger.error(f"APIé”™è¯¯: {result.get('message')}")
        return result
    except Exception as e:
        logger.exception(f"APIè°ƒç”¨å¼‚å¸¸: {e}")
        return {"error": True, "message": str(e)}
```

---

*æœ€åæ›´æ–°: 2026å¹´2æœˆ21æ—¥*
*ä½¿ç”¨æŒ‡å—ç‰ˆæœ¬: v1.0*
*æŠ€æœ¯æ”¯æŒ: build-your-own-aié¡¹ç›®å›¢é˜Ÿ*
