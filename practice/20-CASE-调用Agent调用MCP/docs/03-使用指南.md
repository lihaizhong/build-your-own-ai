# MCP Agent 调用示例 - 使用指南

## 环境准备

### 1. 系统要求
- **操作系统**: macOS 10.15+, Windows 10+, Ubuntu 18.04+
- **Python版本**: 3.11+
- **Node.js**: v18+（用于 npm 包方式的 MCP 服务）
- **内存**: 最小4GB，推荐8GB+
- **存储空间**: 最小500MB，推荐2GB+

### 2. 依赖安装

#### 方式一：使用uv（推荐）
```bash
# 在项目根目录
uv sync

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

#### 方式二：使用pip
```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac

# 安装依赖
pip install qwen-agent mcp python-dotenv loguru
```

### 3. 环境变量配置

#### 复制环境变量模板
```bash
# 在项目根目录
cp .env.example .env
```

#### 配置必要的环境变量
```bash
# 编辑 .env 文件

# 必需配置 - 通义千问 API Key
DASHSCOPE_API_KEY=your_dashscope_api_key_here

# 可选配置 - 高德地图 API Key（用于自驾游规划）
AMAP_API_KEY=your_amap_api_key_here

# 可选配置 - ModelScope API Key（用于 SSE 远程 MCP 服务）
MODELSCOPE_API_KEY=your_modelscope_api_key_here

# 可选配置 - 是否启用 SSE 远程 MCP 服务（默认禁用）
ENABLE_SSE_MCP=false
```

### 4. 获取 API Key

#### DashScope API Key（必需）
1. 访问 [阿里云 DashScope 控制台](https://dashscope.console.aliyun.com/)
2. 登录阿里云账号
3. 在 API-KEY 管理页面创建新的 API Key
4. 将 API Key 配置到 `.env` 文件中

#### 高德地图 API Key（可选）
1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册并登录
3. 创建应用并获取 Key
4. 将 API Key 配置到 `.env` 文件中

#### ModelScope API Key（可选）
1. 访问 [ModelScope](https://modelscope.cn/)
2. 注册并登录
3. 获取 API Token
4. 将 API Key 配置到 `.env` 文件中

## 快速开始

### 1. 验证环境

```bash
# 进入项目目录
cd practice/20-CASE-调用Agent调用MCP

# 验证 Python 环境
python --version  # 应显示 Python 3.11+

# 验证依赖安装
python -c "from qwen_agent.agents import Assistant; print('OK')"
```

### 2. 启动服务

#### Web 界面模式（默认）
```bash
python code/main.py
```

启动后访问浏览器中显示的地址（通常是 `http://127.0.0.1:7860`）。

#### 终端交互模式
修改 `code/main.py` 中的 `__main__` 部分：
```python
if __name__ == '__main__':
    # app_gui()          # 注释掉 GUI 模式
    app_tui()            # 启用终端模式
```

然后运行：
```bash
python code/main.py
```

### 3. 测试模式
修改 `code/main.py` 中的 `__main__` 部分：
```python
if __name__ == '__main__':
    test('统计桌面上的txt文件数量')
```

## Web 界面模式

### 启动服务

```bash
python code/main.py
```

### 界面说明

启动后会自动打开浏览器访问 WebUI 界面：

```
============================================================
MCP 智能助手
============================================================

可用功能:
  1. 自驾游规划: 规划从北京到上海的7天自驾游
  2. 网页获取: 获取网页内容并转为Markdown格式
  3. 新闻搜索: 搜索最新的关税新闻
  4. 文件统计: 统计桌面上的txt文件数量

输入 'quit' 退出
============================================================
```

### 预设问题

WebUI 提供预设问题快速入口：

1. **规划从北京到上海的7天自驾游**
2. **获取网页内容并转为Markdown格式**
3. **搜索最新的关税新闻**
4. **统计桌面上的txt文件数量**

## 功能使用示例

### 1. 自驾游规划

```
用户: 规划从北京到上海的7天自驾游

助手: 我来帮您规划从北京到上海的7天自驾游路线。

[调用高德地图 MCP 服务]

为您规划以下自驾游路线：

**第1天：北京出发**
- 起点：北京市区
- 途经：天津（午餐）
- 目的地：济南（住宿）

**第2天：济南 → 泰安**
- 游览：泰山风景区
- 推荐：泰山日出、岱庙

...

**沿途推荐景点：**
1. 泰山（5A景区）
2. 曲阜孔庙（文化遗产）
3. 南京夫子庙

**加油站分布：**
- 每100公里左右有加油站
- 建议在服务区休息加油

**餐饮推荐：**
- 济南：鲁菜（糖醋鲤鱼）
- 南京：鸭血粉丝汤
...
```

### 2. 网页内容获取

```
用户: 获取网页 https://example.com 的内容并转为Markdown格式

助手: 我来获取该网页的内容。

[调用 Fetch MCP 服务]

网页内容如下：

# 示例网站

## 欢迎访问

这是一个示例网站的内容...

### 主要功能
- 功能1
- 功能2
- 功能3

...

[内容已转换为 Markdown 格式]
```

### 3. 新闻检索

```
用户: 搜索最新的关税新闻

助手: 我来搜索最新的关税相关新闻。

[调用 Bing 搜索 MCP 服务]

找到以下相关新闻：

**1. 最新关税政策解读**
来源：新华网
时间：2026-02-24
摘要：关于最新关税政策的详细解读...

**2. 关税调整对市场的影响**
来源：财经日报
时间：2026-02-23
摘要：分析关税调整对各行业的影响...

**3. 专家观点：关税趋势分析**
来源：经济观察报
时间：2026-02-22
摘要：专家对未来关税走势的预测...

[点击链接查看完整内容]
```

### 4. 文件管理

```
用户: 统计桌面上的txt文件数量

助手: 我来统计您桌面上的 txt 文件。

[调用 TXT Counter MCP 服务]

在桌面上找到 5 个 .txt 文件：

1. notes.txt
2. todo.txt
3. readme.txt
4. config.txt
5. temp.txt

---

用户: 读取 notes.txt 的内容

助手: 我来读取 notes.txt 的内容。

文件 'notes.txt' 的内容：

# 学习笔记

1. MCP 协议学习
2. Agent 开发实践
3. Python 技术栈

...
```

## 终端交互模式

### 启动终端模式

```bash
# 修改 main.py 后运行
python code/main.py
```

### 交互流程

```
============================================================
MCP 智能助手 - 终端模式
输入 'quit' 或 'exit' 退出
============================================================

用户: 统计桌面上的txt文件数量

助手: 在桌面上找到 5 个 .txt 文件：
- notes.txt
- todo.txt
- readme.txt
- config.txt
- temp.txt

用户: quit
再见！
```

### 终端模式优势

- 轻量级运行，无需 GUI 依赖
- 适合服务器环境运行
- 便于调试和测试
- 资源占用更低

## 自定义扩展

### 添加新的 MCP 服务

#### 步骤1：创建 MCP Server

在 `code/mcp_servers/` 目录下创建新文件：

```python
# code/mcp_servers/my_service.py
"""自定义 MCP 服务示例"""

from mcp.server.fastmcp import FastMCP

# 创建 MCP Server 实例
mcp = FastMCP("我的自定义服务")


@mcp.tool()
def my_function(param: str) -> str:
    """自定义工具函数
    
    Args:
        param: 参数说明
        
    Returns:
        结果说明
    """
    # 实现你的功能
    return f"处理结果: {param}"


if __name__ == "__main__":
    mcp.run()
```

#### 步骤2：注册服务

在 `code/main.py` 的 `get_mcp_config()` 函数中添加配置：

```python
def get_mcp_config() -> dict:
    mcp_servers = {}
    
    # 添加自定义服务
    mcp_servers["my-service"] = {
        "command": "python3",
        "args": [os.path.join(current_dir, "mcp_servers", "my_service.py")]
    }
    
    return {"mcpServers": mcp_servers}
```

#### 步骤3：更新系统提示词

```python
SYSTEM_PROMPT = '''
...

## 5. 自定义服务功能
- 功能描述
- 使用方法

...
'''
```

### 开发复杂的 MCP Server

#### 使用 FastMCP 装饰器

```python
from mcp.server.fastmcp import FastMCP
from typing import Optional

mcp = FastMCP("高级服务")


@mcp.tool()
def search_database(
    query: str,
    limit: Optional[int] = 10,
    offset: Optional[int] = 0
) -> str:
    """搜索数据库
    
    Args:
        query: 搜索关键词
        limit: 返回结果数量限制
        offset: 偏移量
        
    Returns:
        搜索结果
    """
    # 实现搜索逻辑
    results = perform_search(query, limit, offset)
    return format_results(results)


@mcp.tool()
def analyze_data(data_file: str) -> str:
    """分析数据文件
    
    Args:
        data_file: 数据文件路径
        
    Returns:
        分析报告
    """
    # 实现分析逻辑
    return generate_report(data_file)


@mcp.resource("config://settings")
def get_settings() -> str:
    """获取配置信息"""
    return load_settings()


if __name__ == "__main__":
    mcp.run()
```

### 集成第三方 API

```python
import requests
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("API 集成服务")


@mcp.tool()
def call_external_api(endpoint: str, params: dict) -> str:
    """调用外部 API
    
    Args:
        endpoint: API 端点
        params: 请求参数
        
    Returns:
        API 响应
    """
    response = requests.post(
        f"https://api.example.com/{endpoint}",
        json=params,
        headers={"Authorization": f"Bearer {API_KEY}"}
    )
    return response.json()


if __name__ == "__main__":
    mcp.run()
```

## 常见问题解决

### 1. API Key 配置问题

#### 问题现象
```
Error: DASHSCOPE_API_KEY not found
```

#### 解决方案
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY

# 如果为空，设置环境变量
export DASHSCOPE_API_KEY="your_api_key_here"

# 或在 .env 文件中配置
echo 'DASHSCOPE_API_KEY=your_api_key_here' >> .env
```

### 2. Node.js 未安装

#### 问题现象
```
Error: npx: command not found
```

#### 解决方案
```bash
# macOS
brew install node

# Ubuntu
sudo apt-get install nodejs npm

# Windows
# 访问 https://nodejs.org/ 下载安装
```

### 3. MCP 服务启动失败

#### 问题现象
```
Error: MCP server failed to start
```

#### 解决方案
```bash
# 检查 Python 路径
which python3

# 检查 MCP Server 文件
ls code/mcp_servers/

# 手动测试 MCP Server
python3 code/mcp_servers/txt_counter.py
```

### 4. SSE 远程服务连接问题

#### 问题现象
```
Error: SSE connection failed
```

#### 解决方案
```bash
# 1. 检查网络连接
ping modelscope.cn

# 2. 验证 API Key
curl -H "Authorization: Bearer $MODELSCOPE_API_KEY" https://mcp.api-inference.modelscope.cn/health

# 3. 如果问题持续，禁用 SSE 服务
export ENABLE_SSE_MCP=false
```

### 5. 高德地图 MCP 问题

#### 问题现象
```
Error: AMAP_API_KEY not configured
```

#### 解决方案
```bash
# 配置高德 API Key
export AMAP_API_KEY="your_amap_api_key"

# 或在 .env 文件中添加
echo 'AMAP_API_KEY=your_amap_api_key' >> .env
```

## 性能调优

### 1. 超时配置

```python
# 在 main.py 中调整超时时间
dashscope.timeout = 120  # 增加到 120 秒
```

### 2. 模型选择

```python
# 选择更快的模型
llm_cfg = {
    "model": "qwen-turbo-latest",  # 更快，适合简单任务
    # "model": "qwen-max",         # 更强，适合复杂任务
}
```

### 3. 日志级别

```python
from loguru import logger

# 调整日志级别
logger.remove()
logger.add(sys.stdout, level="WARNING")  # 只显示警告和错误
```

## 调试技巧

### 1. 启用详细日志

```python
from loguru import logger

logger.add(
    "logs/debug.log",
    level="DEBUG",
    rotation="1 day"
)
```

### 2. 单独测试 MCP 服务

```bash
# 直接运行 MCP Server 进行测试
python3 code/mcp_servers/txt_counter.py
```

### 3. 查看 MCP 通信

```python
# 在 MCP Server 中添加调试日志
import logging
logging.basicConfig(level=logging.DEBUG)
```

---

*最后更新: 2026年2月24日*
*使用指南版本: v1.0*
*技术支持: build-your-own-ai项目团队*
