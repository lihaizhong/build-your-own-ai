# 钢铁缺陷检测系统 - 使用指南

## 环境准备

### 1. 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: 3.11+
- **内存**: 最小8GB，推荐16GB+
- **存储空间**: 最小5GB，推荐10GB+
- **GPU**: 可选，推荐NVIDIA GPU（CUDA支持）

### 2. 依赖安装

#### 方式一：使用uv（推荐）
```bash
# 进入项目目录
cd practice/13-CASE-钢铁缺陷检测-P1

# 创建虚拟环境
uv venv --python 3.11

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows

# 安装依赖
uv sync

# 验证安装
uv run python -c "import ultralytics; print(f'Ultralytics版本: {ultralytics.__version__}')"
```

#### 方式二：使用pip
```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows

# 安装依赖
pip install ultralytics opencv-python pillow matplotlib seaborn tqdm pandas numpy scikit-learn pyyaml

# 验证安装
python -c "from ultralytics import YOLO; print('安装成功')"
```

### 3. GPU支持检查

```bash
# 检查CUDA是否可用
python -c "import torch; print(f'CUDA可用: {torch.cuda.is_available()}')"

# 查看GPU信息
python -c "import torch; print(f'GPU名称: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"无GPU\"}')"
```

## 快速开始

### 一键训练（推荐）

使用项目提供的一键训练脚本：

```bash
# 确保在项目根目录
cd practice/13-CASE-钢铁缺陷检测-P1

# 运行一键训练脚本
./run_training.sh
```

脚本会自动执行以下步骤：
1. ✅ 检查虚拟环境和依赖
2. ✅ 转换数据格式（VOC → YOLO）
3. ✅ 划分训练集和验证集（80/20）
4. ✅ 启动YOLOv11训练

### 预期输出

```
================================================================================
钢铁缺陷检测 - YOLOv11训练流程
================================================================================

设置随机种子: 42
使用GPU: NVIDIA GeForce RTX 3060 (数量: 1)
CUDA版本: 11.8
实验目录: runs/detect/steel_defect_yolo11n_20260214_120000

================================================================================
分析数据集分布
================================================================================
数据集路径: /path/to/data/yolo_format
训练集: images/train
验证集: images/val
测试集: images/test
类别数量: 6
类别名称: ['rolled-in_scale', 'patches', 'scratches', 'inclusion', 'crazing', 'pitted_surface']

统计训练集类别分布: 100%|████████████████| 1120/1120
统计验证集类别分布: 100%|████████████████| 280/280

类别分布统计:
  rolled-in_scale (ID: 0): 493 个实例 (15.1%)
  patches (ID: 1): 679 个实例 (20.9%)
  scratches (ID: 2): 420 个实例 (12.9%)
  inclusion (ID: 3): 788 个实例 (24.2%)
  crazing (ID: 4): 537 个实例 (16.5%)
  pitted_surface (ID: 5): 339 个实例 (10.4%)
总实例数: 3256

================================================================================
开始训练YOLOv11模型
================================================================================
加载模型: yolo11n.pt

训练配置:
  epochs: 200
  imgsz: 200
  batch_size: 16
  optimizer: AdamW
  lr0: 0.001
  cos_lr: True

开始训练...
Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size
  1/200      2.1G      1.234      0.876      1.123        256        200
  2/200      2.1G      1.123      0.765      1.012        256        200
  ...

训练完成!

================================================================================
评估模型性能
================================================================================
评估结果:
  mAP50-95: 0.7234
  mAP50: 0.8521
  精确率: 0.8912
  召回率: 0.8634
  F1分数: 0.8771

================================================================================
训练流程完成!
实验目录: runs/detect/steel_defect_yolo11n_20260214_120000
================================================================================
```

## 数据集准备

### 1. 数据集结构

项目使用NEU-DET钢铁表面缺陷数据集，结构如下：

```
data/
├── train/                    # 训练集
│   ├── IMAGES/              # 1400张训练图像 (0.jpg-1399.jpg)
│   │   ├── 0.jpg
│   │   ├── 1.jpg
│   │   └── ...
│   └── ANNOTATIONS/         # 1400个XML标注文件
│       ├── 0.xml
│       ├── 1.xml
│       └── ...
├── test/                    # 测试集
│   └── IMAGES/              # 400张测试图像 (1400.jpg-1799.jpg)
│       ├── 1400.jpg
│       └── ...
└── yolo_format/             # YOLO格式数据（自动生成）
    ├── data.yaml           # 数据集配置文件
    ├── images/
    │   ├── train/          # 训练图像
    │   ├── val/            # 验证图像
    │   └── test/           # 测试图像
    └── labels/
        ├── train/          # 训练标注
        └── val/            # 验证标注
```

### 2. 数据格式转换

如果需要重新转换数据格式：

```bash
# 转换VOC格式到YOLO格式
.venv/bin/python code/convert_voc_to_yolo.py --data-root data --val-ratio 0.2

# 验证转换结果
.venv/bin/python code/convert_voc_to_yolo.py --verify
```

### 3. 数据配置文件

转换后会生成 `data/yolo_format/data.yaml`：

```yaml
# 钢铁缺陷检测数据集配置
path: /path/to/data/yolo_format  # 数据集根目录
train: images/train  # 训练集图像路径
val: images/val      # 验证集图像路径
test: images/test    # 测试集图像路径

nc: 6  # 类别数量
names: ['rolled-in_scale', 'patches', 'scratches', 'inclusion', 'crazing', 'pitted_surface']

imgsz: 200  # 图像尺寸
```

## 模型训练

### 1. 基础训练

使用默认配置训练：

```bash
.venv/bin/python code/train_yolov11.py --config config/training_config.yaml
```

### 2. 仅分析数据集

```bash
.venv/bin/python code/train_yolov11.py --config config/training_config.yaml --analyze-only
```

### 3. 仅评估模型

```bash
.venv/bin/python code/train_yolov11.py --config config/training_config.yaml --evaluate-only --model-path runs/detect/steel_defect_yolo11n_*/weights/best.pt
```

### 4. 训练参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `epochs` | 200 | 训练轮数 |
| `batch_size` | 16 | 批次大小 |
| `imgsz` | 200 | 输入图像尺寸 |
| `lr0` | 0.001 | 初始学习率 |
| `optimizer` | AdamW | 优化器类型 |
| `patience` | 50 | 早停耐心值 |

### 5. GPU训练设置

```yaml
# config/training_config.yaml
device: "0"      # 使用第一块GPU
# device: "0,1"  # 使用多块GPU
# device: "cpu"  # 使用CPU训练
```

## 模型评估

### 1. 评估指标

训练完成后会生成以下评估指标：

```python
评估结果:
  mAP50-95: 0.7234    # IoU从0.5到0.95的平均精度
  mAP50: 0.8521       # IoU=0.5时的平均精度
  精确率: 0.8912       # 正确检测的比例
  召回率: 0.8634       # 真实缺陷被检测出的比例
  F1分数: 0.8771       # 精确率和召回率的调和平均
```

### 2. 可视化结果

训练过程中会生成以下图表：
- **训练损失曲线**: `results.png`
- **混淆矩阵**: `confusion_matrix.png`
- **PR曲线**: `PR_curve.png`
- **F1曲线**: `F1_curve.png`
- **类别分布**: `class_distribution.png`

### 3. TensorBoard监控

```bash
# 启动TensorBoard
tensorboard --logdir runs/detect

# 在浏览器访问
# http://localhost:6006
```

## 模型导出

### 1. 导出为ONNX格式

```bash
.venv/bin/python code/train_yolov11.py --config config/training_config.yaml --export-only --export-format onnx
```

### 2. 导出为TensorRT格式

```bash
.venv/bin/python code/train_yolov11.py --config config/training_config.yaml --export-only --export-format engine
```

### 3. 支持的导出格式

| 格式 | 命令 | 适用场景 |
|------|------|----------|
| ONNX | `--export-format onnx` | 跨平台部署 |
| TensorRT | `--export-format engine` | NVIDIA GPU加速 |
| TorchScript | `--export-format torchscript` | PyTorch部署 |
| TFLite | `--export-format tflite` | 移动端部署 |

## 模型推理

### 1. 使用训练好的模型预测

```python
from ultralytics import YOLO

# 加载训练好的模型
model = YOLO("runs/detect/steel_defect_yolo11n_*/weights/best.pt")

# 单张图像预测
results = model.predict("data/test/IMAGES/1400.jpg", conf=0.25)

# 可视化结果
results[0].show()

# 获取检测信息
boxes = results[0].boxes
print(f"检测到 {len(boxes)} 个缺陷")
for box in boxes:
    cls_id = int(box.cls[0])
    conf = float(box.conf[0])
    print(f"- 类别: {cls_id}, 置信度: {conf:.3f}")
```

### 2. 批量预测

```bash
# 批量预测测试集
.venv/bin/python -c "
from ultralytics import YOLO
model = YOLO('runs/detect/steel_defect_yolo11n_*/weights/best.pt')
model.predict('data/test/IMAGES/', save=True, conf=0.25)
"
```

### 3. 推理参数

```python
results = model.predict(
    source="path/to/images",  # 图像路径
    conf=0.25,                # 置信度阈值
    iou=0.45,                 # NMS IoU阈值
    max_det=300,              # 最大检测数量
    device="cuda:0",          # 推理设备
    save=True,                # 保存结果
    show=False,               # 显示结果
)
```

## 常见问题解决

### 1. 内存不足错误

**问题现象**:
```
RuntimeError: CUDA out of memory
```

**解决方案**:
```yaml
# 修改 config/training_config.yaml
batch_size: 8  # 减小批次大小
workers: 2     # 减少数据加载线程
```

### 2. 训练不收敛

**问题现象**:
```
损失不下降或波动较大
```

**解决方案**:
```yaml
# 调整学习率
lr0: 0.0005  # 减小学习率

# 增加数据增强
hsv_v: 0.5   # 增加明度变化
scale: 0.7   # 增加缩放范围
```

### 3. 小目标检测效果差

**问题现象**:
```
小缺陷检测不到或检测不准确
```

**解决方案**:
```yaml
# 调整损失函数权重
box: 10.0    # 提高边界框损失权重
dfl: 2.0     # 提高DFL损失权重

# 确保使用原尺寸
imgsz: 200   # 保持200×200原尺寸
```

### 4. 数据集转换失败

**问题现象**:
```
XML解析错误或标注缺失
```

**解决方案**:
```bash
# 检查数据集完整性
.venv/bin/python code/convert_voc_to_yolo.py --verify

# 查看详细错误信息
.venv/bin/python code/convert_voc_to_yolo.py --data-root data --verbose
```

### 5. GPU不可用

**问题现象**:
```
CUDA not available
```

**解决方案**:
```bash
# 检查CUDA安装
python -c "import torch; print(torch.version.cuda)"

# 使用CPU训练
device: "cpu"  # 在配置文件中设置
```

## 性能调优

### 1. 训练速度优化

```yaml
# 增加数据加载速度
workers: 8         # 增加数据加载线程
cache: "ram"       # 缓存图像到内存

# 使用混合精度训练
amp: true          # 自动混合精度
```

### 2. 推理速度优化

```python
# 使用ONNX加速
from ultralytics import YOLO

model = YOLO("model.onnx")
results = model.predict(image, device="cuda:0")

# 使用TensorRT加速
model = YOLO("model.engine")
results = model.predict(image)
```

### 3. 模型精度优化

```yaml
# 使用更大的模型
model: "yolo11s.pt"  # 从nano升级到small

# 增加训练轮数
epochs: 300

# 调整学习率调度
cos_lr: true
warmup_epochs: 5
```

## 监控和调试

### 1. 训练监控

```bash
# 实时查看训练日志
tail -f runs/detect/steel_defect_yolo11n_*/training_log.csv

# 查看GPU使用情况
watch -n 1 nvidia-smi
```

### 2. 错误处理和日志

```python
import logging

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('training.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# 使用日志
try:
    trainer.train_model()
except Exception as e:
    logger.error(f"训练失败: {e}")
```

---

*最后更新: 2026年2月14日*
*使用指南版本: v1.0*
*技术支持: build-your-own-ai项目团队*
