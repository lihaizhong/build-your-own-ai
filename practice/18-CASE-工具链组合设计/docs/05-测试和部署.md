# LangChain å·¥å…·é“¾ç»„åˆè®¾è®¡ - æµ‹è¯•å’Œéƒ¨ç½²

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•æ¦‚è§ˆ

æœ¬é¡¹ç›®é‡‡ç”¨å¤šå±‚æ¬¡æµ‹è¯•ç­–ç•¥ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€å·¥å…·æµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œç¡®ä¿å·¥å…·åŠŸèƒ½çš„æ­£ç¡®æ€§å’Œ Agent çš„å¯é æ€§ã€‚

```mermaid
graph TB
    A[æµ‹è¯•ç­–ç•¥] --> B[å•å…ƒæµ‹è¯•]
    A --> C[å·¥å…·æµ‹è¯•]
    A --> D[é›†æˆæµ‹è¯•]
    A --> E[æ¼”ç¤ºæµ‹è¯•]
    
    B --> B1[å·¥å…·æ–¹æ³•æµ‹è¯•]
    B --> B2[è¾“å…¥è§£ææµ‹è¯•]
    B --> B3[è¾“å‡ºæ ¼å¼æµ‹è¯•]
    
    C --> C1[6ä¸ªå·¥å…·åŠŸèƒ½æµ‹è¯•]
    C --> C2[è¾¹ç•Œæ¡ä»¶æµ‹è¯•]
    C --> C3[é”™è¯¯å¤„ç†æµ‹è¯•]
    
    D --> D1[Agent å·¥å…·è°ƒç”¨æµ‹è¯•]
    D --> D2[å¤šè½®å¯¹è¯æµ‹è¯•]
    
    E --> E1[æ¼”ç¤ºæ¨¡å¼éªŒè¯]
    E --> E2[äº¤äº’æ¨¡å¼éªŒè¯]
```

## å•å…ƒæµ‹è¯•

### 1. æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â””â”€â”€ test_tool_chain.py    # å·¥å…·é“¾æµ‹è¯•æ–‡ä»¶
```

### 2. æµ‹è¯•é…ç½®

```python
"""
å·¥å…·é“¾æµ‹è¯•æ–‡ä»¶
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from tools import (
    TextAnalysisTool,
    DataConversionTool,
    TextProcessingTool,
    NetworkDiagnosisTool,
    ConfigAnalysisTool,
    LogAnalysisTool,
)
```

### 3. å·¥å…·æµ‹è¯•

#### æ–‡æœ¬åˆ†æå·¥å…·æµ‹è¯•
```python
def test_text_analysis():
    """æµ‹è¯•æ–‡æœ¬åˆ†æå·¥å…·"""
    tool = TextAnalysisTool()
    
    # åŸºç¡€åŠŸèƒ½æµ‹è¯•
    result = tool.run("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬")
    assert "å­—ç¬¦æ€»æ•°" in result
    assert "æƒ…æ„Ÿå€¾å‘" in result
    
    # ç©ºè¾“å…¥æµ‹è¯•
    result = tool.run("")
    assert "é”™è¯¯" in result
    
    print("âœ… æ–‡æœ¬åˆ†æå·¥å…·æµ‹è¯•é€šè¿‡")


def test_text_analysis_keywords():
    """æµ‹è¯•å…³é”®è¯æå–"""
    tool = TextAnalysisTool()
    
    text = "ç½‘ç»œå·¥ç¨‹å¸ˆéœ€è¦æŒæ¡è·¯ç”±å™¨ã€äº¤æ¢æœºå’Œé˜²ç«å¢™çš„é…ç½®"
    result = tool.run(text)
    assert "å…³é”®è¯" in result
    
    print("âœ… å…³é”®è¯æå–æµ‹è¯•é€šè¿‡")
```

#### æ•°æ®è½¬æ¢å·¥å…·æµ‹è¯•
```python
def test_data_conversion():
    """æµ‹è¯•æ•°æ®è½¬æ¢å·¥å…·"""
    tool = DataConversionTool()
    
    # JSON æ ¼å¼åŒ–æµ‹è¯•
    result = tool.run('format|{"key": "value"}')
    assert "key" in result
    
    # JSON è½¬ YAML æµ‹è¯•
    result = tool.run('json2yaml|{"name": "test"}')
    assert "name:" in result
    
    # JSON éªŒè¯æµ‹è¯•
    result = tool.run('validate|{"valid": true}')
    assert "æ­£ç¡®" in result
    
    print("âœ… æ•°æ®è½¬æ¢å·¥å…·æµ‹è¯•é€šè¿‡")


def test_data_conversion_errors():
    """æµ‹è¯•é”™è¯¯å¤„ç†"""
    tool = DataConversionTool()
    
    # æ— æ•ˆ JSON
    result = tool.run('format|{invalid json}')
    assert "é”™è¯¯" in result
    
    # ä¸æ”¯æŒçš„è½¬æ¢ç±»å‹
    result = tool.run('unknown|data')
    assert "ä¸æ”¯æŒ" in result
    
    print("âœ… é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡")
```

#### æ–‡æœ¬å¤„ç†å·¥å…·æµ‹è¯•
```python
def test_text_processing():
    """æµ‹è¯•æ–‡æœ¬å¤„ç†å·¥å…·"""
    tool = TextProcessingTool()
    
    # IP æå–æµ‹è¯•
    result = tool.run('extract_ip|æœåŠ¡å™¨ IPï¼š192.168.1.1 å’Œ 10.0.0.1')
    assert "192.168.1.1" in result
    assert "10.0.0.1" in result
    
    # æ–‡æœ¬æ¸…æ´—æµ‹è¯•
    result = tool.run('clean|  å¤šä½™  ç©ºç™½  ')
    assert "å¤šä½™ ç©ºç™½" in result
    
    print("âœ… æ–‡æœ¬å¤„ç†å·¥å…·æµ‹è¯•é€šè¿‡")


def test_text_processing_regex():
    """æµ‹è¯•æ­£åˆ™åŒ¹é…"""
    tool = TextProcessingTool()
    
    # æ—¥æœŸåŒ¹é…
    result = tool.run('regex|\d{4}-\d{2}-\d{2}|æ—¥æœŸï¼š2024-01-15')
    assert "2024-01-15" in result
    
    print("âœ… æ­£åˆ™åŒ¹é…æµ‹è¯•é€šè¿‡")
```

#### ç½‘ç»œè¯Šæ–­å·¥å…·æµ‹è¯•
```python
def test_network_diagnosis():
    """æµ‹è¯•ç½‘ç»œè¯Šæ–­å·¥å…·"""
    tool = NetworkDiagnosisTool()
    
    # Ping æµ‹è¯•
    result = tool.run('ping|www.baidu.com')
    assert "Ping" in result
    
    # DNS æµ‹è¯•
    result = tool.run('dns|www.google.com')
    assert "DNS" in result
    
    print("âœ… ç½‘ç»œè¯Šæ–­å·¥å…·æµ‹è¯•é€šè¿‡")


def test_network_diagnosis_port():
    """æµ‹è¯•ç«¯å£æ£€æµ‹"""
    tool = NetworkDiagnosisTool()
    
    # ç«¯å£æ£€æµ‹
    result = tool.run('port|192.168.1.1|80')
    assert "ç«¯å£" in result or "PORT" in result
    
    # æ— æ•ˆç«¯å£
    result = tool.run('port|192.168.1.1|99999')
    assert "é”™è¯¯" in result
    
    print("âœ… ç«¯å£æ£€æµ‹æµ‹è¯•é€šè¿‡")
```

#### é…ç½®åˆ†æå·¥å…·æµ‹è¯•
```python
def test_config_analysis():
    """æµ‹è¯•é…ç½®åˆ†æå·¥å…·"""
    tool = ConfigAnalysisTool()
    
    # é…ç½®è§£ææµ‹è¯•
    result = tool.run('parse|hostname TestRouter')
    assert "è®¾å¤‡åç§°" in result or "TestRouter" in result
    
    print("âœ… é…ç½®åˆ†æå·¥å…·æµ‹è¯•é€šè¿‡")


def test_config_security():
    """æµ‹è¯•å®‰å…¨æ£€æŸ¥"""
    tool = ConfigAnalysisTool()
    
    config = """
hostname Router1
!
line vty 0 4
 transport input ssh
!
service password-encryption
!
"""
    result = tool.run(f'security|{config}')
    assert "å®‰å…¨" in result
    
    print("âœ… å®‰å…¨æ£€æŸ¥æµ‹è¯•é€šè¿‡")
```

#### æ—¥å¿—åˆ†æå·¥å…·æµ‹è¯•
```python
def test_log_analysis():
    """æµ‹è¯•æ—¥å¿—åˆ†æå·¥å…·"""
    tool = LogAnalysisTool()
    
    # æ—¥å¿—æ‘˜è¦æµ‹è¯•
    result = tool.run('summary|2024-01-15 ERROR Test message')
    assert "æ—¥å¿—" in result
    
    print("âœ… æ—¥å¿—åˆ†æå·¥å…·æµ‹è¯•é€šè¿‡")


def test_log_errors():
    """æµ‹è¯•é”™è¯¯æå–"""
    tool = LogAnalysisTool()
    
    logs = """
2024-01-15 ERROR Connection failed
2024-01-15 INFO Backup completed
2024-01-15 CRITICAL Disk full
"""
    result = tool.run(f'errors|{logs}')
    assert "ERROR" in result or "CRITICAL" in result
    
    print("âœ… é”™è¯¯æå–æµ‹è¯•é€šè¿‡")
```

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python code/main.py --mode test

# æˆ–ä½¿ç”¨ pytest
pytest tests/test_tool_chain.py -v

# è¿è¡Œå•ä¸ªæµ‹è¯•
python -c "from tests.test_tool_chain import *; test_text_analysis()"
```

## æµ‹è¯•æ¨¡å¼

### 1. æµ‹è¯•æ¨¡å¼å®ç°

```python
def test_mode():
    """æµ‹è¯•æ¨¡å¼ - è¿è¡Œå•å…ƒæµ‹è¯•"""
    print_banner()
    print("\nğŸ§ª æµ‹è¯•æ¨¡å¼ - è¿è¡Œå•å…ƒæµ‹è¯•\n")
    
    test_file = PROJECT_ROOT / "tests" / "test_tool_chain.py"
    
    if test_file.exists():
        import subprocess
        result = subprocess.run(
            [sys.executable, "-m", "pytest", str(test_file), "-v"],
            cwd=str(PROJECT_ROOT)
        )
    else:
        print("âŒ æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...")
        create_test_file()
        print("âœ… æµ‹è¯•æ–‡ä»¶å·²åˆ›å»ºï¼Œè¯·é‡æ–°è¿è¡Œ")
```

### 2. æµ‹è¯•æ–‡ä»¶ç”Ÿæˆ

```python
def create_test_file():
    """åˆ›å»ºæµ‹è¯•æ–‡ä»¶"""
    test_content = '''"""
å·¥å…·é“¾æµ‹è¯•æ–‡ä»¶
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from tools import (
    TextAnalysisTool,
    DataConversionTool,
    TextProcessingTool,
    NetworkDiagnosisTool,
    ConfigAnalysisTool,
    LogAnalysisTool,
)


def test_text_analysis():
    """æµ‹è¯•æ–‡æœ¬åˆ†æå·¥å…·"""
    tool = TextAnalysisTool()
    result = tool.run("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬")
    assert "å­—ç¬¦æ€»æ•°" in result
    print("âœ… æ–‡æœ¬åˆ†æå·¥å…·æµ‹è¯•é€šè¿‡")


def test_data_conversion():
    """æµ‹è¯•æ•°æ®è½¬æ¢å·¥å…·"""
    tool = DataConversionTool()
    result = tool.run(\'format|{"key": "value"}\')
    assert "key" in result
    print("âœ… æ•°æ®è½¬æ¢å·¥å…·æµ‹è¯•é€šè¿‡")


# ... æ›´å¤šæµ‹è¯•å‡½æ•°


if __name__ == "__main__":
    test_text_analysis()
    test_data_conversion()
    test_text_processing()
    test_network_diagnosis()
    test_config_analysis()
    test_log_analysis()
    print("\\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
'''
    
    test_file = PROJECT_ROOT / "tests" / "test_tool_chain.py"
    test_file.write_text(test_content, encoding="utf-8")
```

## éƒ¨ç½²ç­–ç•¥

### 1. æœ¬åœ°è¿è¡Œ

#### ç¯å¢ƒå‡†å¤‡
```bash
# å…‹éš†é¡¹ç›®
cd /path/to/build-your-own-ai

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# é…ç½®ç¯å¢ƒå˜é‡
echo "DASHSCOPE_API_KEY=your_key" > .env
```

#### è¿è¡Œç¨‹åº
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd practice/18-CASE-å·¥å…·é“¾ç»„åˆè®¾è®¡

# äº¤äº’æ¨¡å¼
python code/main.py --mode interactive

# æ¼”ç¤ºæ¨¡å¼
python code/main.py --mode demo

# æµ‹è¯•æ¨¡å¼
python code/main.py --mode test
```

### 2. Docker éƒ¨ç½²

#### Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY pyproject.toml .
RUN pip install --no-cache-dir langchain langchain-community langchain-openai loguru python-dotenv

# å¤åˆ¶ä»£ç 
COPY code/ ./code/
COPY tests/ ./tests/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1

# è¿è¡Œ
CMD ["python", "code/main.py", "--mode", "interactive"]
```

#### æ„å»ºå’Œè¿è¡Œ
```bash
# æ„å»ºé•œåƒ
docker build -t tool-chain-agent .

# è¿è¡Œå®¹å™¨
docker run -it \
  -e DASHSCOPE_API_KEY=your_key \
  tool-chain-agent
```

### 3. Docker Compose éƒ¨ç½²

#### docker-compose.yml
```yaml
version: '3.8'

services:
  tool-chain-agent:
    build: .
    environment:
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    stdin_open: true
    tty: true
```

#### è¿è¡Œ
```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# è¿›å…¥äº¤äº’æ¨¡å¼
docker-compose exec tool-chain-agent python code/main.py --mode interactive
```

### 4. Web API éƒ¨ç½²

#### Flask åº”ç”¨ç¤ºä¾‹

åˆ›å»º `api_server.py`ï¼š

```python
"""
å·¥å…·é“¾ç»„åˆ Web API æœåŠ¡
"""
from flask import Flask, request, jsonify
from flask_cors import CORS
from agents import NetworkEngineerAgent

app = Flask(__name__)
CORS(app)

# åˆå§‹åŒ– Agent
agent = NetworkEngineerAgent(verbose=False)


@app.route("/health", methods=["GET"])
def health():
    """å¥åº·æ£€æŸ¥"""
    return jsonify({"status": "healthy"})


@app.route("/chat", methods=["POST"])
def chat():
    """å¤„ç†å¯¹è¯è¯·æ±‚"""
    data = request.json
    question = data.get("question")
    
    if not question:
        return jsonify({"error": "é—®é¢˜ä¸èƒ½ä¸ºç©º"}), 400
    
    try:
        response = agent.chat(question)
        return jsonify({
            "response": response,
            "success": True
        })
    except Exception as e:
        return jsonify({
            "error": str(e),
            "success": False
        }), 500


@app.route("/tools", methods=["GET"])
def tools():
    """è·å–å·¥å…·åˆ—è¡¨"""
    return jsonify({
        "tools": agent.get_tool_names(),
        "descriptions": agent.get_tool_descriptions()
    })


@app.route("/clear", methods=["POST"])
def clear():
    """æ¸…é™¤å¯¹è¯è®°å¿†"""
    agent.clear_memory()
    return jsonify({"message": "å¯¹è¯è®°å¿†å·²æ¸…é™¤"})


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
```

#### è¿è¡Œ API æœåŠ¡
```bash
# å®‰è£… Flask
pip install flask flask-cors

# è¿è¡ŒæœåŠ¡
python api_server.py
```

#### API ä½¿ç”¨ç¤ºä¾‹
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:5000/health

# å‘é€é—®é¢˜
curl -X POST http://localhost:5000/chat \
  -H "Content-Type: application/json" \
  -d '{"question": "å¸®æˆ‘ ping ä¸€ä¸‹ www.baidu.com"}'

# è·å–å·¥å…·åˆ—è¡¨
curl http://localhost:5000/tools

# æ¸…é™¤è®°å¿†
curl -X POST http://localhost:5000/clear
```

## CI/CD æµæ°´çº¿

### GitHub Actions é…ç½®

åˆ›å»º `.github/workflows/ci.yml`ï¼š

```yaml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install langchain langchain-community langchain-openai loguru python-dotenv pytest
    
    - name: Run tests
      run: |
        cd practice/18-CASE-å·¥å…·é“¾ç»„åˆè®¾è®¡
        pytest tests/ -v

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linters
      run: |
        pip install ruff mypy
    
    - name: Run Ruff
      run: ruff check practice/18-CASE-å·¥å…·é“¾ç»„åˆè®¾è®¡/code/
    
    - name: Run MyPy
      run: mypy practice/18-CASE-å·¥å…·é“¾ç»„åˆè®¾è®¡/code/
```

## ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—é…ç½®

```python
from loguru import logger
import sys

# é…ç½®æ—¥å¿—
logger.remove()
logger.add(
    sys.stdout,
    format="<green>{time:HH:mm:ss}</green> | <level>{level: <8}</level> | <level>{message}</level>",
    level="INFO"
)
logger.add(
    "logs/tool_chain.log",
    rotation="1 day",
    retention="7 days",
    level="DEBUG"
)
```

### 2. æ€§èƒ½ç›‘æ§

```python
import time
from functools import wraps

def timing_decorator(func):
    """è®¡æ—¶è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - start
        logger.info(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’")
        return result
    return wrapper


class NetworkEngineerAgent:
    @timing_decorator
    def run(self, query: str) -> str:
        # ...
```

### 3. å¥åº·æ£€æŸ¥

```python
def health_check(agent) -> dict:
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "components": {
            "llm": "ok" if agent.llm else "error",
            "tools": len(agent.tools),
            "memory_size": len(agent.memory)
        }
    }
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å“åº”æ—¶é—´ä¼˜åŒ–

- ä½¿ç”¨æ›´å¿«çš„ LLM æ¨¡å‹ï¼ˆqwen-turbo / gpt-4o-miniï¼‰
- é™åˆ¶å¯¹è¯å†å²é•¿åº¦
- ç¼“å­˜å¸¸ç”¨å·¥å…·ç»“æœ

### 2. å‡†ç¡®æ€§ä¼˜åŒ–

- æ¸…æ™°çš„å·¥å…·æè¿°
- è¯¦ç»†çš„ç³»ç»Ÿæç¤ºè¯
- ä¼˜åŒ–è¾“å…¥æ ¼å¼è¯´æ˜

### 3. å¯æ‰©å±•æ€§ä¼˜åŒ–

- æ¨¡å—åŒ–å·¥å…·è®¾è®¡
- ç»Ÿä¸€çš„æ¥å£è§„èŒƒ
- çµæ´»çš„é…ç½®ç®¡ç†

---

*æœ€åæ›´æ–°: 2026å¹´2æœˆ17æ—¥*
*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*ç»´æŠ¤å›¢é˜Ÿ: build-your-own-aié¡¹ç›®å›¢é˜Ÿ*
