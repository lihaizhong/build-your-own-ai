# 大模型原理与API使用 - 使用指南

## 环境准备

### 1. 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: 3.11+
- **内存**: 最小4GB，推荐8GB+
- **网络**: 需要访问阿里云DashScope API

### 2. API密钥获取

#### DashScope API Key
1. 访问 [阿里云DashScope控制台](https://dashscope.console.aliyun.com/)
2. 登录阿里云账号
3. 开通DashScope服务
4. 创建API Key

#### 高德API Key（可选，用于天气查询）
1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册开发者账号
3. 创建应用并获取Key

### 3. 环境配置

#### 方式一：使用项目根目录环境（推荐）
```bash
# 进入项目根目录
cd /path/to/build-your-own-ai

# 安装依赖（使用uv包管理器）
uv sync

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

#### 方式二：配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，添加API密钥
# DASHSCOPE_API_KEY=your_dashscope_api_key
# AMAP_API_KEY=your_amap_api_key
```

### 4. 验证环境
```bash
# 验证Python版本
python --version  # 应显示 Python 3.11+

# 验证dashscope安装
python -c "import dashscope; print('dashscope安装成功')"
```

## 快速开始

### 1. 运行第一个示例

#### 情感分析示例
```bash
# 进入项目目录
cd practice/01-CASE-大模型原理与API使用

# 运行情感分析示例
uv run python code/1-情感分析-Qwen.py
```

#### 预期输出
```
================================================================================
情感分析示例 - 使用DeepSeek模型
================================================================================

用户评论: 这个产品质量很好，性价比很高，非常满意！

回复: 正向情感

用户评论: 服务态度很差，不会再来了

回复: 负向情感

================================================================================
分析完成
================================================================================
```

### 2. 运行Function Calling示例

#### 天气查询示例
```bash
# 运行天气查询示例（需要配置高德API Key）
uv run python code/2-天气Function-Qwen.py
```

#### 预期输出
```
================================================================================
天气查询示例 - Function Calling
================================================================================

用户: 北京今天天气怎么样？

[模型决定调用函数]
函数名: get_current_weather
参数: {"location": "北京"}

[执行函数]
调用高德API获取北京天气...

[整合结果]
北京今天天气晴朗，气温25°C，空气质量良好。

================================================================================
查询完成
================================================================================
```

## 示例运行

### 1. 情感分析 (1-情感分析-Qwen.py)

#### 功能说明
使用大模型对用户评论进行情感分析，判断正面或负面情感。

#### 运行方式
```bash
uv run python code/1-情感分析-Qwen.py
```

#### 代码结构
```python
# 1. 加载环境变量
load_dotenv()

# 2. 定义API调用函数
def get_response(messages):
    return dashscope.Generation.call(
        model="deepseek-v3",
        messages=messages,
        result_format="message"
    )

# 3. 设置系统提示词
system_prompt = "你是一个情感分析助手，请判断用户评论的情感倾向..."

# 4. 发送用户评论
messages = [
    {"role": "system", "content": system_prompt},
    {"role": "user", "content": user_comment}
]

# 5. 获取并显示结果
response = get_response(messages)
print(response.output.choices[0].message.content)
```

### 2. 天气查询 (2-天气Function-Qwen.py)

#### 功能说明
通过Function Calling调用高德API获取实时天气信息。

#### 运行方式
```bash
uv run python code/2-天气Function-Qwen.py
```

#### 关键步骤
```python
# 1. 定义函数
functions = [{
    "name": "get_current_weather",
    "description": "获取指定地区的当前天气状况",
    "parameters": {
        "type": "object",
        "properties": {
            "location": {"type": "string", "description": "城市名称"}
        },
        "required": ["location"]
    }
}]

# 2. 首次调用
response = dashscope.Generation.call(
    model="qwen-max",
    messages=messages,
    functions=functions
)

# 3. 检查是否需要调用函数
message = response.output.choices[0].message
if message.function_call:
    # 执行函数
    result = get_current_weather(location)
    
    # 整合结果
    messages.append({
        "role": "function",
        "name": "get_current_weather",
        "content": str(result)
    })
    
    # 第二次调用获取最终回复
    response = get_response(messages)
```

### 3. 表格提取 (3-表格提取-Qwen.py)

#### 功能说明
使用视觉大模型从图片中提取表格数据，输出JSON格式。

#### 运行方式
```bash
uv run python code/3-表格提取-Qwen.py
```

#### 代码示例
```python
# 多模态消息格式
messages = [
    {
        "role": "user",
        "content": [
            {"image": "https://example.com/table.png"},
            {"text": "请提取图片中的表格数据，以JSON格式输出"}
        ]
    }
]

# 调用视觉模型
response = dashscope.MultiModalConversation.call(
    model="qwen-vl-plus",
    messages=messages
)

# 输出结果
print(response.output.choices[0].message.content)
```

### 4. 运维事件处置 (4-运维事件处置-Qwen.py)

#### 功能说明
模拟运维场景，通过多轮工具调用处理告警事件。

#### 运行方式
```bash
uv run python code/4-运维事件处置-Qwen.py
```

#### 多轮调用模式
```python
# 工具调用循环
while True:
    response = get_response(messages)
    message = response.output.choices[0].message
    messages.append(message.to_dict())
    
    finish_reason = response.output.choices[0].finish_reason
    
    if finish_reason == 'stop':
        break
    
    # 处理工具调用
    if message.tool_calls:
        for tool_call in message.tool_calls:
            # 执行工具
            result = execute_tool(tool_call)
            
            # 添加工具响应
            messages.append({
                "role": "tool",
                "content": str(result),
                "name": tool_call['function']['name'],
                "tool_call_id": tool_call['id']
            })

print(message.content)
```

### 5. DeepSeek调用 (5-情感分析-Deepseek-阿里代理.py)

#### 功能说明
使用DeepSeek模型通过阿里云代理进行API调用。

#### 运行方式
```bash
uv run python code/5-情感分析-Deepseek-阿里代理.py
```

### 6. 联网搜索 (6-联网搜索.py)

#### 功能说明
启用联网搜索功能，获取实时信息。

#### 运行方式
```bash
uv run python code/6-联网搜索.py
```

#### 代码示例
```python
response = dashscope.Generation.call(
    model="qwen-plus",
    messages=messages,
    result_format="message",
    search_options={
        "enable_search": True
    }
)
```

### 7. 陪伴机器人 (陪伴机器人.py)

#### 功能说明
情感陪伴机器人，结合时间和上下文进行智能对话。

#### 运行方式
```bash
uv run python code/陪伴机器人.py
```

#### 交互示例
```
================================================================================
情感陪伴机器人
================================================================================

机器人: 早上好！新的一天开始了，有什么可以帮你的吗？

用户: 我今天有点累

机器人: 听起来你工作很辛苦。需要聊聊是什么让你感到疲惫吗？

用户: 项目太多了，做不完

机器人: 确实，面对多个项目会让人感到压力。不如我们一起看看如何合理安排？
```

## 常见问题解决

### 1. API密钥问题

#### 问题现象
```
InvalidApiKey: Invalid API-KEY provided
```

#### 解决方案
```bash
# 1. 检查环境变量是否设置
echo $DASHSCOPE_API_KEY

# 2. 确保.env文件存在
cat .env

# 3. 验证API Key格式（应为32位字符串）
```

### 2. 网络连接问题

#### 问题现象
```
ConnectionError: Unable to connect to DashScope API
```

#### 解决方案
```python
# 添加超时和重试
import requests
from requests.adapters import HTTPAdapter

session = requests.Session()
session.mount('https://', HTTPAdapter(max_retries=3))

# 或使用代理
import os
os.environ['HTTP_PROXY'] = 'http://proxy:port'
os.environ['HTTPS_PROXY'] = 'http://proxy:port'
```

### 3. 速率限制问题

#### 问题现象
```
RateLimitError: Rate limit exceeded
```

#### 解决方案
```python
import time

def call_with_retry(messages, max_retries=3):
    for i in range(max_retries):
        try:
            return dashscope.Generation.call(
                model="qwen-max",
                messages=messages
            )
        except RateLimitError:
            wait_time = (i + 1) * 2
            print(f"速率限制，等待{wait_time}秒后重试...")
            time.sleep(wait_time)
    raise Exception("超过最大重试次数")
```

### 4. 模型不可用

#### 问题现象
```
ModelNotFoundError: Model 'xxx' not found
```

#### 解决方案
```python
# 检查模型名称是否正确
AVAILABLE_MODELS = [
    "deepseek-v3",
    "deepseek-r1",
    "qwen-max",
    "qwen-turbo",
    "qwen-plus",
    "qwen-vl-plus"
]

# 确保模型名称在列表中
```

### 5. Function Calling无响应

#### 问题现象
模型不调用函数，直接返回文本回复。

#### 解决方案
```python
# 1. 确保使用支持Function Calling的模型
model = "qwen-max"  # 或 qwen-plus

# 2. 确保问题描述需要函数调用
user_message = "北京今天天气怎么样？"  # 明确需要天气信息

# 3. 检查函数定义是否正确
functions = [{
    "name": "get_weather",
    "description": "获取城市天气信息",  # 描述要清晰
    "parameters": {
        "type": "object",
        "properties": {
            "city": {"type": "string", "description": "城市名称"}
        },
        "required": ["city"]
    }
}]
```

## 性能优化

### 1. 减少Token消耗

```python
# 精简系统提示词
system_prompt = "你是情感分析助手，判断情感倾向：正向/负向/中性"

# 控制输出长度
response = dashscope.Generation.call(
    model="qwen-turbo",
    messages=messages,
    max_tokens=100  # 限制输出长度
)
```

### 2. 选择合适的模型

| 场景 | 推荐模型 | 原因 |
|------|----------|------|
| 简单问答 | qwen-turbo | 速度快，成本低 |
| 复杂推理 | qwen-max | 能力强 |
| Function Calling | qwen-max | 支持完善 |
| 视觉任务 | qwen-vl-plus | 多模态能力 |
| 联网搜索 | qwen-plus | 支持搜索 |

### 3. 批量处理

```python
# 批量处理多条评论
comments = ["评论1", "评论2", "评论3"]

results = []
for comment in comments:
    response = get_response([
        {"role": "system", "content": "情感分析"},
        {"role": "user", "content": comment}
    ])
    results.append(response.output.choices[0].message.content)
```

## 调试技巧

### 1. 日志记录

```python
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

def call_api(messages):
    logger.debug(f"发送消息: {messages}")
    response = dashscope.Generation.call(
        model="qwen-max",
        messages=messages
    )
    logger.debug(f"收到响应: {response}")
    return response
```

### 2. 响应检查

```python
def check_response(response):
    print(f"状态码: {response.status_code}")
    print(f"完成原因: {response.output.choices[0].finish_reason}")
    print(f"Token使用: {response.usage}")
    
    if response.status_code != 200:
        print(f"错误信息: {response.message}")
```

---

*最后更新: 2026年2月21日*
*使用指南版本: v1.0*
*技术支持: build-your-own-ai项目团队*
