# 销售数据业务助手 - 使用指南

## 环境准备

### 1. 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: 3.11+
- **内存**: 最小4GB，推荐8GB+
- **存储空间**: 最小1GB，推荐5GB+

### 2. 依赖安装

#### 方式一：使用uv（推荐）
```bash
# 在项目根目录
uv sync

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows
```

#### 方式二：使用pip
```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac

# 安装依赖
pip install -r requirements.txt
```

### 3. 环境变量配置

#### 复制环境变量模板
```bash
# 在项目根目录
cp .env.example .env
```

#### 配置必要的环境变量
```bash
# 编辑 .env 文件
# 必需配置
DASHSCOPE_API_KEY=your_dashscope_api_key_here

# 数据库配置（二选一）
# SQLite（推荐用于开发测试）
DATABASE_URL=sqlite:///path/to/sales.db

# MySQL（推荐用于生产环境）
DATABASE_URL=mysql+mysqlconnector://user:password@host:3306/sales_db
```

### 4. 获取 DashScope API Key

1. 访问 [阿里云 DashScope 控制台](https://dashscope.console.aliyun.com/)
2. 登录阿里云账号
3. 在 API-KEY 管理页面创建新的 API Key
4. 将 API Key 配置到 `.env` 文件中

## 快速开始

### 1. 数据初始化

#### 初始化示例数据（SQLite）
```bash
# 进入项目目录
cd practice/19-CASE-业务助手

# 初始化 SQLite 数据库（默认）
python code/init_db.py

# 或指定参数
python code/init_db.py --start-date 2024-01-01 --end-date 2024-12-31 --num-records 3000
```

#### 预期输出
```
2024-02-22 10:00:00 | INFO | 生成示例数据: 2024-01-01 到 2024-12-31, 2000 条记录
2024-02-22 10:00:01 | INFO | 生成完成，共 2000 条记录
2024-02-22 10:00:01 | INFO | CSV 文件已保存: data/sales_sample.csv
2024-02-22 10:00:01 | INFO | SQLite 数据库初始化完成: data/sales.db

数据库文件: data/sales.db
设置环境变量:
  export DATABASE_URL="sqlite:///path/to/data/sales.db"
```

#### 初始化 MySQL 数据库
```bash
# 先配置 MySQL 连接信息
export DATABASE_URL="mysql+mysqlconnector://user:password@host:3306/sales_db"

# 初始化 MySQL 数据库
python code/init_db.py --db-type mysql
```

### 2. 设置数据库连接

```bash
# SQLite（使用刚才生成的数据库）
export DATABASE_URL="sqlite:///$(pwd)/data/sales.db"

# MySQL
export DATABASE_URL="mysql+mysqlconnector://user:password@localhost:3306/sales_db"
```

### 3. 启动业务助手

#### Web 界面模式（默认）
```bash
python code/main.py
```

访问浏览器打开显示的地址（通常是 `http://127.0.0.1:7860`）

#### 终端交互模式
```bash
python code/main.py --mode tui
```

## Web 界面模式

### 启动服务

```bash
python code/main.py
```

### 界面说明

启动后会自动打开浏览器访问 WebUI 界面：

```
============================================================
销售数据业务助手
============================================================

可用查询:
  1. 查询某月销量: 2024年1月的销量是多少？
  2. 环比增长: 2024年2月的销量环比增长多少？
  3. 省份销售额: 各省的销售额是多少？
  4. Top 渠道: 2024年第一季度销售金额Top3的渠道

输入 'quit' 退出
============================================================
```

### 预设问题

WebUI 提供预设问题快速入口：

1. **2024年1月的销量是多少？**
2. **2024年2月相比1月，销量环比增长多少？**
3. **不同省份的销售额是多少？**
4. **2024年第一季度销售金额Top3的渠道是哪些？**

### 查询示例

#### 示例1：月度销量查询

```
用户: 2024年1月的销量是多少？

助手: 
| 月份    | 总销量 | 总销售额     |
|---------|--------|-------------|
| 2024-01 | 1,234  | ¥123,456.78 |
```

#### 示例2：环比增长分析

```
用户: 2024年2月相比1月，销量环比增长多少？

助手: 
## 2024-02 销售环比分析

| 指标   | 2024-01 | 2024-02 | 环比增长 |
|--------|---------|---------|---------|
| 总销量 | 1,234   | 1,456   | +17.99% |
| 总销售额 | ¥123,456.78 | ¥145,678.90 | +18.00% |
```

#### 示例3：省份销售额分析

```
用户: 不同省份的销售额是多少？

助手:
| 省份 | 订单数 | 总销量 | 总销售额     | 销售额占比 |
|------|--------|--------|-------------|-----------|
| 广东 | 234    | 4,567  | ¥456,789.00 | 15.23%    |
| 浙江 | 198    | 3,890  | ¥389,012.34 | 12.97%    |
| 江苏 | 187    | 3,456  | ¥345,678.90 | 11.52%    |
| ...  | ...    | ...    | ...         | ...       |
```

#### 示例4：Top 渠道查询

```
用户: 2024年第一季度销售金额Top3的渠道是哪些？

助手:
## 销售金额 Top3 渠道

| 渠道       | 订单数 | 总销量 | 总销售额     | 销售额占比 |
|------------|--------|--------|-------------|-----------|
| 线上商城   | 456    | 8,901  | ¥890,123.45 | 28.45%    |
| 天猫旗舰店 | 389    | 7,654  | ¥765,432.10 | 24.46%    |
| 京东旗舰店 | 345    | 6,789  | ¥678,901.23 | 21.70%    |
```

## 终端交互模式

### 启动终端模式

```bash
python code/main.py --mode tui
```

### 交互流程

```
============================================================
销售数据业务助手
============================================================
可用查询:
  1. 查询某月销量: 2024年1月的销量是多少？
  2. 环比增长: 2024年2月的销量环比增长多少？
  3. 省份销售额: 各省的销售额是多少？
  4. Top 渠道: 2024年第一季度销售金额Top3的渠道
  输入 'quit' 退出
============================================================

用户: 2024年3月的销量是多少？

助手: 
| 月份    | 总销量 | 总销售额     |
|---------|--------|-------------|
| 2024-03 | 1,567  | ¥156,789.01 |

用户: quit
再见！
```

### 终端模式优势

- 轻量级运行，无需 GUI 依赖
- 适合服务器环境运行
- 便于集成到脚本和自动化流程
- 资源占用更低

## 自定义扩展

### 添加新工具

#### 步骤1：实现工具函数

在 `tools.py` 中添加新函数：

```python
def get_product_sales(product_name: str, engine: Optional[Any] = None) -> str:
    """
    查询某产品的销售额
    
    Args:
        product_name: 产品名称（支持模糊匹配）
        engine: 数据库引擎
        
    Returns:
        查询结果的 Markdown 表格
    """
    sql = f"""
        SELECT 
            product_name as 产品名称,
            COUNT(*) as 订单数,
            SUM(quantity) as 总销量,
            ROUND(SUM(total_amount), 2) as 总销售额
        FROM sales
        WHERE product_name LIKE '%{product_name}%'
        GROUP BY product_name
        ORDER BY 总销售额 DESC
    """
    
    try:
        df = execute_sql(sql, engine)
        if df.empty:
            return f"未找到包含 '{product_name}' 的产品"
        return df.to_markdown(index=False)
    except Exception as e:
        logger.error(f"查询产品销售额失败: {e}")
        return f"查询失败: {str(e)}"
```

#### 步骤2：注册工具类

在 `main.py` 中注册工具：

```python
@_safe_register_tool("get_product_sales")
class GetProductSalesTool(BaseTool):
    """查询产品销售额工具"""
    
    description = "查询某产品的销售额"
    parameters = [{
        "name": "product_name",
        "type": "string",
        "description": "产品名称（支持模糊匹配）",
        "required": True,
    }]
    
    def call(self, params: str, **kwargs) -> str:
        args = json.loads(params)
        product_name = args.get("product_name")
        if not product_name:
            return "请提供产品名称"
        return get_product_sales(product_name)
```

#### 步骤3：更新系统提示词

在 `SYSTEM_PROMPT` 中添加工具说明：

```python
SYSTEM_PROMPT = """
...

## 可用工具

...
6. `get_product_sales`: 查询某产品的销售额
   - 参数: product_name (产品名称，支持模糊匹配)

...
"""
```

#### 步骤4：更新工具列表

在 `init_agent_service()` 中添加工具：

```python
bot = Assistant(
    ...
    function_list=[
        "get_monthly_sales",
        "get_monthly_sales_growth",
        "get_province_sales",
        "get_top_channels",
        "execute_custom_sql",
        "get_product_sales",  # 新增
    ],
)
```

### 使用自定义 MySQL 数据库

#### 步骤1：创建数据库和表

```sql
-- 创建数据库
CREATE DATABASE sales_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE sales_db;

-- 创建销售表
CREATE TABLE sales (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_date DATE NOT NULL COMMENT '订单日期',
    order_month VARCHAR(7) NOT NULL COMMENT '订单月份',
    province VARCHAR(50) NOT NULL COMMENT '省份',
    city VARCHAR(50) COMMENT '城市',
    channel VARCHAR(100) NOT NULL COMMENT '销售渠道',
    product_name VARCHAR(200) COMMENT '产品名称',
    quantity INT NOT NULL DEFAULT 0 COMMENT '销售数量',
    unit_price DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT '单价',
    total_amount DECIMAL(12, 2) NOT NULL DEFAULT 0 COMMENT '销售金额',
    customer_id VARCHAR(50) COMMENT '客户ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_date (order_date),
    INDEX idx_order_month (order_month),
    INDEX idx_province (province),
    INDEX idx_channel (channel)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='销售数据表';
```

#### 步骤2：配置数据库连接

```bash
# 方式一：使用 DATABASE_URL
export DATABASE_URL="mysql+mysqlconnector://user:password@host:3306/sales_db"

# 方式二：使用单独配置项
export DB_HOST=localhost
export DB_PORT=3306
export DB_USER=your_username
export DB_PASSWORD=your_password
export DB_NAME=sales_db
```

#### 步骤3：导入数据

```bash
# 使用 init_db.py 初始化
python code/init_db.py --db-type mysql

# 或导入现有数据
mysql -u user -p sales_db < your_data.sql
```

## 常见问题解决

### 1. API Key 配置问题

#### 问题现象
```
Error: DASHSCOPE_API_KEY not found
```

#### 解决方案
```bash
# 检查环境变量
echo $DASHSCOPE_API_KEY

# 如果为空，设置环境变量
export DASHSCOPE_API_KEY="your_api_key_here"

# 或在 .env 文件中配置
echo 'DASHSCOPE_API_KEY=your_api_key_here' >> .env
```

### 2. 数据库连接问题

#### 问题现象
```
Error: Can't connect to MySQL server
```

#### 解决方案
```bash
# 1. 检查 MySQL 服务是否运行
# Linux
sudo systemctl status mysql

# macOS
brew services list

# 2. 检查连接配置
mysql -h localhost -u user -p

# 3. 检查防火墙设置
# 确保端口 3306 可访问
```

### 3. 模块导入问题

#### 问题现象
```
ModuleNotFoundError: No module named 'qwen_agent'
```

#### 解决方案
```bash
# 确保在正确的虚拟环境中
source .venv/bin/activate

# 安装依赖
uv sync

# 或
pip install qwen-agent
```

### 4. GUI 依赖问题

#### 问题现象
```
ImportError: GUI dependencies not installed
```

#### 解决方案
```bash
# 安装 GUI 依赖
pip install 'qwen-agent[gui]'

# 或使用终端模式
python code/main.py --mode tui
```

### 5. 查询结果为空

#### 问题现象
```
未找到 2024-01 的销售数据
```

#### 解决方案
```bash
# 1. 检查数据库是否有数据
sqlite3 data/sales.db "SELECT COUNT(*) FROM sales;"

# 2. 检查日期范围
sqlite3 data/sales.db "SELECT DISTINCT order_month FROM sales;"

# 3. 重新初始化数据
python code/init_db.py --start-date 2024-01-01 --end-date 2024-12-31
```

## 性能调优

### 1. 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_order_month ON sales(order_month);
CREATE INDEX idx_province ON sales(province);
CREATE INDEX idx_channel ON sales(channel);

-- 复合索引
CREATE INDEX idx_month_province ON sales(order_month, province);

-- 分析表
ANALYZE TABLE sales;
```

### 2. 连接池配置

```python
# 在 db.py 中调整连接池参数
engine = create_engine(
    database_url,
    pool_size=20,        # 增加常驻连接数
    max_overflow=40,     # 增加溢出连接
    pool_timeout=60,     # 增加超时时间
    pool_recycle=1800,   # 缩短回收时间
)
```

### 3. 大模型参数调整

```python
# 在 main.py 中调整模型配置
llm_cfg = {
    "model": "qwen-turbo-latest",
    "timeout": 120,       # 增加超时时间
    "retry_count": 5,     # 增加重试次数
    "temperature": 0.1,   # 降低随机性
}
```

## 监控和调试

### 1. 日志配置

```python
# 在代码中配置日志
from loguru import logger

logger.add(
    "logs/app.log",
    rotation="1 day",
    retention="7 days",
    level="DEBUG"
)
```

### 2. 查询性能监控

```python
import time

def execute_sql_with_monitor(sql: str, engine=None):
    """带监控的 SQL 执行"""
    start_time = time.time()
    
    df = execute_sql(sql, engine)
    
    duration = time.time() - start_time
    logger.info(f"SQL 执行时间: {duration:.2f}s, 返回 {len(df)} 条记录")
    
    return df
```

### 3. 错误追踪

```python
import traceback

try:
    result = execute_sql(sql)
except Exception as e:
    logger.error(f"查询失败: {e}")
    logger.error(traceback.format_exc())
    raise
```

---

*最后更新: 2026年2月22日*
*使用指南版本: v1.0*
*技术支持: build-your-own-ai项目团队*
