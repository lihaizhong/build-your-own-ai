# èµ„é‡‘æµå…¥æµå‡ºé¢„æµ‹é¡¹ç›® - ä»£ç å®ç°è¯¦è§£

## æ ¸å¿ƒä»£ç ç»“æ„

### 1. é¡¹ç›®è·¯å¾„ç®¡ç†æ¨¡å—

```python
from practice.shared import get_project_path

def get_project_path(*paths: str) -> str:
    """è·å–é¡¹ç›®è·¯å¾„çš„ç»Ÿä¸€æ–¹æ³•"""
    try:
        current_dir = os.path.dirname(os.path.abspath(__file__))
        project_dir = os.path.dirname(current_dir)
        return os.path.join(project_dir, *paths)
    except NameError:
        return os.path.join(os.getcwd(), *paths)
```

**åŠŸèƒ½ç‰¹ç‚¹ï¼š**
- **ç»Ÿä¸€è·¯å¾„ç®¡ç†**: æä¾›é¡¹ç›®è·¯å¾„çš„æ ‡å‡†åŒ–è·å–æ–¹æ³•
- **å®¹é”™å¤„ç†**: å¤„ç†ä¸åŒè¿è¡Œç¯å¢ƒä¸‹çš„è·¯å¾„å·®å¼‚
- **çµæ´»æ‰©å±•**: æ”¯æŒä»»æ„å±‚çº§çš„è·¯å¾„æ„å»º

### 2. Propheté¢„æµ‹æ¨¡å‹è¯¦è§£

#### ä¸»å‡½æ•°æ¶æ„

```python
def main():
    """ä¸»å‡½æ•° - æœ€ç»ˆç‰ˆï¼Œå›å½’æˆåŠŸç»éªŒ"""
    print("=== æœ€ç»ˆç‰ˆProphetèµ„é‡‘æµå…¥æµå‡ºé¢„æµ‹åˆ†æ ===")
    print("ğŸ¯ æœ€ç»ˆç­–ç•¥ï¼šå›å½’v1/v2æˆåŠŸé…ç½®ï¼Œè§£å†³è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆé—®é¢˜")
    print("ğŸ’¡ æ ¸å¿ƒç†å¿µï¼šåŸºäºæˆåŠŸç»éªŒçš„å¹³è¡¡ä¼˜åŒ–")
    
    try:
        # 1. åŠ è½½æ•°æ®
        df = load_and_prepare_data()
        
        # 2. åˆ›å»ºProphetæ ¼å¼æ•°æ®
        purchase_df = df[['ds', 'purchase']].copy()
        purchase_df.rename(columns={'purchase': 'y'}, inplace=True)
        redeem_df = df[['ds', 'redeem']].copy()
        redeem_df.rename(columns={'redeem': 'y'}, inplace=True)
        
        # 3. è®­ç»ƒæ¨¡å‹
        purchase_model, forecast_purchase = train_final_prophet_model(df, "ç”³è´­", "purchase")
        redeem_model, forecast_redeem = train_final_prophet_model(df, "èµå›", "redeem")
        
        # 4. ç”Ÿæˆé¢„æµ‹
        predictions = generate_final_predictions(purchase_model, redeem_model, 
                                                  forecast_purchase, forecast_redeem)
        
        # 5. åˆ†ææ€§èƒ½
        performance = analyze_final_performance(forecast_purchase, forecast_redeem, 
                                                 purchase_df, redeem_df)
        
        # 6. ä¿å­˜ç»“æœ
        save_final_results(predictions, performance)
        
        return True
        
    except Exception as e:
        print(f"é¢„æµ‹è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        return False
```

**å…³é”®è®¾è®¡ç‚¹ï¼š**
- **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªæ­¥éª¤ç‹¬ç«‹å‡½æ•°ï¼Œä¾¿äºç»´æŠ¤å’Œè°ƒè¯•
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œå¤„ç†æœºåˆ¶
- **ç»“æœè¿½è¸ª**: è¯¦ç»†çš„è¾“å‡ºä¿¡æ¯ä¾¿äºé—®é¢˜å®šä½

## æ•°æ®åŠ è½½æ¨¡å—è¯¦è§£

### 1. æ•°æ®åŠ è½½å’Œå‡†å¤‡

```python
def load_and_prepare_data():
    """åŠ è½½å¹¶å‡†å¤‡æ•°æ® - å‚è€ƒv1/v2æˆåŠŸæ¨¡å¼"""
    print("=== åŠ è½½æ•°æ®å¹¶å‡†å¤‡Prophetæ ¼å¼ï¼ˆå‚è€ƒv1/v2æˆåŠŸæ¨¡å¼ï¼‰ ===")
    
    # è¯»å–æ¯æ—¥æ±‡æ€»æ•°æ®
    data_file = get_project_path('..', 'user_data', 'daily_summary.csv')
    df = pd.read_csv(data_file, header=None, names=['date', 'purchase', 'redeem'])
    
    # è½¬æ¢æ—¥æœŸæ ¼å¼
    df['ds'] = pd.to_datetime(df['date'], format='%Y%m%d')
    
    print(f"æ•°æ®æ¦‚å†µ:")
    print(f"- æ•°æ®æ—¶é—´èŒƒå›´: {df['ds'].min()} è‡³ {df['ds'].max()}")
    print(f"- æ€»å¤©æ•°: {len(df)} å¤©")
    print(f"- ç”³è´­æ•°æ®å¹³å‡: Â¥{df['purchase'].mean():,.0f}")
    print(f"- èµå›æ•°æ®å¹³å‡: Â¥{df['redeem'].mean():,.0f}")
    
    return df
```

**æŠ€æœ¯äº®ç‚¹ï¼š**
- **æ—¥æœŸæ ¼å¼å¤„ç†**: ç»Ÿä¸€å¤„ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
- **æ•°æ®æ¦‚è§ˆ**: æä¾›å…³é”®ç»Ÿè®¡ä¿¡æ¯
- **è·¯å¾„ç®¡ç†**: ä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„è·å–æ–¹æ³•

### 2. æ•°æ®åˆ†æå·¥å…·

```python
def analyze_daily_flow():
    """åˆ†ææ¯æ—¥ç”³è´­æ€»é¢å’Œèµå›æ€»é¢çš„è¶‹åŠ¿"""
    data_file = get_project_path('..', 'data', 'user_balance_table.csv')
    
    try:
        daily_data = defaultdict(lambda: {'purchase': 0, 'redeem': 0})
        
        with open(data_file, 'r', encoding='utf-8') as f:
            reader = csv.DictReader(f)
            count = 0
            
            for row in reader:
                count += 1
                if count % 10000 == 0:
                    print(f"å·²å¤„ç† {count:,} æ¡è®°å½•...")
                
                date = row['report_date']
                try:
                    purchase_amt = float(row['total_purchase_amt']) if row['total_purchase_amt'] else 0
                    redeem_amt = float(row['total_redeem_amt']) if row['total_redeem_amt'] else 0
                    
                    daily_data[date]['purchase'] += purchase_amt
                    daily_data[date]['redeem'] += redeem_amt
                except (ValueError, KeyError):
                    continue
        
        print(f"æ•°æ®å¤„ç†å®Œæˆï¼Œå…±å¤„ç† {count:,} æ¡è®°å½•")
        
        return daily_data
        
    except Exception as e:
        print(f"åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        return None
```

**è§£æç­–ç•¥ï¼š**
- **é€è¡Œå¤„ç†**: ä½¿ç”¨è¿­ä»£å™¨é¿å…å†…å­˜æº¢å‡º
- **è¿›åº¦åé¦ˆ**: å®šæœŸæ˜¾ç¤ºå¤„ç†è¿›åº¦
- **å®¹é”™å¤„ç†**: è·³è¿‡æ— æ•ˆæ•°æ®ç»§ç»­å¤„ç†

## Prophetæ¨¡å‹å®ç°è¯¦è§£

### 1. èŠ‚å‡æ—¥å»ºæ¨¡

```python
def create_china_holidays_v6():
    """åˆ›å»ºv6ç‰ˆæœ¬èŠ‚å‡æ—¥ï¼ˆå‚è€ƒv1/v2çš„æˆåŠŸé…ç½®ï¼‰"""
    print("=== åˆ›å»ºä¸­å›½èŠ‚å‡æ—¥ï¼ˆv1/v2æˆåŠŸæ¨¡å¼ï¼‰ ===")
    
    holidays = []
    
    # ä¸»è¦èŠ‚å‡æ—¥é…ç½®
    main_holidays = [
        # 2013å¹´èŠ‚å‡æ—¥
        {'holiday': 'å…ƒæ—¦', 'ds': '2013-01-01'},
        {'holiday': 'æ˜¥èŠ‚', 'ds': '2013-02-10'},
        # ... æ›´å¤šèŠ‚å‡æ—¥
        
        # 2014å¹´èŠ‚å‡æ—¥
        {'holiday': 'å…ƒæ—¦', 'ds': '2014-01-01'},
        {'holiday': 'æ˜¥èŠ‚', 'ds': '2014-01-31'},
        # ... æ›´å¤šèŠ‚å‡æ—¥
    ]
    
    holidays.extend(main_holidays)
    holidays_df = pd.DataFrame(holidays)
    
    print(f"v1/v2æˆåŠŸæ¨¡å¼èŠ‚å‡æ—¥å»ºæ¨¡å®Œæˆ: {len(holidays_df)} å¤©")
    
    return holidays_df
```

**èŠ‚å‡æ—¥å»ºæ¨¡ç‰¹ç‚¹ï¼š**
- **å®Œæ•´è¦†ç›–**: è¦†ç›–2013-2014å¹´ä¸­å›½ä¸»è¦èŠ‚å‡æ—¥
- **ç®€åŒ–é…ç½®**: å‚è€ƒæˆåŠŸç‰ˆæœ¬ï¼Œé¿å…è¿‡åº¦å¤æ‚
- **çµæ´»æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„èŠ‚å‡æ—¥

### 2. æ¨¡å‹è®­ç»ƒå®ç°

```python
def train_final_prophet_model(df, model_name, target_column):
    """è®­ç»ƒæœ€ç»ˆç‰ˆProphetæ¨¡å‹ï¼ˆå‚è€ƒv1/v2æˆåŠŸå‚æ•°ï¼‰"""
    print(f"\n=== è®­ç»ƒ{model_name}æœ€ç»ˆç‰ˆProphetæ¨¡å‹ï¼ˆv1/v2æˆåŠŸé…ç½®ï¼‰ ===")
    
    # åˆ›å»ºèŠ‚å‡æ—¥
    holidays_df = create_china_holidays_v6()
    
    # å‚è€ƒv1/v2çš„æˆåŠŸé…ç½®
    model = Prophet(
        yearly_seasonality=True,
        weekly_seasonality=True,
        daily_seasonality=False,
        seasonality_mode='additive',
        
        # å›åˆ°v1/v2çš„æˆåŠŸå‚æ•°
        changepoint_prior_scale=0.05,      # æ ‡å‡†æ•æ„Ÿåº¦
        seasonality_prior_scale=10.0,      # æ ‡å‡†å­£èŠ‚æ€§æƒé‡
        holidays_prior_scale=10.0,         # æ ‡å‡†èŠ‚å‡æ—¥æƒé‡
        interval_width=0.95,               # å®½ç½®ä¿¡åŒºé—´
        
        # ç®€åŒ–é…ç½®
        mcmc_samples=0,
        holidays=holidays_df
    )
    
    # åˆ›å»ºProphetæ ¼å¼æ•°æ®
    prophet_df = df[['ds', target_column]].copy()
    prophet_df.rename(columns={target_column: 'y'}, inplace=True)
    
    # è®­ç»ƒæ¨¡å‹
    model.fit(prophet_df)
    
    # åˆ›å»ºæœªæ¥æ—¥æœŸ
    future = model.make_future_dataframe(periods=30)
    
    # ç”Ÿæˆé¢„æµ‹
    forecast = model.predict(future)
    
    # ä¿å­˜æ¨¡å‹
    model_path = get_project_path('..', 'model', f'{target_column}_prophet_v6_model.pkl')
    with open(model_path, 'wb') as f:
        pickle.dump(model, f)
    
    print(f"æœ€ç»ˆç‰ˆæ¨¡å‹å·²ä¿å­˜åˆ°: {model_path}")
    
    return model, forecast
```

**æ¨¡å‹é…ç½®è§£æï¼š**
- **changepoint_prior_scale**: æ§åˆ¶è¶‹åŠ¿å˜ç‚¹çš„æ•æ„Ÿåº¦ï¼Œ0.05ä¸ºæ ‡å‡†å€¼
- **seasonality_prior_scale**: å­£èŠ‚æ€§æ•ˆåº”çš„æƒé‡ï¼Œ10.0ä¸ºæ¨èå€¼
- **holidays_prior_scale**: èŠ‚å‡æ—¥æ•ˆåº”çš„æƒé‡
- **seasonality_mode**: åŠ æ³•æ¨¡å¼é€‚åˆé‡‘èæ•°æ®

### 3. é¢„æµ‹ç”Ÿæˆå®ç°

```python
def generate_final_predictions(purchase_model, redeem_model, 
                                forecast_purchase, forecast_redeem):
    """ç”Ÿæˆæœ€ç»ˆç‰ˆé¢„æµ‹ç»“æœ"""
    print("\n=== ç”Ÿæˆæœ€ç»ˆç‰ˆé¢„æµ‹ç»“æœ ===")
    
    # è·å–æœªæ¥30å¤©çš„é¢„æµ‹
    future_predictions = forecast_purchase.tail(30)
    future_redeem = forecast_redeem.tail(30)
    
    # åˆ›å»ºé¢„æµ‹ç»“æœæ•°æ®æ¡†
    predictions = pd.DataFrame({
        'date': future_predictions['ds'],
        'purchase_forecast': future_predictions['yhat'],
        'redeem_forecast': future_redeem['yhat'],
        'purchase_lower': future_predictions['yhat_lower'],
        'purchase_upper': future_predictions['yhat_upper'],
        'redeem_lower': future_redeem['yhat_lower'],
        'redeem_upper': future_redeem['yhat_upper']
    })
    
    # æ·»åŠ æ—¥æœŸç‰¹å¾
    predictions['weekday'] = predictions['date'].dt.dayofweek
    predictions['is_weekend'] = predictions['weekday'].isin([5, 6])
    predictions['day_name'] = predictions['date'].dt.day_name()
    
    # è®¡ç®—å‡€æµå…¥
    predictions['net_flow'] = predictions['purchase_forecast'] - predictions['redeem_forecast']
    
    # ä¿å­˜ç«èµ›æ ¼å¼é¢„æµ‹ç»“æœ
    prediction_file = get_project_path('..', 'prediction_result', 
                                        'prophet_v6_predictions_201409.csv')
    exam_format = predictions[['date']].copy()
    exam_format['date'] = exam_format['date'].dt.strftime('%Y%m%d')
    exam_format['purchase'] = predictions['purchase_forecast'].round(0).astype(int)
    exam_format['redeem'] = predictions['redeem_forecast'].round(0).astype(int)
    
    exam_format.to_csv(prediction_file, header=False, index=False)
    
    return predictions
```

**é¢„æµ‹å¤„ç†ç‰¹ç‚¹ï¼š**
- **å¤šç»´åº¦é¢„æµ‹**: åŒ…å«ç‚¹é¢„æµ‹å’Œç½®ä¿¡åŒºé—´
- **ç‰¹å¾æ‰©å±•**: æ·»åŠ æ—¥æœŸç›¸å…³ç‰¹å¾ä¾¿äºåˆ†æ
- **æ ¼å¼é€‚é…**: è‡ªåŠ¨è½¬æ¢ä¸ºç«èµ›è¦æ±‚çš„æ ¼å¼

## æ—¶é—´åºåˆ—åˆ†ææ¨¡å—è¯¦è§£

### 1. å¹³ç¨³æ€§æ£€éªŒ

```python
def adf_test(series, series_name):
    """æ‰§è¡ŒADFå¹³ç¨³æ€§æ£€éªŒ"""
    result = adfuller(series, autolag='AIC')
    
    print(f"\n=== {series_name} ADFæ£€éªŒç»“æœ ===")
    print(f"ADFç»Ÿè®¡é‡: {result[0]:.6f}")
    print(f"p-value: {result[1]:.6f}")
    print(f"ä½¿ç”¨çš„æ»åæœŸ: {result[2]}")
    print(f"è§‚æµ‹å€¼æ•°é‡: {result[3]}")
    
    print("\nä¸´ç•Œå€¼:")
    for key, value in result[4].items():
        print(f"\t{key}: {value:.6f}")
    
    # åˆ¤æ–­å¹³ç¨³æ€§
    if result[1] <= 0.05:
        print(f"\nç»“è®º: {series_name} æ˜¯å¹³ç¨³çš„")
        return True
    else:
        print(f"\nç»“è®º: {series_name} æ˜¯éå¹³ç¨³çš„")
        return False
```

### 2. å·®åˆ†åˆ†æå®ç°

```python
def perform_differencing_analysis(filtered_df):
    """æ‰§è¡Œå·®åˆ†åˆ†æå’ŒADFæ£€éªŒ"""
    print(f"\n=== å·®åˆ†å¹³ç¨³æ€§åˆ†æ ===")
    
    # å¯¹èµå›æ€»é¢è¿›è¡Œä¸€é˜¶å·®åˆ†
    redeem_diff = filtered_df['redeem_amt'].diff().dropna()
    
    # åŸå§‹æ•°æ®ADFæ£€éªŒ
    original_adf = adfuller(filtered_df['redeem_amt'].dropna())
    
    # å·®åˆ†åæ•°æ®ADFæ£€éªŒ
    diff_adf = adfuller(redeem_diff)
    
    # åˆ¤æ–­å·®åˆ†åçš„å¹³ç¨³æ€§
    diff_stationary = diff_adf[1] <= 0.05
    
    # åˆ›å»ºå·®åˆ†åˆ†æå›¾è¡¨
    create_differencing_plots(filtered_df, redeem_diff)
    
    return {
        'original_adf': original_adf,
        'diff_adf': diff_adf,
        'diff_stationary': diff_stationary,
        'diff_data': redeem_diff
    }
```

**åˆ†æç‰¹ç‚¹ï¼š**
- **ADFæ£€éªŒ**: æ ‡å‡†çš„å¹³ç¨³æ€§æ£€éªŒæ–¹æ³•
- **å·®åˆ†å¤„ç†**: è‡ªåŠ¨è¯†åˆ«éœ€è¦çš„å·®åˆ†é˜¶æ•°
- **å¯è§†åŒ–**: ç”Ÿæˆåˆ†æå›¾è¡¨ä¾¿äºç†è§£

## å¯è§†åŒ–æ¨¡å—è¯¦è§£

### 1. ASCIIå›¾è¡¨ç”Ÿæˆ

```python
def create_ascii_chart(data_points, width=80, height=20):
    """åˆ›å»ºASCIIæŠ˜çº¿å›¾"""
    if len(data_points) < 2:
        return "æ•°æ®ç‚¹ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨"
    
    # æ‰¾åˆ°æœ€å¤§å’Œæœ€å°å€¼
    max_val = max(data_points)
    min_val = min(data_points)
    val_range = max_val - min_val if max_val != min_val else 1
    
    # è®¡ç®—æ¯ä¸ªæ•°æ®ç‚¹åœ¨å›¾è¡¨ä¸­çš„ä½ç½®
    chart_lines = []
    for i in range(height, -1, -1):
        line = ""
        threshold = min_val + (i * val_range / height)
        
        for j, val in enumerate(data_points):
            # åˆ¤æ–­æ˜¯å¦éœ€è¦ç»˜åˆ¶ç‚¹æˆ–çº¿
            if val >= threshold:
                line += "â—"
            else:
                line += " "
        
        # æ·»åŠ æ•°å€¼æ ‡ç­¾
        if i % 4 == 0:
            value = min_val + (i * val_range / height)
            line = f"{value/1e6:.1f}M  {line}"
        
        chart_lines.append(line)
    
    return "\n".join(chart_lines)
```

### 2. æŠ¥å‘Šç”Ÿæˆ

```python
def generate_chart_report():
    """ç”Ÿæˆå›¾è¡¨æŠ¥å‘Š"""
    csv_file = get_project_path('..', 'user_data', 'daily_summary.csv')
    
    # è¯»å–æ•°æ®
    dates, purchases, redeems = [], [], []
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        for row in reader:
            dates.append(row[0])
            purchases.append(float(row[1]))
            redeems.append(float(row[2]))
    
    # ç”Ÿæˆè¶‹åŠ¿å›¾è¡¨
    print("æ¯æ—¥ç”³è´­æ€»é¢è¶‹åŠ¿:")
    print(create_ascii_chart(purchases[::7]))
    
    print("æ¯æ—¥èµå›æ€»é¢è¶‹åŠ¿:")
    print(create_ascii_chart(redeems[::7]))
    
    # ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
    print("\n=== å…³é”®æŒ‡æ ‡æ±‡æ€» ===")
    # ... ç»Ÿè®¡è®¡ç®—å’Œè¾“å‡º
```

**å¯è§†åŒ–ç‰¹ç‚¹ï¼š**
- **ASCIIå›¾è¡¨**: ç»ˆç«¯å‹å¥½çš„å¯è§†åŒ–æ–¹å¼
- **å…³é”®æŒ‡æ ‡**: è‡ªåŠ¨è®¡ç®—å’Œå±•ç¤ºé‡è¦ç»Ÿè®¡é‡
- **è¶‹åŠ¿åˆ†æ**: æ¸…æ™°å±•ç¤ºæ•°æ®å˜åŒ–è¶‹åŠ¿

## é”™è¯¯å¤„ç†å’Œè°ƒè¯•æœºåˆ¶

### 1. å¼‚å¸¸å¤„ç†ç­–ç•¥

```python
def safe_prediction(model, future_df, threshold=0):
    """å®‰å…¨çš„é¢„æµ‹å‡½æ•°"""
    try:
        forecast = model.predict(future_df)
        
        # éªŒè¯é¢„æµ‹ç»“æœ
        if forecast['yhat'].isnull().any():
            raise ValueError("é¢„æµ‹ç»“æœåŒ…å«ç©ºå€¼")
        
        if (forecast['yhat'] < threshold).any():
            print(f"è­¦å‘Š: é¢„æµ‹ç»“æœåŒ…å«è´Ÿå€¼ï¼Œå·²è‡ªåŠ¨ä¿®æ­£")
            forecast['yhat'] = forecast['yhat'].clip(lower=threshold)
        
        return forecast
        
    except Exception as e:
        print(f"é¢„æµ‹å¤±è´¥: {e}")
        return None
```

### 2. æ€§èƒ½ç›‘æ§

```python
import time

def monitor_performance(operation_name):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    def decorator(func):
        def wrapper(*args, **kwargs):
            start_time = time.time()
            result = func(*args, **kwargs)
            end_time = time.time()
            
            duration = end_time - start_time
            if duration > 1.0:
                print(f"âš ï¸  {operation_name} æ‰§è¡Œæ—¶é—´: {duration:.2f}ç§’")
            else:
                print(f"âœ… {operation_name} å®Œæˆ: {duration:.3f}ç§’")
            
            return result
        return wrapper
    return decorator
```

---

*æœ€åæ›´æ–°: 2026å¹´2æœˆ15æ—¥*
*ä»£ç å®ç°ç‰ˆæœ¬: v1.0*
*å¼€å‘å›¢é˜Ÿ: AIç³»ç»Ÿå¼€å‘ç»„*
