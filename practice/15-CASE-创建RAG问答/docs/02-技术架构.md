# RAG问答系统 - 技术架构

## RAG技术原理

### 什么是RAG？

检索增强生成（Retrieval-Augmented Generation，RAG）是一种结合了信息检索和文本生成的AI技术架构。它通过在生成回答之前先从知识库中检索相关信息，有效提升了大语言模型回答的准确性和可靠性。

### RAG的核心优势

#### 1. 减少模型幻觉
- 基于真实文档生成回答
- 提供信息来源追溯
- 避免凭空捏造事实
- 增强回答可信度

#### 2. 知识实时更新
- 无需重新训练模型
- 动态更新知识库
- 快速响应信息变化
- 降低维护成本

#### 3. 领域知识注入
- 轻松集成专业知识
- 支持企业私有数据
- 定制化知识库构建
- 保护数据隐私

#### 4. 成本效益
- 减少模型微调需求
- 降低计算资源消耗
- 简化部署流程
- 易于扩展维护

### RAG工作流程

```
用户查询
    │
    ↓
┌─────────────────────────────────────────────────────────┐
│                     查询处理层                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  查询理解   │→ │  查询改写   │→ │  向量编码   │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────────────────────────┐
│                     检索层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ 向量相似度  │→ │  混合检索   │→ │  重排序     │    │
│  │   检索      │  │             │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────────────────────────────┐
│                     生成层                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  上下文构建 │→ │  LLM生成    │→ │  后处理     │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
    │
    ↓
最终回答
```

## 系统架构概览

### 整体架构图

```
┌──────────────────────────────────────────────────────────────┐
│                        用户接口层                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │  命令行界面    │  │  交互式问答    │  │  自动测试模式  │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                        应用逻辑层                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │  PDF处理器     │  │  RAG系统核心   │  │  DashScope集成 │ │
│  │  (pdf_processor)│  │   (main)       │  │(deepseek_      │ │
│  │                │  │                │  │ integration)   │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                        核心服务层                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │ LangChain框架  │  │  FAISS向量库   │  │  文本分割器    │ │
│  │                │  │                │  │                │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                        外部服务层                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐ │
│  │ DashScope API  │  │  PDF文档存储   │  │  环境配置      │ │
│  │ • 通义千问     │  │                │  │  (.env)        │ │
│  │ • 嵌入模型     │  │                │  │                │ │
│  └────────────────┘  └────────────────┘  └────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

### 核心模块关系

```
┌─────────────────────────────────────────────────────────────┐
│                     main.py (主程序)                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              RAG问答系统核心逻辑                      │   │
│  │  • create_complete_rag_system()                     │   │
│  │  • query_rag_system()                               │   │
│  │  • interactive_rag_system()                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
            │                              │
            │ PDF处理                      │ API集成
            ↓                              ↓
┌──────────────────────┐      ┌──────────────────────┐
│  pdf_processor.py    │      │ deepseek_integration │
│                      │      │        .py           │
│  • PDFProcessor      │      │                      │
│  • load_and_process  │      │  • DashScopeIntegra- │
│  • get_document_stats│      │    tion              │
│                      │      │  • get_dashscope_llm │
└──────────────────────┘      │  • get_embeddings    │
                              └──────────────────────┘
```

## 核心组件架构

### 1. 文档处理组件

#### PDFProcessor类设计
```python
class PDFProcessor:
    """PDF文档处理器"""
    
    def __init__(self, pdf_path: str)
    def load_and_process(self) -> List[Document]
    def get_document_stats(self) -> Dict[str, Any]
    def save_processed_documents(self, output_path: str)
```

**核心功能**:
- PDF文件加载和文本提取
- 页码信息记录和管理
- 文档统计信息生成
- 处理结果持久化

**处理流程**:
```
PDF文件
    │
    ↓ PyPDFLoader.load()
原始文档列表
    │
    ↓ 添加页码元数据
处理后的文档
    │
    ↓ 返回Document对象
带页码的文档列表
```

### 2. 向量存储组件

#### FAISS向量数据库
```python
# 向量数据库创建流程
embeddings = get_embeddings()  # DashScope嵌入模型
vector_store = FAISS.from_documents(documents, embeddings)
retriever = vector_store.as_retriever(search_kwargs={"k": 4})
```

**关键特性**:
- 高效的向量相似度搜索
- 支持L2距离和内积相似度
- 内存优化的索引结构
- 支持大规模向量存储

**索引类型**:
- **IndexFlatL2**: 精确L2距离搜索
- **IndexIVFFlat**: 倒排索引加速
- **IndexHNSW**: 层级导航小世界图

### 3. 大模型集成组件

#### DashScopeIntegration类设计
```python
class DashScopeIntegration:
    """DashScope API集成管理器"""
    
    def __init__(self)
    def get_llm(self, model_name, temperature) -> ChatTongyi
    def get_embeddings(self, model_name) -> DashScopeEmbeddings
    def get_config_info(self) -> Dict[str, Any]
    def validate_api_keys(self) -> bool
```

**支持的模型**:
- **通义千问系列**:
  - qwen-turbo: 快速响应，适合一般问答
  - qwen-plus: 增强能力，复杂任务处理
  - qwen-max: 最强性能，高质量要求场景

- **嵌入模型**:
  - text-embedding-v2: 最新中文优化版本
  - 支持中英文混合文本
  - 1536维度向量输出

## LangChain框架集成

### 核心组件使用

#### 1. 文档加载器
```python
from langchain_community.document_loaders import PyPDFLoader

# PDF文档加载
loader = PyPDFLoader(pdf_path)
documents = loader.load()
```

**支持的文档加载器**:
- PyPDFLoader: PDF文件
- TextLoader: 纯文本文件
- UnstructuredMarkdownLoader: Markdown文件
- Docx2txtLoader: Word文档

#### 2. 文本分割器
```python
from langchain_text_splitters import RecursiveCharacterTextSplitter

# 文本分割配置
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=1000,        # 每个块的最大字符数
    chunk_overlap=200,      # 块之间的重叠字符数
    separators=["\n\n", "\n", " ", ""]  # 分隔符优先级
)
```

**分割策略**:
- 递归字符分割: 按优先级尝试不同分隔符
- 保持语义完整性: 优先在段落、句子边界分割
- 重叠设计: 保持上下文连贯性

#### 3. 向量存储
```python
from langchain_community.vectorstores.faiss import FAISS

# 创建向量存储
vector_store = FAISS.from_documents(documents, embeddings)

# 创建检索器
retriever = vector_store.as_retriever(
    search_type="similarity",  # 相似度搜索
    search_kwargs={"k": 4}     # 返回top-4结果
)
```

**检索策略**:
- similarity: 相似度搜索
- mmr: 最大边际相关性，增加多样性
- similarity_score_threshold: 设置相似度阈值

## 向量数据库技术

### FAISS向量检索原理

#### 向量相似度计算
```
查询向量: q = [0.1, 0.2, 0.3, ...]
文档向量: d = [0.15, 0.18, 0.32, ...]

余弦相似度: sim(q, d) = (q · d) / (||q|| * ||d||)
L2距离: dist(q, d) = ||q - d||²
```

#### 索引结构优化

**IndexFlatL2（本项目使用）**:
- 优点: 精确搜索，实现简单
- 缺点: 大数据量时性能下降
- 适用: 中小规模数据（<100万向量）

**IndexIVFFlat（推荐大规模使用）**:
```python
# 创建IVF索引
quantizer = faiss.IndexFlatL2(dimension)
index = faiss.IndexIVFFlat(quantizer, dimension, nlist=100)
index.train(embeddings)  # 训练聚类中心
index.add(embeddings)    # 添加向量
```

### 向量维度选择

| 嵌入模型 | 向量维度 | 特点 |
|---------|---------|------|
| text-embedding-v2 | 1536 | 中文优化，高质量 |
| text-embedding-v1 | 1536 | 通用版本 |
| bge-large-zh | 1024 | 开源中文模型 |
| m3e-base | 768 | 轻量级中文模型 |

## PDF处理技术

### PyPDFLoader工作机制

```
┌─────────────────────────────────────────────────────────┐
│                    PDF文件结构                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │  页面1  │  │  页面2  │  │  页面3  │  │   ...   │   │
│  │         │  │         │  │         │  │         │   │
│  │  文本   │  │  文本   │  │  文本   │  │  文本   │   │
│  │  图片   │  │  图片   │  │  图片   │  │  图片   │   │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
└─────────────────────────────────────────────────────────┘
                    ↓ PyPDFLoader.load()
┌─────────────────────────────────────────────────────────┐
│                   Document对象列表                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Document(                                          │  │
│  │   page_content="页面文本内容...",                  │  │
│  │   metadata={                                       │  │
│  │     'page': 0,                                     │  │
│  │     'source': 'document.pdf'                       │  │
│  │   }                                                │  │
│  │ )                                                  │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 文本分割策略

#### 参数调优建议

| 文档类型 | chunk_size | chunk_overlap | 说明 |
|---------|------------|---------------|------|
| 技术文档 | 1000-1500 | 200-300 | 保持代码块完整 |
| 新闻文章 | 800-1200 | 150-200 | 段落完整性 |
| 学术论文 | 1500-2000 | 300-400 | 保持论述连贯 |
| FAQ文档 | 300-500 | 50-100 | 问题完整性 |

## API集成方案

### DashScope API架构

```
┌─────────────────────────────────────────────────────────┐
│                    DashScope平台                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  API Gateway                      │   │
│  │  • 认证鉴权                                      │   │
│  │  • 流量控制                                      │   │
│  │  • 负载均衡                                      │   │
│  └─────────────────────────────────────────────────┘   │
│              ↓                        ↓                 │
│  ┌─────────────────────┐  ┌─────────────────────┐     │
│  │   通义千问服务       │  │   嵌入模型服务       │     │
│  │  • qwen-turbo       │  │  • text-embedding-v2 │     │
│  │  • qwen-plus        │  │  • 批量处理支持      │     │
│  │  • qwen-max         │  │  • 中文优化         │     │
│  └─────────────────────┘  └─────────────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### API调用优化

#### 1. 批量处理
```python
# 批量嵌入生成
texts = ["文本1", "文本2", "文本3"]
embeddings = embeddings_model.embed_documents(texts)
```

#### 2. 异步调用
```python
# 异步LLM调用
response = await llm.ainvoke(prompt)
```

#### 3. 流式输出
```python
# 流式生成回答
async for chunk in llm.astream(prompt):
    print(chunk.content, end="", flush=True)
```

## 技术选型对比

### 大模型服务对比

| 特性 | DashScope | OpenAI | Azure OpenAI |
|------|-----------|--------|--------------|
| 中文支持 | ★★★★★ | ★★★☆☆ | ★★★☆☆ |
| 响应速度 | ★★★★☆ | ★★★★★ | ★★★★☆ |
| 价格 | ★★★★★ | ★★★☆☆ | ★★★☆☆ |
| API稳定性 | ★★★★☆ | ★★★★★ | ★★★★★ |
| 国内访问 | ★★★★★ | ★★☆☆☆ | ★★★☆☆ |

### 向量数据库对比

| 特性 | FAISS | Pinecone | Milvus |
|------|-------|----------|--------|
| 部署复杂度 | 低 | 低 | 高 |
| 性能 | ★★★★★ | ★★★★☆ | ★★★★★ |
| 可扩展性 | ★★★☆☆ | ★★★★★ | ★★★★★ |
| 开源免费 | ✓ | ✗ | ✓ |
| 本地部署 | ✓ | ✗ | ✓ |

## 扩展架构设计

### 多文档支持架构

```
┌─────────────────────────────────────────────────────────┐
│                    文档管理层                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │              DocumentManager                      │   │
│  │  • 支持多种格式（PDF/Word/Markdown）             │   │
│  │  • 文档版本管理                                  │   │
│  │  • 增量更新支持                                  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### Web服务架构

```
┌─────────────────────────────────────────────────────────┐
│                    API服务层                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │              FastAPI应用                          │   │
│  │  • RESTful API接口                               │   │
│  │  • WebSocket支持                                 │   │
│  │  • 认证授权                                      │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                    RAG服务层                             │
│  ┌─────────────────────────────────────────────────┐   │
│  │              RAGService                           │   │
│  │  • 问答服务                                      │   │
│  │  • 文档管理                                      │   │
│  │  • 缓存服务                                      │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

*最后更新: 2026年2月15日*
*文档版本: v1.0*
*技术架构团队: build-your-own-ai项目*
