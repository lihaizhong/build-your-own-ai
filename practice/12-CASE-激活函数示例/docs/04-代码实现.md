# 激活函数示例项目 - 代码实现详解

## 核心代码结构

### 1. 项目文件组织

```
code/
├── activation_optimized_final.py  # 综合分析脚本（推荐使用）
├── activation_derivatives.py      # 导数分析脚本
├── plot_activation_functions.py   # 基础绘图脚本
├── simple_activation_plot.py      # 简单对比脚本
└── simple_derivative_comparison.py # 导数对比脚本
```

### 2. 代码模块划分

```python
# 代码结构概览
"""
激活函数示例项目代码结构：

1. 配置模块
   - 字体配置
   - 样式配置
   - 布局配置

2. 激活函数模块
   - sigmoid()
   - tanh_func()
   - relu()

3. 导数计算模块
   - sigmoid_derivative()
   - tanh_derivative()
   - relu_derivative()

4. 可视化模块
   - 创建图形
   - 绘制曲线
   - 添加标注
   - 保存图像

5. 分析模块
   - 数值计算
   - 统计分析
   - 报告生成
"""
```

## 激活函数实现详解

### 1. Sigmoid函数实现

```python
def sigmoid(x):
    """
    Sigmoid激活函数
    
    数学公式: σ(x) = 1 / (1 + e^(-x))
    
    Args:
        x: 输入值或数组
        
    Returns:
        Sigmoid函数值，范围(0, 1)
        
    Examples:
        >>> sigmoid(0)
        0.5
        >>> sigmoid(np.array([-1, 0, 1]))
        array([0.269, 0.5, 0.731])
    """
    return 1 / (1 + np.exp(-x))
```

**实现要点：**
- 使用NumPy的`exp`函数，支持向量化计算
- 数值稳定：NumPy内部处理了大数溢出问题
- 支持标量和数组输入

**数值稳定性考虑：**
```python
# 更稳定的实现（处理极大负数）
def sigmoid_stable(x):
    """数值稳定的Sigmoid实现"""
    # 对于大正数，直接返回1
    # 对于大负数，使用等价公式避免溢出
    pos_mask = x >= 0
    neg_mask = ~pos_mask
    
    result = np.zeros_like(x, dtype=float)
    
    # 正数：直接计算
    result[pos_mask] = 1 / (1 + np.exp(-x[pos_mask]))
    
    # 负数：使用等价公式 exp(x)/(1+exp(x))
    exp_x = np.exp(x[neg_mask])
    result[neg_mask] = exp_x / (1 + exp_x)
    
    return result
```

### 2. Tanh函数实现

```python
def tanh_func(x):
    """
    Tanh激活函数
    
    数学公式: tanh(x) = (e^x - e^(-x)) / (e^x + e^(-x))
    
    Args:
        x: 输入值或数组
        
    Returns:
        Tanh函数值，范围(-1, 1)
        
    Examples:
        >>> tanh_func(0)
        0.0
        >>> tanh_func(np.array([-1, 0, 1]))
        array([-0.762, 0.0, 0.762])
    """
    return np.tanh(x)
```

**实现要点：**
- 直接使用NumPy内置`tanh`函数
- 比手动实现更高效且数值稳定
- 自动支持向量化计算

### 3. ReLU函数实现

```python
def relu(x):
    """
    ReLU激活函数
    
    数学公式: ReLU(x) = max(0, x)
    
    Args:
        x: 输入值或数组
        
    Returns:
        ReLU函数值，范围[0, +∞)
        
    Examples:
        >>> relu(-1)
        0
        >>> relu(np.array([-1, 0, 1]))
        array([0, 0, 1])
    """
    return np.maximum(0, x)
```

**实现要点：**
- 使用`np.maximum`而非`np.max`
- 支持广播和向量化
- 计算效率最高

**替代实现方式：**
```python
# 方式1：使用where
def relu_v1(x):
    return np.where(x > 0, x, 0)

# 方式2：使用clip
def relu_v2(x):
    return np.clip(x, 0, None)

# 方式3：使用布尔索引
def relu_v3(x):
    result = x.copy()
    result[result < 0] = 0
    return result
```

## 导数计算实现

### 1. Sigmoid导数

```python
def sigmoid_derivative(x):
    """
    Sigmoid函数的导数
    
    数学公式: σ'(x) = σ(x) * (1 - σ(x))
    
    Args:
        x: 输入值或数组
        
    Returns:
        Sigmoid导数值，范围(0, 0.25]
        
    Examples:
        >>> sigmoid_derivative(0)
        0.25
        >>> sigmoid_derivative(np.array([-2, 0, 2]))
        array([0.105, 0.25, 0.105])
    """
    s = sigmoid(x)
    return s * (1 - s)
```

**数学推导：**
```
设 σ(x) = 1/(1+e^(-x))

σ'(x) = d/dx[1/(1+e^(-x))]
      = e^(-x) / (1+e^(-x))^2
      = σ(x) * (1 - σ(x))
```

### 2. Tanh导数

```python
def tanh_derivative(x):
    """
    Tanh函数的导数
    
    数学公式: tanh'(x) = 1 - tanh²(x)
    
    Args:
        x: 输入值或数组
        
    Returns:
        Tanh导数值，范围(0, 1]
        
    Examples:
        >>> tanh_derivative(0)
        1.0
        >>> tanh_derivative(np.array([-2, 0, 2]))
        array([0.07, 1.0, 0.07])
    """
    t = tanh_func(x)
    return 1 - t**2
```

**数学推导：**
```
设 tanh(x) = (e^x - e^(-x))/(e^x + e^(-x))

tanh'(x) = 1 - tanh²(x)
```

### 3. ReLU导数

```python
def relu_derivative(x):
    """
    ReLU函数的导数
    
    数学公式: ReLU'(x) = 1 if x > 0 else 0
    
    Args:
        x: 输入值或数组
        
    Returns:
        ReLU导数值，值为0或1
        
    Examples:
        >>> relu_derivative(0)
        0.0
        >>> relu_derivative(np.array([-1, 0, 1]))
        array([0., 0., 1.])
    """
    return np.where(x > 0, 1.0, 0.0)
```

**注意事项：**
- x=0处导数在数学上未定义
- 实践中通常设为0或1
- 本实现选择设为0

## 可视化系统设计

### 1. 图形创建模块

```python
import matplotlib.pyplot as plt
import numpy as np

def create_figure(figsize=(12, 8), layout='single'):
    """
    创建图形画布
    
    Args:
        figsize: 图形尺寸
        layout: 布局类型 ('single', 'comparison', 'comprehensive')
        
    Returns:
        fig: 图形对象
        axes: 坐标轴对象
    """
    # 设置中文字体
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Arial Unicode MS', 'DejaVu Sans']
    plt.rcParams['axes.unicode_minus'] = False
    
    if layout == 'single':
        fig, ax = plt.subplots(figsize=figsize)
        return fig, ax
    elif layout == 'comparison':
        fig, axes = plt.subplots(2, 2, figsize=figsize)
        return fig, axes
    elif layout == 'comprehensive':
        fig = plt.figure(figsize=(22, 16))
        gs = fig.add_gridspec(4, 4, height_ratios=[1, 1, 1, 0.8],
                             hspace=0.4, wspace=0.3)
        return fig, gs
```

### 2. 曲线绘制模块

```python
def plot_activation_curve(ax, x, y, name, color, marker='o'):
    """
    绘制激活函数曲线
    
    Args:
        ax: 坐标轴对象
        x: x轴数据
        y: y轴数据
        name: 函数名称
        color: 颜色
        marker: 标记样式
    """
    # 绘制主曲线
    ax.plot(x, y, color=color, linewidth=3, label=name, alpha=0.8)
    
    # 添加网格
    ax.grid(True, alpha=0.3, linestyle='--')
    
    # 添加参考线
    ax.axhline(y=0, color='k', linestyle='-', alpha=0.3)
    ax.axvline(x=0, color='k', linestyle='-', alpha=0.3)
    
    # 设置标签
    ax.set_xlabel('Input Value (x)', fontsize=11)
    ax.set_ylabel('Output f(x)', fontsize=11)
    
    # 添加图例
    ax.legend(fontsize=10)
```

### 3. 标注系统

```python
def add_key_point_annotations(ax, x_points, y_points, labels, color):
    """
    添加关键点标注
    
    Args:
        ax: 坐标轴对象
        x_points: x坐标列表
        y_points: y坐标列表
        labels: 标签列表
        color: 标注颜色
    """
    for x, y, label in zip(x_points, y_points, labels):
        ax.scatter([x], [y], s=120, c=color, marker='o', 
                  alpha=0.7, edgecolor='white', linewidth=2, zorder=5)
        
        ax.annotate(
            f'{label}\n({x:.1f} → {y:.2f})',
            (x, y),
            xytext=(8, 8),
            textcoords='offset points',
            bbox=dict(boxstyle="round,pad=0.3", facecolor=color, alpha=0.3),
            fontsize=9,
            ha='center'
        )
```

### 4. 表格生成模块

```python
def create_comparison_table(ax, data, headers):
    """
    创建对比表格
    
    Args:
        ax: 坐标轴对象
        data: 表格数据
        headers: 表头
    """
    ax.axis('off')
    
    # 创建表格
    table = ax.table(
        cellText=data,
        colLabels=headers,
        cellLoc='center',
        loc='center',
        colWidths=[0.12, 0.12, 0.19, 0.19, 0.19]
    )
    
    # 设置样式
    table.auto_set_font_size(False)
    table.set_fontsize(11)
    table.scale(1, 2)
    
    # 设置表头样式
    for i in range(len(headers)):
        table[(0, i)].set_facecolor('#495057')
        table[(0, i)].set_text_props(weight='bold', color='white')
    
    return table
```

## 综合分析脚本详解

### 1. 主程序结构

```python
# activation_optimized_final.py 主程序结构

def main():
    """主函数"""
    # 1. 配置设置
    setup_matplotlib_config()
    
    # 2. 数据准备
    x_smooth = np.linspace(-5, 5, 1000)
    input_values = np.array([-2.5, -0.5, 0.8, 2.0, 3.5])
    
    # 3. 计算激活函数值
    sigmoid_y = sigmoid(x_smooth)
    tanh_y = tanh_func(x_smooth)
    relu_y = relu(x_smooth)
    
    # 4. 计算示例点
    sigmoid_output = sigmoid(input_values)
    tanh_output = tanh_func(input_values)
    relu_output = relu(input_values)
    
    # 5. 创建可视化
    fig = plt.figure(figsize=(22, 16))
    gs = fig.add_gridspec(4, 4, height_ratios=[1, 1, 1, 0.8],
                         hspace=0.4, wspace=0.3)
    
    # 6. 绘制各个子图
    plot_individual_functions(fig, gs, ...)
    plot_comparison(fig, gs, ...)
    create_table(fig, gs, ...)
    add_insights(fig, gs, ...)
    
    # 7. 保存图像
    plt.savefig('../user_data/activation_comparison_optimized.png', dpi=300)
    
    # 8. 输出分析报告
    print_analysis_report(...)

if __name__ == "__main__":
    main()
```

### 2. 配置模块

```python
def setup_matplotlib_config():
    """设置Matplotlib配置"""
    # 字体配置
    plt.rcParams['font.family'] = ['SimHei', 'Arial Unicode MS', 
                                    'DejaVu Sans', 'Arial', 'sans-serif']
    plt.rcParams['axes.unicode_minus'] = False
    plt.rcParams['font.size'] = 10
    
    # 颜色配置
    COLORS = {
        'sigmoid': '#1f77b4',
        'tanh': '#d62728',
        'relu': '#2ca02c'
    }
    
    # 标记配置
    MARKERS = {
        'sigmoid': 'o',
        'tanh': 's',
        'relu': '^'
    }
    
    return COLORS, MARKERS
```

### 3. 分析报告生成

```python
def print_analysis_report(input_values, sigmoid_output, tanh_output, relu_output):
    """
    打印分析报告
    
    Args:
        input_values: 输入值数组
        sigmoid_output: Sigmoid输出
        tanh_output: Tanh输出
        relu_output: ReLU输出
    """
    labels = ['Neuron A', 'Neuron B', 'Neuron C', 'Neuron D', 'Neuron E']
    
    # 推荐映射
    recommendations = {
        -2.5: "ReLU (Negative → 0)",
        -0.5: "Tanh (Moderate output)",
        0.8: "Tanh (Balanced)",
        2.0: "ReLU (Linear preserve)",
        3.5: "ReLU (Linear preserve)"
    }
    
    print("\n" + "="*70)
    print("ACTIVATION FUNCTIONS ANALYSIS REPORT")
    print("="*70)
    print(f"{'Neuron':<10} {'Input':<8} {'Sigmoid':<10} {'Tanh':<10} {'ReLU':<10} {'Best Choice'}")
    print("-" * 70)
    
    for i, label in enumerate(labels):
        x = input_values[i]
        sig = sigmoid_output[i]
        tan = tanh_output[i]
        rel = relu_output[i]
        best = recommendations[x]
        
        print(f"{label:<10} {x:<8.1f} {sig:<10.3f} {tan:<10.3f} {rel:<10.1f} {best}")
    
    print("\n" + "="*70)
    print("CRITICAL FINDINGS:")
    print("• Sigmoid: Stable output range (0,1) - perfect for probability")
    print("• Tanh: Zero-centered symmetry - negative inputs produce negative outputs")
    print("• ReLU: Directly clips negatives to 0 - highest computational efficiency")
    print("• Deep networks: Prioritize ReLU; output layer: task-dependent")
    print("="*70)
```

## 错误处理和调试

### 1. 输入验证

```python
def validate_input(x):
    """
    验证输入数据
    
    Args:
        x: 输入数据
        
    Raises:
        TypeError: 输入类型错误
        ValueError: 输入值错误
    """
    if not isinstance(x, (int, float, np.ndarray, list)):
        raise TypeError(f"输入类型必须是数字或数组，当前类型: {type(x)}")
    
    if isinstance(x, (list, np.ndarray)):
        x = np.asarray(x)
        if not np.all(np.isfinite(x)):
            raise ValueError("输入包含非有限值(inf或nan)")
    
    return np.asarray(x)
```

### 2. 数值安全计算

```python
def safe_sigmoid(x):
    """安全的Sigmoid计算，防止溢出"""
    x = np.clip(x, -500, 500)  # 限制范围防止溢出
    return 1 / (1 + np.exp(-x))

def safe_exp(x):
    """安全的指数计算"""
    x = np.clip(x, -700, 700)  # 防止溢出
    return np.exp(x)
```

### 3. 调试工具

```python
def debug_activation_values(x, func_name):
    """
    调试激活函数值
    
    Args:
        x: 输入值
        func_name: 函数名称
    """
    funcs = {
        'sigmoid': sigmoid,
        'tanh': tanh_func,
        'relu': relu
    }
    
    func = funcs.get(func_name)
    if func is None:
        print(f"未知函数: {func_name}")
        return
    
    y = func(x)
    
    print(f"\n=== {func_name.upper()} 调试信息 ===")
    print(f"输入范围: [{np.min(x):.2f}, {np.max(x):.2f}]")
    print(f"输出范围: [{np.min(y):.4f}, {np.max(y):.4f}]")
    print(f"输出均值: {np.mean(y):.4f}")
    print(f"输出标准差: {np.std(y):.4f}")
    print(f"包含NaN: {np.any(np.isnan(y))}")
    print(f"包含Inf: {np.any(np.isinf(y))}")
```

---

*最后更新: 2026年2月15日*
*代码实现版本: v1.0*
*开发团队: AI系统开发组*
