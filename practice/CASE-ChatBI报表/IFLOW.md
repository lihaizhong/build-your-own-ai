# CASE-ChatBI报表 - IFLOW 指南

## 项目概述

CASE-ChatBI报表是一个智能商业智能（BI）分析系统，专注于构建交互式的股票数据分析和报表生成平台。该项目基于自然语言处理技术，提供ChatBI智能助手功能，能够理解用户的自然语言查询并生成相应的SQL查询和数据可视化结果。

## 核心技术栈

- **AI引擎**: qwen-agent 智能对话框架
- **数据处理**: SQLAlchemy 数据库连接，pandas 数据操作
- **可视化**: matplotlib 图表生成和样式定制
- **数据库**: SQLite/MySQL 股票数据存储
- **预测模型**: ARIMA、Prophet 时间序列分析
- **Web界面**: 交互式查询和结果展示
- **API集成**: 股票数据获取和处理

## 项目特点

### 智能交互功能
- **自然语言查询**: 用户可以用自然语言描述需求，系统自动生成SQL查询
- **ChatBI助手**: 基于qwen-agent的智能对话界面
- **动态SQL生成**: 智能解析用户意图并生成相应的数据库查询

### 数据分析能力
- **股票数据处理**: 完整的历史价格、成交量数据处理
- **时间序列预测**: 集成ARIMA、Prophet等专业预测模型
- **财务指标计算**: 自动计算各种财务和技术指标
- **趋势分析**: 智能识别价格趋势和模式

### 可视化展示
- **交互式图表**: 动态生成各种类型的图表（线图、柱状图、K线图等）
- **实时数据更新**: 支持实时数据查询和图表更新
- **多维度展示**: 支持多维度数据对比和分析
- **导出功能**: 支持图表和数据导出

## 快速开始

### 环境要求
- Python >= 3.11
- 推荐使用 uv 管理虚拟环境

### 安装依赖
```bash
cd CASE-ChatBI报表
uv sync
```

### 启动ChatBI助手
```bash
# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows

# 运行ChatBI助手
python stock_query_assistant-5.py
```

### 使用说明

#### 基础查询示例
```
用户: "显示苹果公司(AAPL)最近一年的股价走势"
系统: 自动生成SQL查询，检索AAPL股票数据并生成价格走势图

用户: "分析微软(MSFT)过去6个月的交易量变化"
系统: 查询MSFT交易量数据，生成交易量变化图表

用户: "预测特斯拉(TSLA)未来30天的股价"
系统: 使用Prophet模型进行股价预测并展示结果
```

#### 高级分析功能
- **技术指标分析**: 自动计算移动平均线、RSI、MACD等技术指标
- **对比分析**: 支持多只股票或多个时间段的对比分析
- **财务报表分析**: 生成财务数据报表和分析报告
- **风险评估**: 提供投资风险评估和建议

## 文件结构

```
CASE-ChatBI报表/
├── IFLOW.md                                    # 项目指南文档
├── stock_query_assistant-5.py                 # 最新版本ChatBI助手（推荐）
├── stock_query_assistant-3.py                 # 增强版本ChatBI助手
├── stock_query_assistant.py                   # 基础版本ChatBI助手
├── stock_data.db                              # 股票数据库文件
├── requirements.txt                           # 项目依赖列表
└── README.md                                  # 项目说明文档
```

## 核心功能模块

### 1. 智能查询引擎 (stock_query_assistant-5.py)
- **自然语言处理**: 解析用户查询意图
- **SQL生成**: 自动生成优化的SQL查询语句
- **查询执行**: 安全执行数据库查询操作
- **结果处理**: 格式化查询结果和错误处理

### 2. 数据处理模块
- **数据清洗**: 清理和标准化原始数据
- **特征工程**: 生成技术指标和衍生特征
- **数据验证**: 确保数据完整性和准确性
- **缓存机制**: 优化频繁查询的性能

### 3. 可视化模块
- **图表生成**: matplotlib基础图表渲染
- **交互式图表**: 支持缩放、筛选等交互功能
- **多图表支持**: 线图、柱状图、K线图、散点图等
- **样式定制**: 统一的图表样式和主题

### 4. 预测分析模块
- **ARIMA模型**: 经典时间序列预测
- **Prophet模型**: Facebook开发的时间序列预测工具
- **模型评估**: 预测精度评估和模型选择
- **预测可视化**: 预测结果图表展示

## 使用场景

### 1. 投资决策支持
- **股价查询**: 快速获取任意股票的历史和实时数据
- **趋势分析**: 识别股价趋势和反转点
- **风险评估**: 基于历史数据的风险分析

### 2. 金融研究
- **数据挖掘**: 从大量金融数据中发现规律
- **因子分析**: 分析影响股价的关键因子
- **回测分析**: 验证投资策略的有效性

### 3. 商业报告
- **自动化报表**: 生成标准化的金融分析报表
- **多维度分析**: 提供全面的投资组合分析
- **导出功能**: 支持PDF、Excel等格式导出

## 技术实现亮点

### 1. 智能SQL生成
```python
def generate_sql_query(user_query: str) -> str:
    """根据用户自然语言查询生成SQL语句"""
    # 使用qwen-agent解析用户意图
    # 生成对应的SQL查询语句
    # 返回优化后的查询结果
```

### 2. 高效数据处理
```python
def process_stock_data(data: pd.DataFrame) -> pd.DataFrame:
    """处理股票数据，计算技术指标"""
    # 数据清洗和预处理
    # 计算移动平均线、RSI等技术指标
    # 返回处理后的数据
```

### 3. 专业预测模型
```python
def forecast_stock_price(data: pd.Series, model_type: str = 'prophet') -> dict:
    """股价预测分析"""
    # 选择合适的预测模型
    # 训练和验证模型
    # 生成预测结果和置信区间
```

## 性能优化

### 1. 查询优化
- **索引优化**: 优化数据库索引提升查询速度
- **缓存机制**: 缓存频繁查询的结果
- **分页查询**: 大数据量查询的分页处理

### 2. 图表性能
- **懒加载**: 图表组件按需加载
- **数据抽样**: 大数据集的智能抽样
- **WebGL加速**: 使用WebGL提升图表渲染性能

### 3. 预测模型优化
- **模型选择**: 根据数据特点选择最优模型
- **参数调优**: 自动化超参数调优
- **集成预测**: 多个模型结果的集成优化

## 扩展功能

### 1. 多数据源支持
- **实时数据**: 集成实时股价数据API
- **财务数据**: 添加财务报表和基本面数据
- **新闻数据**: 整合新闻情绪分析

### 2. 高级分析
- **机器学习**: 集成更多机器学习算法
- **深度学习**: LSTM、GRU等深度学习预测模型
- **风险建模**: VaR、CVaR等风险度量模型

### 3. 协作功能
- **用户系统**: 多用户支持和权限管理
- **分享功能**: 分析结果的在线分享
- **协作工具**: 团队协作和注释功能

## 最佳实践

### 1. 查询设计
- 使用明确的股票代码和查询条件
- 合理设置时间范围避免性能问题
- 利用缓存机制提升查询效率

### 2. 数据分析
- 结合技术分析和基本面分析
- 注意数据的时效性和准确性
- 使用多个时间周期进行验证

### 3. 风险管理
- 预测结果仅供参考，不构成投资建议
- 注意市场波动和不确定性
- 建立完善的风险控制机制

## 故障排除

### 常见问题

1. **数据库连接失败**
   ```python
   # 检查数据库文件是否存在
   import os
   if not os.path.exists('stock_data.db'):
       print("数据库文件不存在，请先初始化数据")
   ```

2. **图表显示异常**
   ```python
   # 检查matplotlib后端设置
   import matplotlib
   matplotlib.use('TkAgg')  # 或使用其他可用的后端
   ```

3. **预测结果不准确**
   - 检查历史数据的质量和完整性
   - 调整模型参数或尝试不同的预测模型
   - 考虑外部因素的影响

### 调试技巧
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 数据验证
def debug_data(data):
    print(f"数据形状: {data.shape}")
    print(f"数据类型: {data.dtypes}")
    print(f"缺失值: {data.isnull().sum()}")
```

## 版本历史

- **v5.0**: 最新版本，集成完整的ChatBI功能和高级分析特性
- **v3.0**: 增强版本，添加了预测分析和多图表支持
- **v1.0**: 基础版本，实现了基本的查询和可视化功能

## 贡献指南

### 开发规范
- 遵循PEP 8代码风格
- 添加详细的代码注释和文档字符串
- 确保新功能包含相应的测试用例

### 代码提交
1. Fork项目仓库
2. 创建功能分支
3. 编写测试用例
4. 提交Pull Request

## 联系支持

- 项目文档: 查看IFLOW.md文件
- 技术问题: 通过GitHub Issues提交
- 功能建议: 欢迎提交功能需求和改进建议

---

*最后更新: 2025年11月24日*
*版本: v5.0*
*项目状态: 活跃开发中*