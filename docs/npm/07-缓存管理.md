# 场景七：缓存管理

## 场景描述

管理 npm 缓存，提高安装速度，解决缓存相关问题。

## 涉及命令

### 1. npm cache verify

**用途**: 验证缓存完整性

**语法**:
```bash
npm cache verify
```

**说明**: 检查缓存内容的完整性和一致性，自动清理损坏的缓存。

**示例**:
```bash
npm cache verify
```

**输出示例**:
```
Cache verified and compressed (~150 MB)
```

---

### 2. npm cache clean

**用途**: 清理 npm 缓存

**语法**:
```bash
npm cache clean [--force]
```

**说明**: 删除所有缓存内容。从 npm 5 开始，需要添加 `--force` 参数。

**示例**:
```bash
# 清理缓存
npm cache clean --force
```

**注意**: 清理缓存后，下次安装时会重新下载包，速度会变慢。

---

### 3. npm config get cache

**用途**: 查看缓存目录位置

**语法**:
```bash
npm config get cache
```

**示例**:
```bash
$ npm config get cache
/Users/username/.npm
```

**缓存目录结构**:
```
~/.npm/
├── _cacache/        # 内容寻址缓存
├── _logs/           # 日志文件
└── _locks/          # 锁文件
```

---

## 缓存工作原理

### 缓存机制

1. **下载缓存**: 下载的包会存储在缓存中
2. **内容寻址**: 使用 SHA-512 哈希存储，确保完整性
3. **复用机制**: 安装时优先使用缓存
4. **自动清理**: 定期清理过期缓存

### 缓存的好处

- **提高速度**: 减少重复下载
- **节省带宽**: 减少网络传输
- **离线安装**: 支持离线环境
- **版本一致性**: 确保使用相同版本

---

## 使用场景

### 场景 1: 安装速度慢

```bash
# 验证缓存
npm cache verify

# 如果缓存损坏，清理缓存
npm cache clean --force

# 重新安装
npm install
```

### 场景 2: 解决安装错误

```bash
# 遇到安装错误时
npm install

# 清理缓存重试
npm cache clean --force
npm install
```

### 场景 3: 检查缓存大小

```bash
# 查看缓存目录
npm config get cache

# 查看缓存大小
du -sh ~/.npm

# 或在 macOS/Linux
du -sh $(npm config get cache)
```

### 场景 4: 离线安装

```bash
# 在线环境预先下载
npm install --prefer-offline

# 或使用缓存
npm cache verify
npm install --offline
```

### 场景 5: 切换缓存位置

```bash
# 设置自定义缓存目录
npm config set cache /path/to/cache

# 验证设置
npm config get cache
```

---

## 最佳实践

### 1. 定期验证缓存

```bash
# 每月验证一次
npm cache verify
```

### 2. 仅在必要时清理缓存

```bash
# 只在遇到问题时清理
npm cache clean --force
```

### 3. 使用自定义缓存目录

```bash
# 设置缓存目录
npm config set cache /custom/path/npm-cache
```

### 4. 离线环境配置

```bash
# 设置离线模式
npm config set offline true

# 或在安装时指定
npm install --offline
```

### 5. 缓存优化

```bash
# 使用 npm ci（不使用缓存）
npm ci

# 使用 npm install（使用缓存）
npm install

# 预热缓存
npm install --prefer-offline
```

---

## 缓存相关配置

### 查看缓存配置

```bash
# 查看缓存目录
npm config get cache

# 查看缓存相关配置
npm config list | grep cache
```

### 配置选项

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| `cache` | 缓存目录路径 | `~/.npm` |
| `cache-min` | 缓存最小时间（秒） | 10 |
| `cache-max` | 缓存最大时间（秒） | Infinity |
| `prefer-offline` | 优先使用缓存 | false |
| `prefer-online` | 优先使用在线 | false |

### 设置配置

```bash
# 设置缓存目录
npm config set cache /custom/path

# 设置最小缓存时间
npm config set cache-min 3600

# 优先使用缓存
npm config set prefer-offline true
```

---

## 常见问题

### Q: 如何查看缓存大小？

```bash
# Linux/macOS
du -sh $(npm config get cache)

# 或查看具体缓存
du -sh ~/.npm/_cacache
```

### Q: 缓存占用太多空间怎么办？

```bash
# 验证并压缩缓存
npm cache verify

# 清理缓存
npm cache clean --force

# 或设置自动清理
npm config set cache-min 86400  # 24小时
```

### Q: 如何完全禁用缓存？

```bash
# 临时禁用
npm install --cache /dev/null

# 或设置缓存目录为空
npm config set cache /tmp/npm-cache
```

### Q: 缓存损坏怎么办？

```bash
# 验证缓存
npm cache verify

# 清理缓存
npm cache clean --force

# 重新安装
npm install
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm cache verify` | 验证缓存 |
| `npm cache clean` | 清理缓存 |
| `npm config get cache` | 查看缓存目录 |
| `npm config set cache` | 设置缓存目录 |

---

*最后更新: 2026年2月11日*