# 场景六：版本管理

## 场景描述

管理 npm 包的版本号，使用语义化版本规范，管理版本标签。

## 涉及命令

### 1. npm version

**用途**: 更新包的版本号

**语法**:
```bash
npm version <release-type>      # 更新版本
npm version <version>          # 指定版本号
npm version major              # 主版本 +1
npm version minor              # 次版本 +1
npm version patch              # 修订号 +1
npm version premajor           # 预发布主版本
npm version preminor           # 预发布次版本
npm version prepatch           # 预发布修订版
npm version prerelease         # 预发布版本
npm version from-git           # 从 git 标签获取版本
```

**示例**:
```bash
# 补丁版本：修复 bug
npm version patch  # 1.0.0 → 1.0.1

# 次版本：添加新功能
npm version minor  # 1.0.0 → 1.1.0

# 主版本：破坏性变更
npm version major  # 1.0.0 → 2.0.0

# 预发布版本
npm version prerelease  # 1.0.0 → 1.0.1-0

# 指定版本号
npm version 2.0.0
```

**副作用**: 执行 `npm version` 会自动创建 git tag。

---

### 2. npm dist-tag

**用途**: 管理包的发布标签

**语法**:
```bash
npm dist-tag add <package>@<version> <tag>    # 添加标签
npm dist-tag rm <package> <tag>               # 删除标签
npm dist-tag ls <package>                     # 列出标签
npm dist-tag ls                               # 列出所有包的标签
```

**示例**:
```bash
# 添加 latest 标签
npm dist-tag add my-package@2.0.0 latest

# 添加 beta 标签
npm dist-tag add my-package@2.0.0-beta.1 beta

# 添加 alpha 标签
npm dist-tag add my-package@2.0.0-alpha.1 alpha

# 列出包的所有标签
npm dist-tag ls my-package

# 删除标签
npm dist-tag rm my-package beta

# 安装特定标签的版本
npm install my-package@beta
```

---

## 语义化版本规范

### 版本号格式

```
MAJOR.MINOR.PATCH-PRERELEASE+BUILD
```

| 部分 | 说明 | 示例 |
|------|------|------|
| MAJOR | 主版本号 | 1.0.0 |
| MINOR | 次版本号 | 1.2.0 |
| PATCH | 修订号 | 1.2.3 |
| PRERELEASE | 预发布标识 | 1.2.3-alpha.1 |
| BUILD | 构建元数据 | 1.2.3+20130313144700 |

### 版本更新规则

| 类型 | 规则 | 示例 |
|------|------|------|
| **主版本 (Major)** | 不兼容的 API 修改 | 1.0.0 → 2.0.0 |
| **次版本 (Minor)** | 向下兼容的功能性新增 | 1.0.0 → 1.1.0 |
| **修订号 (Patch)** | 向下兼容的问题修正 | 1.0.0 → 1.0.1 |
| **预发布 (Pre-release)** | 预发布版本 | 1.0.0-alpha.1 |

### 版本范围符号

| 符号 | 说明 | 示例 | 匹配版本 |
|------|------|------|---------|
| `^` | 兼容次版本更新 | `^1.2.3` | `>=1.2.3 <2.0.0` |
| `~` | 兼容补丁更新 | `~1.2.3` | `>=1.2.3 <1.3.0` |
| `>` | 大于 | `>1.2.3` | `>1.2.3` |
| `>=` | 大于等于 | `>=1.2.3` | `>=1.2.3` |
| `<` | 小于 | `<1.2.3` | `<1.2.3` |
| `<=` | 小于等于 | `<=1.2.3` | `<=1.2.3` |
| `*` | 任意版本 | `*` | 任意版本 |
| `x` | 任意版本 | `1.x` | `>=1.0.0 <2.0.0` |
| 无符号 | 精确版本 | `1.2.3` | `=1.2.3` |
| `-` | 范围 | `1.2.3 - 2.0.0` | `>=1.2.3 <=2.0.0` |
| `||` | 或 | `^1.0.0 || ^2.0.0` | `^1.0.0` 或 `^2.0.0` |

---

## 版本标签管理

### 常用标签

| 标签 | 说明 | 用途 |
|------|------|------|
| `latest` | 最新稳定版 | 默认安装标签 |
| `beta` | 测试版 | 功能测试 |
| `alpha` | 内测版 | 早期测试 |
| `next` | 下一个版本 | 候选版本 |
| `canary` | 金丝雀版 | 尝试性发布 |

### 使用场景

```bash
# 1. 开发阶段
npm version prerelease  # 1.0.0-0
npm publish --tag alpha

# 2. 测试阶段
npm version prerelease  # 1.0.0-1
npm publish --tag beta

# 3. 正式发布
npm version patch  # 1.0.0
npm publish --tag latest
```

---

## 使用场景

### 场景 1: 发布补丁版本

```bash
# 1. 修复 bug
# ... 代码修改 ...

# 2. 更新版本
npm version patch

# 3. 提交代码
git push origin main
git push --tags

# 4. 发布
npm publish
```

### 场景 2: 发布次版本

```bash
# 1. 添加新功能
# ... 代码修改 ...

# 2. 更新版本
npm version minor

# 3. 提交并发布
git push origin main --tags
npm publish
```

### 场景 3: 发布主版本

```bash
# 1. 进行破坏性变更
# ... 代码修改 ...

# 2. 更新版本
npm version major

# 3. 更新 CHANGELOG
# 4. 提交并发布
git push origin main --tags
npm publish
```

### 场景 4: 预发布版本

```bash
# 1. 开发新功能
npm version prerelease
npm publish --tag alpha

# 2. 测试版本
npm version prerelease
npm publish --tag beta

# 3. 正式发布
npm version patch
npm publish --tag latest
```

### 场景 5: 维护多个版本

```bash
# 维护旧版本
npm version patch  # 1.0.0 → 1.0.1
npm publish

# 开发新版本
npm version minor  # 1.0.1 → 1.1.0
npm publish
```

---

## 最佳实践

### 1. 遵循语义化版本

```bash
# 只修改 bug
npm version patch

# 添加新功能
npm version minor

# 破坏性变更
npm version major
```

### 2. 使用预发布标签

```bash
# 开发版本
npm version prerelease
npm publish --tag alpha

# 测试版本
npm publish --tag beta
```

### 3. 维护 CHANGELOG

```markdown
## [1.1.0] - 2026-02-11
### Added
- 新功能 A
- 新功能 B

### Changed
- 改进 C

## [1.0.1] - 2026-02-10
### Fixed
- 修复 bug D
```

### 4. 自动化版本管理

使用 semantic-release 自动发布：

```bash
npm install -D semantic-release
```

```json
{
  "scripts": {
    "release": "semantic-release"
  }
}
```

### 5. 版本锁定

```json
{
  "dependencies": {
    "critical-package": "1.2.3",  // 精确版本
    "stable-package": "^1.2.3"     // 兼容次版本
  }
}
```

---

## 常见问题

### Q: 如何查看当前版本？

```bash
npm view <package> version

# 或查看 package.json
cat package.json | grep version
```

### Q: 如何回退版本？

```bash
# 修改 package.json 中的版本号
# 然后发布
npm publish --force
```

### Q: 如何同时发布多个标签？

```bash
npm dist-tag add my-package@2.0.0 latest
npm dist-tag add my-package@2.0.0 next
```

### Q: 如何查看所有预发布版本？

```bash
npm view <package> versions | grep -E '(alpha|beta|rc)'
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm version` | 更新版本号 |
| `npm dist-tag` | 管理版本标签 |
| `npm view` | 查看包信息 |
| `npm publish` | 发布包 |
| `git tag` | 查看 git 标签 |

---

## 相关资源

- [语义化版本规范](https://semver.org/lang/zh-CN/)
- [npm semver 计算器](https://semver.npmjs.com/)
- [Semantic Release 文档](https://github.com/semantic-release/semantic-release)

---

*最后更新: 2026年2月11日*