# 场景九：调试与诊断

## 场景描述

检查和解决项目问题，包括安全审计、环境诊断、依赖分析等。

## 涉及命令

### 1. npm audit

**用途**: 检查项目依赖的安全漏洞

**语法**:
```bash
npm audit                         # 检查安全漏洞
npm audit fix                     # 自动修复漏洞
npm audit fix --force             # 强制修复（可能破坏性更新）
npm audit --json                  # 以 JSON 格式输出
npm audit --production            # 只检查生产依赖
npm audit --dev                   # 只检查开发依赖
```

**示例**:
```bash
# 检查安全漏洞
npm audit

# 自动修复
npm audit fix

# 强制修复
npm audit fix --force

# 查看详细信息
npm audit --json
```

**输出说明**:
| 级别 | 说明 |
|------|------|
| Critical | 严重漏洞 |
| High | 高危漏洞 |
| Moderate | 中危漏洞 |
| Low | 低危漏洞 |
| Info | 信息提示 |

---

### 2. npm doctor

**用途**: 诊断 npm 环境问题

**语法**:
```bash
npm doctor
```

**说明**: 检查 npm 配置、权限、网络、缓存等。

**检查项目**:
- npm 版本
- node 版本
- git 版本
- 网络连接
- 缓存状态
- 文件权限
- 注册表访问

---

### 3. npm explain

**用途**: 解释为什么安装了某个包

**语法**:
```bash
npm explain <package>             # 解释包的安装原因
npm explain <package> --json      # JSON 格式输出
```

**示例**:
```bash
# 解释为什么安装了某个包
npm explain lodash

# JSON 格式输出
npm explain lodash --json
```

---

### 4. npm diff

**用途**: 比较依赖的差异

**语法**:
```bash
npm diff                         # 比较 node_modules 和 package.json
npm diff <package>               # 比较特定包
npm diff --diff=                 # 指定输出格式
```

**示例**:
```bash
# 查看依赖差异
npm diff

# 比较特定包
npm diff express

# 查看详细差异
npm diff --diff=verbose
```

---

### 5. npm fund

**用途**: 查看依赖的资金信息

**语法**:
```bash
npm fund                         # 查看资金信息
npm fund <package>               # 查看特定包的资金信息
```

**示例**:
```bash
# 查看所有依赖的资金信息
npm fund

# 查看特定包的资金信息
npm fund express
```

---

## 使用场景

### 场景 1: 检查安全漏洞

```bash
# 检查安全漏洞
npm audit

# 查看详细信息
npm audit --json

# 自动修复
npm audit fix

# 强制修复（谨慎使用）
npm audit fix --force
```

### 场景 2: 诊断环境问题

```bash
# 运行诊断
npm doctor

# 根据输出修复问题
```

### 场景 3: 查看依赖来源

```bash
# 查看为什么安装了某个包
npm explain lodash

# JSON 格式输出
npm explain lodash --json
```

### 场景 4: 比较依赖差异

```bash
# 查看当前依赖和 package.json 的差异
npm diff

# 比较特定包
npm diff express
```

### 场景 5: 分析依赖树

```bash
# 列出依赖树
npm ls

# 查看深度
npm ls --depth=0

# 查找重复依赖
npm ls | grep "^└─" | sort | uniq -c | sort -nr
```

---

## 安全最佳实践

### 1. 定期进行安全审计

```bash
# 定期运行
npm audit

# 在 CI/CD 中运行
npm audit --audit-level=moderate
```

### 2. 自动修复漏洞

```bash
# 自动修复
npm audit fix

# 只在必要时强制修复
npm audit fix --force
```

### 3. 锁定依赖版本

```bash
# 使用 package-lock.json
npm install

# 或使用精确版本
npm install package@1.2.3
```

### 4. 更新依赖

```bash
# 检查过时的包
npm outdated

# 更新依赖
npm update

# 更新到最新版本
npm install package@latest
```

---

## 调试技巧

### 1. 查看详细日志

```bash
# 启用详细日志
npm install --verbose

# 或设置日志级别
npm config set loglevel verbose
```

### 2. 使用调试模式

```bash
# 启用调试
npm install --loglevel silly
```

### 3. 查看错误堆栈

```bash
# 查看详细错误
npm install --parseable
```

### 4. 检查文件权限

```bash
# 检查权限
ls -la ~/.npm

# 修复权限
sudo chown -R $USER ~/.npm
```

---

## 常见问题

### Q: npm audit fix 失败怎么办？

```bash
# 查看详细信息
npm audit --json

# 手动修复
npm install package@safe-version

# 或强制修复
npm audit fix --force
```

### Q: 如何查看依赖树？

```bash
# 列出依赖树
npm ls

# 只显示顶层依赖
npm ls --depth=0

# 查看特定包
npm ls <package>
```

### Q: 如何查看包的大小？

```bash
# 使用 npm view
npm view <package> dist.unpackedSize

# 或使用 npx
npx size-limit
```

### Q: 如何清理重复依赖？

```bash
# 查看重复依赖
npm ls | grep duplicate

# 优化依赖树
npm dedupe

# 重新安装
npm ci
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm audit` | 安全审计 |
| `npm doctor` | 环境诊断 |
| `npm explain` | 解释包的安装原因 |
| `npm diff` | 比较依赖差异 |
| `npm fund` | 查看资金信息 |
| `npm ls` | 列出依赖 |
| `npm outdated` | 查看过时的包 |

---

## 相关工具

### 第三方工具

```bash
# 检查漏洞
npm install -D snyk
npx snyk test

# 检查依赖
npm install -D depcheck
npx depcheck

# 检查过期依赖
npm install -D npm-check-updates
npx ncu
```

---

*最后更新: 2026年2月11日*