# 场景四：包发布

## 场景描述

将自己开发的包发布到 npm 仓库，供其他开发者使用。

## 涉及命令

### 1. npm publish

**用途**: 发布包到 npm 仓库

**语法**:
```bash
npm publish                    # 发布包
npm publish --tag <tag>        # 带标签发布
npm publish --access <access>  # 设置访问权限
npm publish --dry-run          # 模拟发布（不实际发布）
```

**示例**:
```bash
# 基本发布
npm publish

# 发布到最新标签
npm publish --tag latest

# 发布为测试版
npm publish --tag beta

# 发布私有包
npm publish --access restricted

# 发布公共包
npm publish --access public

# 模拟发布（测试）
npm publish --dry-run
```

---

### 2. npm deprecate

**用途**: 标记包或特定版本为已弃用

**语法**:
```bash
npm deprecate <package>[@<version>] <message>
```

**示例**:
```bash
# 弃用整个包
npm deprecate my-package "This package is deprecated, use new-package instead"

# 弃用特定版本
npm deprecate my-package@1.0.0 "Security issues, please upgrade to 2.0.0"

# 弃用版本范围
npm deprecate my-package@<2.0.0 "Please upgrade to version 2.0.0 or higher"
```

---

### 3. npm unpublish

**用途**: 从 npm 仓库移除已发布的包

**语法**:
```bash
npm unpublish <package>        # 移除整个包（限制条件多）
npm unpublish <package>@<version>  # 移除特定版本
npm unpublish --force          # 强制移除（72小时内）
```

**示例**:
```bash
# 移除特定版本（推荐）
npm unpublish my-package@1.0.0

# 移除整个包（有严格限制）
npm unpublish my-package

# 强制移除（发布后 72 小时内）
npm unpublish my-package@1.0.0 --force
```

**注意事项**:
- 只能在发布后 72 小时内移除
- 包不能有其他依赖者
- 一旦有其他包依赖，就不能 unpublish

---

## 发布流程

### 步骤 1: 准备工作

```bash
# 1. 注册 npm 账号（如果还没有）
npm adduser

# 2. 登录
npm login

# 3. 验证登录状态
npm whoami
```

---

### 步骤 2: 准备 package.json

确保 `package.json` 包含必要信息：

```json
{
  "name": "my-awesome-package",
  "version": "1.0.0",
  "description": "An awesome npm package",
  "main": "index.js",
  "files": [
    "index.js",
    "lib/"
  ],
  "keywords": [
    "awesome",
    "package"
  ],
  "author": "Your Name <you@example.com>",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/username/my-awesome-package.git"
  },
  "bugs": {
    "url": "https://github.com/username/my-awesome-package/issues"
  },
  "homepage": "https://github.com/username/my-awesome-package#readme"
}
```

---

### 步骤 3: 创建 .npmignore

排除不需要发布的文件：

```
# 依赖
node_modules/

# 测试
tests/
*.test.js
__tests__/

# 文档
docs/
*.md

# 配置文件
.gitignore
.env
.travis.yml

# 开发文件
.vscode/
.idea/
```

---

### 步骤 4: 验证包

```bash
# 模拟发布，检查是否有问题
npm publish --dry-run

# 查看将要发布的内容
npm pack
tar -tf *.tgz
```

---

### 步骤 5: 发布

```bash
# 正式发布
npm publish

# 或指定标签
npm publish --tag latest
```

---

## 私有包发布

### 发布到官方 npm

```bash
# 创建私有包（包名以 @scope/ 开头）
{
  "name": "@username/my-package"
}

# 发布私有包
npm publish --access restricted
```

### 发布到私有仓库

```bash
# 配置私有仓库
npm config set registry https://registry.example.com

# 登录
npm login --registry=https://registry.example.com

# 发布
npm publish
```

---

## 版本管理

### 语义化版本

遵循 [SemVer](https://semver.org/) 规范：

- **主版本号 (Major)**: 不兼容的 API 修改
- **次版本号 (Minor)**: 向下兼容的功能性新增
- **修订号 (Patch)**: 向下兼容的问题修正

### npm version 命令

```bash
npm version patch      # 1.0.0 → 1.0.1
npm version minor      # 1.0.0 → 1.1.0
npm version major      # 1.0.0 → 2.0.0
npm version preminor   # 1.0.0 → 1.1.0-0
npm version prerelease # 1.0.0 → 1.0.1-0

# 指定版本
npm version 2.0.0

# 发布预发布版本
npm version prerelease
npm publish --tag beta
```

---

## 发布后操作

### 查看已发布的包

```bash
# 查看包信息
npm view <package>

# 查看所有版本
npm view <package> versions

# 在浏览器中打开
npm repo <package>
npm home <package>
```

### 更新包

```bash
# 更新版本
npm version patch

# 重新发布
npm publish
```

### 弃用旧版本

```bash
# 弃用特定版本
npm deprecate my-package@1.0.0 "Security issues, upgrade to 2.0.0"
```

---

## 最佳实践

### 1. 使用语义化版本

```bash
# 只修改 bug
npm version patch

# 添加新功能
npm version minor

# 破坏性变更
npm version major
```

### 2. 先在本地测试

```bash
# 链接到本地测试
npm link

# 在其他项目中测试
cd other-project
npm link my-package
```

### 3. 使用预发布标签

```bash
# 发布 alpha 版本
npm version prerelease
npm publish --tag alpha

# 发布 beta 版本
npm version prerelease
npm publish --tag beta
```

### 4. 自动化发布

使用 GitHub Actions 自动发布：

```yaml
name: Publish to npm

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### 5. 保持 package.json 整洁

```json
{
  "name": "my-package",
  "version": "1.0.0",
  "description": "A concise description",
  "main": "index.js",
  "types": "index.d.ts",
  "files": [
    "index.js",
    "index.d.ts",
    "lib/"
  ],
  "keywords": [
    "keyword1",
    "keyword2"
  ],
  "author": "Author Name",
  "license": "MIT",
  "repository": "url-to-repo"
}
```

---

## 常见问题

### Q: 发布时提示名称已被占用？

```bash
# 检查包名是否可用
npm view <package-name>

# 如果被占用，修改包名
{
  "name": "my-unique-package-name"
}
```

### Q: 如何发布作用域包？

```json
{
  "name": "@username/my-package"
}
```

```bash
npm publish --access public
```

### Q: 如何撤回已发布的包？

```bash
# 发布后 72 小时内
npm unpublish my-package@1.0.0 --force

# 72 小时后，只能弃用
npm deprecate my-package@1.0.0 "Use version 2.0.0 instead"
```

### Q: 如何发布到 GitHub Packages？

```bash
# 配置仓库
npm config set registry https://npm.pkg.github.com/username

# 登录
npm login --registry=https://npm.pkg.github.com

# 发布
{
  "name": "@username/my-package",
  "publishConfig": {
    "registry": "https://npm.pkg.github.com"
  }
}

npm publish
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm adduser` | 注册账号 |
| `npm login` | 登录 |
| `npm whoami` | 查看当前用户 |
| `npm publish` | 发布包 |
| `npm unpublish` | 移除包 |
| `npm deprecate` | 弃用包 |
| `npm version` | 更新版本 |
| `npm pack` | 打包但不发布 |

---

*最后更新: 2026年2月11日*