# 场景八：配置管理

## 场景描述

配置 npm 的行为和设置，包括注册表、代理、认证等。

## 涉及命令

### 1. npm config

**用途**: 管理 npm 配置

**语法**:
```bash
npm config list                    # 列出所有配置
npm config list -l                 # 列出所有配置（包括默认值）
npm config get <key>               # 获取配置项
npm config set <key> <value>       # 设置配置项
npm config delete <key>            # 删除配置项
npm config edit                    # 编辑配置文件
```

**示例**:
```bash
# 列出所有配置
npm config list

# 获取配置
npm config get registry
npm config get cache

# 设置配置
npm config set registry https://registry.npmjs.org/
npm config set cache /custom/path

# 删除配置
npm config delete registry

# 编辑配置文件
npm config edit
```

---

### 2. npm config edit

**用途**: 打开配置文件进行编辑

**语法**:
```bash
npm config edit
```

**说明**: 使用默认编辑器打开 `.npmrc` 配置文件。

---

## 配置文件位置

### 配置文件优先级（从高到低）

| 优先级 | 位置 | 说明 |
|-------|------|------|
| 1 | 命令行参数 | `npm install --registry=...` |
| 2 | 项目级 `.npmrc` | 项目根目录 |
| 3 | 用户级 `.npmrc` | `~/.npmrc` |
| 4 | 全局 `.npmrc` | `$PREFIX/etc/npmrc` |
| 5 | npm 内置配置 | npm 默认配置 |

### 项目级配置

```bash
# 项目根目录
project/
├── .npmrc
├── package.json
└── ...
```

### 用户级配置

```bash
# 用户主目录
~/.npmrc
```

---

## 常用配置项

### 注册表配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `registry` | npm 注册表地址 | `https://registry.npmjs.org/` |
| `scope` | 作用域 | `@mycompany` |

**示例**:
```bash
# 设置官方注册表
npm config set registry https://registry.npmjs.org/

# 设置淘宝镜像
npm config set registry https://registry.npmmirror.com

# 设置私有注册表
npm config set registry https://registry.example.com

# 设置作用域注册表
npm config set @mycompany:registry https://registry.example.com
```

---

### 认证配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `_auth` | Base64 编码的认证 | `dXNlcm5hbWU6cGFzc3dvcmQ=` |
| `_authToken` | 认证令牌 | `NjZ...` |
| `username` | 用户名 | `myuser` |
| `_password` | 加密的密码 | `(encrypted)` |

**示例**:
```bash
# 登录（自动配置认证）
npm login

# 手动设置认证
npm config set _authToken <token>

# 或使用 .npmrc
_authToken=NjZ...
```

---

### 缓存配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `cache` | 缓存目录 | `/path/to/cache` |
| `cache-min` | 缓存最小时间（秒） | `10` |
| `cache-max` | 缓存最大时间（秒） | `Infinity` |

**示例**:
```bash
# 设置缓存目录
npm config set cache /custom/path

# 设置缓存时间
npm config set cache-min 3600
```

---

### 代理配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `proxy` | HTTP 代理 | `http://proxy.example.com:8080` |
| `https-proxy` | HTTPS 代理 | `http://proxy.example.com:8080` |

**示例**:
```bash
# 设置代理
npm config set proxy http://proxy.example.com:8080
npm config set https-proxy http://proxy.example.com:8080

# 删除代理
npm config delete proxy
npm config delete https-proxy
```

---

### 网络配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `strict-ssl` | 严格 SSL 验证 | `true` |
| `fetch-retries` | 重试次数 | `2` |
| `fetch-retry-mintimeout` | 最小超时（毫秒） | `10000` |
| `fetch-retry-maxtimeout` | 最大超时（毫秒） | `60000` |
| `timeout` | 请求超时（毫秒） | `60000` |

**示例**:
```bash
# 禁用严格 SSL
npm config set strict-ssl false

# 设置重试次数
npm config set fetch-retries 3

# 设置超时时间
npm config set timeout 120000
```

---

### 其他配置

| 配置项 | 说明 | 示例 |
|-------|------|------|
| `save` | 自动保存到 package.json | `true` |
| `save-exact` | 保存精确版本 | `false` |
| `save-prefix` | 版本前缀 | `^` |
| `engine-strict` | 严格检查 engines | `false` |
| `loglevel` | 日志级别 | `notice` |

**示例**:
```bash
# 保存精确版本
npm config set save-exact true

# 严格检查 engines
npm config set engine-strict true

# 设置日志级别
npm config set loglevel verbose
```

---

## 使用场景

### 场景 1: 使用国内镜像

```bash
# 设置淘宝镜像
npm config set registry https://registry.npmmirror.com

# 验证
npm config get registry
```

### 场景 2: 配置私有注册表

```bash
# 设置私有注册表
npm config set registry https://registry.example.com

# 登录
npm login --registry=https://registry.example.com

# 或设置作用域注册表
npm config set @mycompany:registry https://registry.example.com
```

### 场景 3: 使用代理

```bash
# 设置代理
npm config set proxy http://proxy.example.com:8080
npm config set https-proxy http://proxy.example.com:8080

# 删除代理
npm config delete proxy
npm config delete https-proxy
```

### 场景 4: 项目级配置

```bash
# 在项目根目录创建 .npmrc
cat > .npmrc << EOF
registry=https://registry.npmmirror.com
save-exact=true
engine-strict=true
EOF
```

### 场景 5: 配置认证

```bash
# 登录
npm login

# 或手动配置
cat > ~/.npmrc << EOF
_authToken=your-token-here
registry=https://registry.example.com
EOF
```

---

## 最佳实践

### 1. 使用项目级配置

```bash
# 在项目根目录创建 .npmrc
registry=https://registry.npmmirror.com
save-exact=true
```

### 2. 保护敏感配置

```bash
# 不要提交 .npmrc 到 Git
echo ".npmrc" >> .gitignore

# 使用环境变量
echo "_authToken=$NPM_TOKEN" >> .npmrc
```

### 3. 使用配置文件模板

```bash
# 创建 .npmrc.example
registry=https://registry.npmmirror.com
# _authToken=your-token-here
```

### 4. 团队统一配置

```bash
# 在项目中使用统一的 .npmrc
cat > .npmrc << EOF
registry=https://registry.npmmirror.com
save-exact=true
engine-strict=true
EOF
```

### 5. 定期检查配置

```bash
# 查看当前配置
npm config list

# 查看所有配置
npm config list -l
```

---

## 常见问题

### Q: 如何切换不同的注册表？

```bash
# 切换到官方注册表
npm config set registry https://registry.npmjs.org/

# 切换到淘宝镜像
npm config set registry https://registry.npmmirror.com

# 切换到私有注册表
npm config set registry https://registry.example.com
```

### Q: 如何查看当前配置？

```bash
# 查看用户配置
npm config list

# 查看所有配置
npm config list -l

# 查看特定配置
npm config get registry
```

### Q: 如何重置配置？

```bash
# 删除特定配置
npm config delete registry

# 或编辑配置文件
npm config edit
```

### Q: 如何在不同环境使用不同配置？

```bash
# 使用环境变量
export NPM_REGISTRY=https://registry.npmmirror.com
npm config set registry $NPM_REGISTRY

# 或使用项目级配置
# 在项目根目录创建 .npmrc
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm config list` | 列出配置 |
| `npm config get` | 获取配置 |
| `npm config set` | 设置配置 |
| `npm config delete` | 删除配置 |
| `npm config edit` | 编辑配置 |
| `npm login` | 登录 |
| `npm logout` | 登出 |

---

*最后更新: 2026年2月11日*