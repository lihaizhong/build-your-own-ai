# 场景二：依赖管理

## 场景描述

管理项目的依赖包，包括安装、更新、卸载和查看依赖信息。

## 涉及命令

### 1. npm install

**用途**: 安装项目依赖

**语法**:
```bash
npm install                    # 安装 package.json 中的所有依赖
npm install <package>          # 安装指定包（生产依赖）
npm install <package> -D       # 安装开发依赖
npm install <package> -g       # 全局安装
npm install <package>@<version> # 安装指定版本
```

**示例**:
```bash
# 安装生产依赖
npm install express
npm install lodash@4.17.21

# 安装开发依赖
npm install -D typescript
npm install --save-dev jest

# 安装所有依赖
npm install

# 安装特定版本
npm install react@18.2.0
npm install react@^18.0.0

# 安装多个包
npm install express axios dotenv

# 全局安装
npm install -g create-react-app
npm install --global yarn
```

**版本符号说明**:
| 符号 | 说明 | 示例 |
|------|------|------|
| `^` | 兼容次版本更新 | `^1.2.3` → 允许 `1.x.x` |
| `~` | 兼容补丁更新 | `~1.2.3` → 允许 `1.2.x` |
| `*` | 任意版本 | `*` → 最新版本 |
| `>=` | 大于等于 | `>=1.0.0` |
| `<=` | 小于等于 | `<=2.0.0` |
| 无符号 | 精确版本 | `1.2.3` |

---

### 2. npm uninstall

**用途**: 卸载已安装的包

**语法**:
```bash
npm uninstall <package>        # 卸载生产依赖
npm uninstall <package> -D     # 卸载开发依赖
npm uninstall <package> -g     # 卸载全局包
```

**示例**:
```bash
# 卸载生产依赖
npm uninstall express

# 卸载开发依赖
npm uninstall -D typescript
npm uninstall --save-dev jest

# 卸载全局包
npm uninstall -g create-react-app

# 卸载多个包
npm uninstall express axios
```

---

### 3. npm update

**用途**: 更新包到最新兼容版本

**语法**:
```bash
npm update                     # 更新所有依赖
npm update <package>           # 更新指定包
npm update -g                  # 更新全局包
npm update --save              # 更新并更新 package.json
```

**示例**:
```bash
# 更新所有依赖
npm update

# 更新指定包
npm update lodash

# 更新全局包
npm update -g npm

# 更新到最新主版本（需要手动修改 package.json）
npm install lodash@latest
```

---

### 4. npm outdated

**用途**: 查看过时的包

**语法**:
```bash
npm outdated                   # 查看过时的依赖
npm outdated -g                # 查看过时的全局包
npm outdated --long            # 显示详细信息
```

**输出说明**:
| 列 | 说明 |
|------|------|
| Package | 包名 |
| Current | 当前安装版本 |
| Wanted | package.json 指定的最新兼容版本 |
| Latest | npm 上的最新版本 |
| Location | 依赖路径 |

---

### 5. npm ls

**用途**: 列出已安装的包

**语法**:
```bash
npm ls                         # 列出所有依赖
npm ls <package>               # 查看指定包的信息
npm ls -g                      # 列出全局包
npm ls --depth=0               # 只显示顶层依赖
npm ls --prod                  # 只显示生产依赖
npm ls --dev                   # 只显示开发依赖
```

**示例**:
```bash
# 列出所有依赖
npm ls

# 只显示顶层依赖
npm ls --depth=0

# 查看特定包
npm ls express

# 查看全局包
npm ls -g --depth=0
```

---

### 6. npm dedupe

**用途**: 优化依赖树，去重重复的包

**语法**:
```bash
npm dedupe                     # 优化依赖树
npm dedupe <package>           # 优化指定包的依赖
```

**说明**: 将重复安装的包提升到公共父级，减少安装体积。

---

### 7. npm prune

**用途**: 移除 package.json 中未列出的包

**语法**:
```bash
npm prune                      # 移除未使用的包
npm prune --production         # 只保留生产依赖
npm prune --dev                # 只保留开发依赖
```

**说明**: 清理 `node_modules` 中不需要的包。

---

## 使用场景

### 场景 1: 新项目安装依赖

```bash
# 克隆项目后
cd my-project
npm install                    # 安装所有依赖
```

### 场景 2: 添加新功能依赖

```bash
# 添加 Web 框架
npm install express

# 添加数据库驱动
npm install mongoose

# 添加工具库
npm install lodash
```

### 场景 3: 添加开发工具

```bash
# 添加 TypeScript
npm install -D typescript @types/node

# 添加测试框架
npm install -D jest @types/jest

# 添加代码格式化工具
npm install -D prettier eslint
```

### 场景 4: 更新依赖

```bash
# 检查过时的包
npm outdated

# 更新所有依赖
npm update

# 更新特定包到最新版本
npm install package@latest
```

### 场景 5: 清理项目

```bash
# 删除 node_modules
rm -rf node_modules

# 删除 package-lock.json
rm package-lock.json

# 重新安装
npm install

# 或使用 npm ci（更快，更严格）
npm ci
```

### 场景 6: 依赖审计

```bash
# 检查安全漏洞
npm audit

# 自动修复漏洞
npm audit fix

# 强制修复（可能破坏性更新）
npm audit fix --force
```

---

## 最佳实践

### 1. 锁定依赖版本

```bash
# 使用 package-lock.json 锁定版本
npm install

# CI/CD 环境使用 npm ci
npm ci  # 更快、更可靠的安装
```

### 2. 区分开发和生产依赖

```bash
# 生产依赖：运行时必需
npm install express mongoose

# 开发依赖：只在开发时使用
npm install -D typescript jest eslint
```

### 3. 定期更新依赖

```bash
# 查看过时的包
npm outdated

# 小版本更新
npm update

# 主版本更新需要测试
npm install package@latest
```

### 4. 使用精确版本

```json
{
  "dependencies": {
    "critical-package": "1.2.3"  // 精确版本
  }
}
```

### 5. 审计依赖

```bash
# 定期检查安全漏洞
npm audit

# 自动修复
npm audit fix
```

---

## 常见问题

### Q: npm install 和 npm ci 的区别？

| 特性 | npm install | npm ci |
|------|------------|--------|
| 用途 | 开发环境 | CI/CD 环境 |
| package-lock.json | 可选 | 必需 |
| 安装速度 | 较慢 | 快 |
| 依赖更新 | 更新 lock 文件 | 不更新 |
| 严格性 | 较宽松 | 严格 |

### Q: 如何处理依赖冲突？

```bash
# 查看依赖树
npm ls

# 使用 npm dedupe 优化
npm dedupe

# 手动解决版本冲突
npm install <package>@<version>
```

### Q: 如何减少 node_modules 大小？

```bash
# 使用 npm dedupe
npm dedupe

# 移除未使用的包
npm prune

# 使用 .npmignore 排除文件
```

### Q: 如何查看依赖的所有信息？

```bash
# 查看包的详细信息
npm view <package>

# 查看包的依赖
npm view <package> dependencies

# 查看包的版本历史
npm view <package> versions
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm help install` | 查看 install 命令帮助 |
| `npm help update` | 查看 update 命令帮助 |
| `npm help audit` | 查看 audit 命令帮助 |
| `npm ci` | 干净安装（CI/CD 推荐） |

---

*最后更新: 2026年2月11日*