# 场景三：脚本执行

## 场景描述

运行 `package.json` 中定义的脚本命令，用于构建、测试、启动项目等常见任务。

## 涉及命令

### 1. npm run

**用途**: 运行自定义脚本

**语法**:
```bash
npm run <script>               # 运行指定脚本
npm run <script> -- <args>     # 运行脚本并传递参数
npm run                        # 列出所有可用脚本
```

**示例**:
```bash
# 运行构建脚本
npm run build

# 运行开发服务器
npm run dev

# 运行测试
npm run test

# 传递参数
npm run build -- --prod
npm run test -- --watch
```

---

### 2. npm start

**用途**: 启动应用程序

**语法**:
```bash
npm start                      # 运行 start 脚本
```

**说明**: 等同于 `npm run start`

**示例**:
```json
{
  "scripts": {
    "start": "node server.js"
  }
}
```

---

### 3. npm test

**用途**: 运行测试

**语法**:
```bash
npm test                       # 运行 test 脚本
```

**说明**: 等同于 `npm run test`

---

### 4. npm stop

**用途**: 停止应用程序

**语法**:
```bash
npm stop                       # 运行 stop 脚本
```

**说明**: 等同于 `npm run stop`

---

### 5. npm restart

**用途**: 重启应用程序

**语法**:
```bash
npm restart                    # 先执行 stop，再执行 start
```

---

## 脚本配置

### 基本配置

在 `package.json` 中定义脚本：

```json
{
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "build": "webpack --mode production",
    "test": "jest",
    "lint": "eslint src/",
    "format": "prettier --write src/"
  }
}
```

### 生命周期脚本

npm 提供了自动执行的生命周期脚本：

| 生命周期 | 触发时机 |
|---------|---------|
| `preinstall` | install 之前 |
| `install` | install 之后 |
| `postinstall` | install 之后 |
| `prepublishOnly` | publish 之前 |
| `pretest` | test 之前 |
| `test` | 运行测试 |
| `posttest` | test 之后 |
| `prestart` | start 之前 |
| `start` | 运行 start |
| `poststart` | start 之后 |
| `prerestart` | restart 之前 |
| `restart` | 运行 restart |
| `postrestart` | restart 之后 |

**示例**:
```json
{
  "scripts": {
    "preinstall": "echo 'Installing dependencies...'",
    "postinstall": "npm run build",
    "pretest": "npm run lint",
    "test": "jest",
    "posttest": "npm run coverage"
  }
}
```

---

## 常用脚本模式

### 1. 开发环境脚本

```json
{
  "scripts": {
    "dev": "next dev",
    "serve": "vite preview",
    "watch": "webpack --watch"
  }
}
```

### 2. 构建脚本

```json
{
  "scripts": {
    "build": "webpack --mode production",
    "build:dev": "webpack --mode development",
    "build:analyze": "webpack --mode production --analyze"
  }
}
```

### 3. 测试脚本

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  }
}
```

### 4. 代码质量脚本

```json
{
  "scripts": {
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix",
    "format": "prettier --write src/",
    "format:check": "prettier --check src/",
    "type-check": "tsc --noEmit"
  }
}
```

### 5. 数据库脚本

```json
{
  "scripts": {
    "db:migrate": "prisma migrate dev",
    "db:seed": "prisma db seed",
    "db:studio": "prisma studio",
    "db:reset": "prisma migrate reset"
  }
}
```

---

## 环境变量

### npm 内置变量

npm 在脚本中提供了一些内置变量：

| 变量 | 说明 |
|------|------|
| `npm_package_name` | 包名 |
| `npm_package_version` | 包版本 |
| `npm_package_author` | 作者 |
| `npm_package_homepage` | 主页 |
| `npm_lifecycle_event` | 当前生命周期事件 |

**示例**:
```json
{
  "scripts": {
    "info": "echo $npm_package_name@$npm_package_version"
  }
}
```

### 使用环境变量

```json
{
  "scripts": {
    "start": "NODE_ENV=production node index.js",
    "dev": "NODE_ENV=development nodemon index.js"
  }
}
```

使用 `dotenv`:
```bash
npm install -D dotenv-cli
```

```json
{
  "scripts": {
    "start": "dotenv -- node index.js",
    "dev": "dotenv -- nodemon index.js"
  }
}
```

---

## 使用场景

### 场景 1: 开发工作流

```bash
# 1. 检查代码格式
npm run format:check

# 2. 运行 lint
npm run lint

# 3. 类型检查
npm run type-check

# 4. 运行测试
npm run test

# 5. 启动开发服务器
npm run dev
```

### 场景 2: 构建部署

```bash
# 1. 运行测试
npm run test

# 2. 构建生产版本
npm run build

# 3. 预览构建结果
npm run preview
```

### 场景 3: CI/CD 流程

```bash
# CI 脚本
npm ci
npm run lint
npm run test:ci
npm run build
```

### 场景 4: 数据库迁移

```bash
# 创建迁移
npm run db:migrate

# 填充数据
npm run db:seed

# 打开数据库 GUI
npm run db:studio
```

---

## 最佳实践

### 1. 命名规范

- 使用描述性的脚本名称
- 使用冒号分隔不同类别：`build:dev`, `test:coverage`
- 保持一致性

### 2. 使用并行执行

```bash
# 安装工具
npm install -D npm-run-all

# 配置脚本
{
  "scripts": {
    "start": "npm-run-all --parallel server client"
  }
}
```

### 3. 使用 cross-env 跨平台兼容

```bash
npm install -D cross-env
```

```json
{
  "scripts": {
    "start": "cross-env NODE_ENV=production node index.js"
  }
}
```

### 4. 链式脚本

```json
{
  "scripts": {
    "build": "npm run clean && npm run compile",
    "clean": "rimraf dist",
    "compile": "babel src -d dist"
  }
}
```

### 5. 文档化脚本

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "help": "echo 'Available scripts: dev, build, preview'"
  }
}
```

---

## 常见问题

### Q: 如何查看所有可用脚本？

```bash
npm run
# 或
npm run-script
```

### Q: 如何传递参数给脚本？

```bash
npm run build -- --prod
npm run test -- --watch --coverage
```

### Q: 如何在脚本中使用 Node.js？

```bash
npm run my-script
```

```json
{
  "scripts": {
    "my-script": "node -e 'console.log(process.env)'"
  }
}
```

### Q: 如何在 Windows 上运行 Unix 命令？

```bash
npm install -D cross-env
```

```json
{
  "scripts": {
    "start": "cross-env NODE_ENV=production node index.js"
  }
}
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `npm run <script>` | 运行自定义脚本 |
| `npm start` | 启动应用 |
| `npm test` | 运行测试 |
| `npm stop` | 停止应用 |
| `npm restart` | 重启应用 |

---

*最后更新: 2026年2月11日*