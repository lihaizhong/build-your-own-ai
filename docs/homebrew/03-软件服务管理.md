# 场景三：软件服务管理

## 场景描述

使用 Homebrew Services 管理后台服务，如数据库（MySQL、PostgreSQL）、消息队列（Redis、RabbitMQ）、Web 服务器（Nginx）等。

## 涉及命令

### 1. brew services

**用途**: 管理后台服务的统一命令

**语法**:
```bash
brew services                   # 列出所有服务状态
brew services list              # 同上
brew services start <service>   # 启动服务
brew services stop <service>    # 停止服务
brew services restart <service> # 重启服务
brew services run <service>     # 一次性运行（不注册）
brew services info <service>    # 查看服务详情
brew services cleanup           # 清理无效的服务配置
```

---

### 2. brew services list

**用途**: 列出所有服务状态

**语法**:
```bash
brew services list              # 列出所有服务
```

**输出说明**:
```bash
$ brew services list
Name          Status  User          File
dbus          none                   
mysql         started lihaizhong   ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
nginx         none                   
postgresql@14 none                   
redis         started lihaizhong   ~/Library/LaunchAgents/homebrew.mxcl.redis.plist
```

| 列 | 说明 |
|------|------|
| Name | 服务名称 |
| Status | 状态（started/stopped/none/error/unknown） |
| User | 运行用户 |
| File | LaunchAgent 配置文件路径 |

---

### 3. brew services start

**用途**: 启动服务并注册为开机自启

**语法**:
```bash
brew services start <service>   # 启动并注册自启
brew services start --all       # 启动所有已注册服务
```

**示例**:
```bash
# 启动 MySQL
$ brew services start mysql
==> Successfully started `mysql` (label: homebrew.mxcl.mysql)

# 启动 Redis
$ brew services start redis
==> Successfully started `redis` (label: homebrew.mxcl.redis)

# 启动 PostgreSQL
$ brew services start postgresql@14
==> Successfully started `postgresql@14` (label: homebrew.mxcl.postgresql@14)
```

---

### 4. brew services stop

**用途**: 停止服务并取消开机自启

**语法**:
```bash
brew services stop <service>    # 停止并取消自启
brew services stop --all        # 停止所有服务
```

**示例**:
```bash
# 停止 MySQL
$ brew services stop mysql
Stopping `mysql`... (might take a while)
==> Successfully stopped `mysql` (label: homebrew.mxcl.mysql)

# 停止所有服务
$ brew services stop --all
Stopping `mysql`... (might take a while)
==> Successfully stopped `mysql` (label: homebrew.mxcl.mysql)
Stopping `redis`... (might take a while)
==> Successfully stopped `redis` (label: homebrew.mxcl.redis)
```

---

### 5. brew services restart

**用途**: 重启服务

**语法**:
```bash
brew services restart <service> # 重启服务
brew services restart --all     # 重启所有服务
```

**示例**:
```bash
# 重启 MySQL
$ brew services restart mysql
==> Successfully stopped `mysql` (label: homebrew.mxcl.mysql)
==> Successfully started `mysql` (label: homebrew.mxcl.mysql)
```

---

### 6. brew services run

**用途**: 一次性运行服务（不注册开机自启）

**语法**:
```bash
brew services run <service>     # 运行但不注册
```

**示例**:
```bash
# 运行 MySQL（不会开机自启）
$ brew services run mysql
==> Successfully ran `mysql` (label: homebrew.mxcl.mysql)
```

---

### 7. brew services info

**用途**: 查看服务详细信息

**语法**:
```bash
brew services info <service>    # 查看服务详情
brew services info --json <service> # JSON 格式输出
brew services info --all        # 查看所有服务详情
```

**示例**:
```bash
$ brew services info mysql
mysql (homebrew.mxcl.mysql)
Running: ✅
Loaded: ✅
Schedulable: ✅
User: lihaizhong
PID: 12345
Port: 3306
Log: /opt/homebrew/var/log/mysql.log
Error: /opt/homebrew/var/log/mysql.error.log
```

---

### 8. brew services cleanup

**用途**: 清理无效的服务配置文件

**语法**:
```bash
brew services cleanup           # 清理无效配置
```

**说明**: 移除已卸载软件包的 LaunchAgent 配置文件。

---

## 常用服务配置

### 数据库服务

#### MySQL / MariaDB

```bash
# 安装
brew install mysql

# 启动服务
brew services start mysql

# 初始化安全配置
mysql_secure_installation

# 连接
mysql -u root -p

# 配置文件
/opt/homebrew/etc/my.cnf

# 数据目录
/opt/homebrew/var/mysql/
```

#### PostgreSQL

```bash
# 安装
brew install postgresql@14

# 启动服务
brew services start postgresql@14

# 创建数据库用户
createuser -s postgres

# 连接
psql -U postgres

# 配置文件
/opt/homebrew/var/postgresql@14/

# 常用命令
psql -l              # 列出数据库
createdb mydb        # 创建数据库
dropdb mydb          # 删除数据库
```

#### MongoDB

```bash
# 安装（需要 tap）
brew tap mongodb/brew
brew install mongodb-community

# 启动服务
brew services start mongodb-community

# 连接
mongosh

# 配置文件
/opt/homebrew/etc/mongod.conf

# 数据目录
/opt/homebrew/var/mongodb/
```

#### Redis

```bash
# 安装
brew install redis

# 启动服务
brew services start redis

# 连接
redis-cli

# 配置文件
/opt/homebrew/etc/redis.conf

# 测试连接
redis-cli ping  # 返回 PONG
```

### 消息队列服务

#### RabbitMQ

```bash
# 安装
brew install rabbitmq

# 启动服务
brew services start rabbitmq

# 管理界面
open http://localhost:15672
# 默认用户: guest / guest

# 命令行工具
rabbitmqctl status
rabbitmqctl list_queues
```

#### Kafka

```bash
# 安装
brew install kafka

# 启动 Zookeeper（Kafka 依赖）
brew services start zookeeper

# 启动 Kafka
brew services start kafka

# 配置文件
/opt/homebrew/etc/kafka/
```

### Web 服务器

#### Nginx

```bash
# 安装
brew install nginx

# 启动服务
brew services start nginx

# 默认页面
open http://localhost:8080

# 配置文件
/opt/homebrew/etc/nginx/nginx.conf

# 站点配置
/opt/homebrew/etc/nginx/servers/

# 测试配置
nginx -t

# 重新加载配置
nginx -s reload
```

#### Apache httpd

```bash
# 安装
brew install httpd

# 启动服务
brew services start httpd

# 默认页面
open http://localhost:8080

# 配置文件
/opt/homebrew/etc/httpd/httpd.conf
```

### 其他常用服务

#### Elasticsearch

```bash
# 安装
brew tap elastic/tap
brew install elastic/tap/elasticsearch-full

# 启动服务
brew services start elastic/tap/elasticsearch-full

# 测试
curl http://localhost:9200
```

#### Memcached

```bash
# 安装
brew install memcached

# 启动服务
brew services start memcached

# 连接
telnet localhost 11211
```

---

## 使用场景

### 场景 1: 开发环境数据库

```bash
# 安装并启动 MySQL
brew install mysql
brew services start mysql
mysql_secure_installation

# 安装并启动 Redis
brew install redis
brew services start redis

# 查看状态
brew services list
```

### 场景 2: 全栈开发环境

```bash
# 安装所有服务
brew install mysql redis nginx

# 启动所有服务
brew services start mysql
brew services start redis
brew services start nginx

# 检查端口
lsof -i :3306   # MySQL
lsof -i :6379   # Redis
lsof -i :8080   # Nginx
```

### 场景 3: 临时运行服务

```bash
# 仅运行一次，不注册自启
brew services run postgresql@14

# 停止临时运行的服务
brew services stop postgresql@14
```

### 场景 4: 批量管理服务

```bash
# 停止所有服务
brew services stop --all

# 重启所有服务
brew services restart --all

# 清理无效配置
brew services cleanup
```

### 场景 5: 查看服务日志

```bash
# 查看服务日志位置
brew services info mysql

# 查看日志
tail -f /opt/homebrew/var/log/mysql.log

# 查看错误日志
tail -f /opt/homebrew/var/log/mysql.error.log
```

---

## 服务管理原理

### LaunchAgent 配置

Homebrew Services 使用 macOS 的 launchd 管理服务，配置文件存放在：

| 类型 | 路径 | 说明 |
|------|------|------|
| LaunchAgent | `~/Library/LaunchAgents/` | 用户级服务 |
| LaunchDaemon | `/Library/LaunchDaemons/` | 系统级服务 |

**配置文件命名**: `homebrew.mxcl.<service>.plist`

**示例配置**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>homebrew.mxcl.redis</string>
    <key>ProgramArguments</key>
    <array>
        <string>/opt/homebrew/opt/redis/bin/redis-server</string>
        <string>/opt/homebrew/etc/redis.conf</string>
        <string>--daemonize no</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/opt/homebrew/var/log/redis.log</string>
    <key>StandardErrorPath</key>
    <string>/opt/homebrew/var/log/redis.log</string>
</dict>
</plist>
```

---

## 最佳实践

### 1. 服务命名约定

```bash
# 使用完整名称（特别是多版本）
brew services start postgresql@14
brew services start postgresql@15

# 查看可用服务
brew services list
```

### 2. 定期检查服务状态

```bash
# 检查所有服务
brew services list

# 检查特定服务
brew services info mysql
```

### 3. 配置开机自启

```bash
# 启动并注册自启
brew services start mysql

# 禁用自启
brew services stop mysql

# 仅运行不自启
brew services run mysql
```

### 4. 查看服务日志

```bash
# 日志位置
/opt/homebrew/var/log/

# 实时查看
tail -f /opt/homebrew/var/log/mysql.log
```

### 5. 使用 sudo 管理系统服务

```bash
# 系统级服务（需要 sudo）
sudo brew services start nginx

# 注意：通常不推荐使用 sudo
```

---

## 常见问题

### Q: 服务启动失败？

```bash
# 查看错误日志
brew services info <service>
tail -f /opt/homebrew/var/log/<service>.error.log

# 检查端口占用
lsof -i :3306

# 手动运行查看错误
brew services run <service>
```

### Q: 如何查看服务占用端口？

```bash
# 查看服务信息
brew services info mysql

# 查看端口占用
lsof -i :3306
netstat -an | grep 3306
```

### Q: 服务无法停止？

```bash
# 查找进程
ps aux | grep mysql

# 强制停止
brew services stop mysql
# 或手动杀死进程
kill -9 <PID>
```

### Q: 如何修改服务配置？

```bash
# 1. 停止服务
brew services stop mysql

# 2. 编辑配置文件
vim /opt/homebrew/etc/my.cnf

# 3. 重启服务
brew services start mysql
```

### Q: LaunchAgent 配置文件位置？

```bash
# 用户级服务
~/Library/LaunchAgents/homebrew.mxcl.<service>.plist

# 查看配置
cat ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `launchctl list` | 列出所有 launchd 服务 |
| `launchctl load` | 加载服务配置 |
| `launchctl unload` | 卸载服务配置 |
| `lsof -i :<port>` | 查看端口占用 |
| `ps aux | grep <service>` | 查看进程 |

---

*最后更新: 2026年2月28日*
