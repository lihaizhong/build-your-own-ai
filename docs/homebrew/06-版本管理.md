# 场景六：版本管理

## 场景描述

管理软件包的多个版本，包括安装特定版本、切换版本、查看版本历史等操作。

## 涉及命令

### 1. brew install <package>@<version>

**用途**: 安装指定版本的软件包

**语法**:
```bash
brew install <package>@<version>  # 安装指定版本
```

**示例**:
```bash
# 安装 Python 3.11
$ brew install python@3.11

# 安装 Python 3.12
$ brew install python@3.12

# 安装 PostgreSQL 14
$ brew install postgresql@14

# 安装 MySQL 8
$ brew install mysql@8.0
```

---

### 2. brew list --versions

**用途**: 查看已安装软件包的版本

**语法**:
```bash
brew list --versions           # 列出所有软件包版本
brew list --versions <package> # 查看指定软件包的所有版本
```

**示例**:
```bash
# 列出所有版本
$ brew list --versions
git 2.45.0
node 20.12.0
python@3.11 3.11.8
python@3.12 3.12.2

# 查看特定软件包版本
$ brew list --versions python
python@3.11 3.11.8
python@3.12 3.12.2

# 查看已安装的 Node 版本
$ brew list --versions node
node 18.19.0
node 20.12.0
```

---

### 3. brew info

**用途**: 查看软件包版本信息

**语法**:
```bash
brew info <package>            # 查看当前版本
brew info --json <package>     # JSON 格式
```

**示例**:
```bash
# 查看当前版本
$ brew info python@3.12
==> python@3.12: stable 3.12.2 (bottled)
Interpreted, interactive, object-oriented programming language
https://www.python.org/
/opt/homebrew/Cellar/python@3.12/3.12.2 (3,278 files, 61.8MB) *
```

---

### 4. brew unlink / brew link

**用途**: 切换软件包版本

**语法**:
```bash
brew unlink <package>          # 取消链接当前版本
brew link <package>            # 链接指定版本
brew link --force <package>    # 强制链接
brew link --overwrite <package> # 覆盖已存在的链接
```

**示例**:
```bash
# 切换 Python 版本
$ brew unlink python@3.11
Unlinking /opt/homebrew/Cellar/python@3.11/3.11.8... (3,267 symlinks removed)

$ brew link python@3.12
Linking /opt/homebrew/Cellar/python@3.12/3.12.2... 
Error: Could not symlink bin/2to3
Target /opt/homebrew/bin/2to3
already exists. You may want to remove it:
  rm '/opt/homebrew/bin/2to3'

# 强制链接
$ brew link --force --overwrite python@3.12
Linking /opt/homebrew/Cellar/python@3.12/3.12.2... (3,267 symlinks created)

# 验证
$ python3 --version
Python 3.12.2
```

---

### 5. brew switch

**用途**: 切换已安装软件包的版本（已废弃，使用 link 替代）

**语法**:
```bash
brew switch <package> <version>  # 切换版本（已废弃）
```

**说明**: 此命令在较新版本中已移除，建议使用 `brew unlink` + `brew link` 替代。

---

### 6. brew pin / brew unpin

**用途**: 锁定软件包版本，防止自动升级

**语法**:
```bash
brew pin <package>             # 锁定版本
brew unpin <package>           # 解锁版本
```

**示例**:
```bash
# 锁定 Node 版本
$ brew pin node

# 查看锁定的软件包
$ brew list --pinned
node

# 升级时跳过锁定的软件包
$ brew upgrade
# node 不会被升级

# 解锁
$ brew unpin node
```

---

### 7. brew extract

**用途**: 从历史版本中提取特定版本的 Formula

**语法**:
```bash
brew extract <package> <tap> --version=<version>
```

**示例**:
```bash
# 提取旧版本到自定义 Tap
$ brew extract node custom/tap --version=18.19.0

# 然后安装
$ brew install custom/tap/node@18.19.0
```

---

## 多版本管理场景

### 场景 1: Python 多版本管理

```bash
# 安装多个版本
brew install python@3.10
brew install python@3.11
brew install python@3.12

# 查看已安装版本
brew list --versions python

# 切换到 3.11
brew unlink python@3.12
brew link python@3.11

# 验证
python3 --version

# 使用 pyenv 更灵活管理（推荐）
brew install pyenv
pyenv install 3.11.0
pyenv install 3.12.0
pyenv global 3.11.0
```

### 场景 2: Node.js 多版本管理

```bash
# 安装多个版本
brew install node@18
brew install node@20

# 切换版本
brew unlink node@18
brew link node@20

# 使用 n 或 fnm 管理更灵活（推荐）
brew install n
n 18
n 20

# 或使用 fnm
brew install fnm
fnm install 18
fnm install 20
fnm use 20
```

### 场景 3: PostgreSQL 多版本管理

```bash
# 安装多个版本
brew install postgresql@14
brew install postgresql@15

# 切换版本
brew unlink postgresql@14
brew link postgresql@15

# 启动特定版本的服务
brew services start postgresql@15

# 数据目录
/opt/homebrew/var/postgresql@14/
/opt/homebrew/var/postgresql@15/
```

### 场景 4: MySQL 多版本管理

```bash
# 安装 MySQL 8.0
brew install mysql@8.0

# 安装 MySQL 5.7（需要 tap）
brew tap homebrew/cask-versions
brew install mysql@5.7

# 切换版本
brew unlink mysql@5.7
brew link mysql@8.0

# 启动服务
brew services start mysql@8.0
```

### 场景 5: Java 多版本管理

```bash
# 安装多个版本
brew install openjdk@11
brew install openjdk@17
brew install openjdk@21

# 链接特定版本
sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk

# 或使用 jenv 管理（推荐）
brew install jenv
jenv add /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
jenv global 17
```

---

## 版本管理工具对比

### Homebrew 原生方式

**优点**:
- 简单直接，无需额外工具
- 与系统集成良好

**缺点**:
- 切换版本需要手动 link/unlink
- 部分软件不支持多版本

### 推荐的版本管理工具

| 语言 | 推荐工具 | 安装命令 |
|------|---------|---------|
| Python | pyenv | `brew install pyenv` |
| Node.js | fnm / n / nvm | `brew install fnm` |
| Java | jenv | `brew install jenv` |
| Ruby | rbenv | `brew install rbenv` |
| Go | goenv | `brew install goenv` |
| Rust | rustup | `brew install rustup` |

---

## pyenv 使用示例

```bash
# 安装 pyenv
brew install pyenv

# 配置 shell
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.zshrc
echo '[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(pyenv init -)"' >> ~/.zshrc

# 安装 Python 版本
pyenv install 3.11.0
pyenv install 3.12.0
pyenv install 3.13.0

# 设置全局版本
pyenv global 3.12.0

# 设置项目版本
cd my-project
pyenv local 3.11.0

# 查看已安装版本
pyenv versions

# 查看当前版本
pyenv version
```

---

## fnm 使用示例

```bash
# 安装 fnm
brew install fnm

# 配置 shell
echo 'eval "$(fnm env --use-on-cd)"' >> ~/.zshrc

# 安装 Node 版本
fnm install 18
fnm install 20
fnm install 22

# 设置默认版本
fnm default 20

# 使用特定版本
fnm use 18

# 查看已安装版本
fnm list

# 查看当前版本
fnm current
```

---

## jenv 使用示例

```bash
# 安装 jenv
brew install jenv

# 配置 shell
echo 'export PATH="$HOME/.jenv/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(jenv init -)"' >> ~/.zshrc

# 添加 Java 版本
jenv add /opt/homebrew/opt/openjdk@11/libexec/openjdk.jdk/Contents/Home
jenv add /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk/Contents/Home
jenv add /opt/homebrew/opt/openjdk@21/libexec/openjdk.jdk/Contents/Home

# 设置全局版本
jenv global 17

# 设置项目版本
cd my-project
jenv local 11

# 查看已安装版本
jenv versions

# 查看当前版本
jenv version
```

---

## 最佳实践

### 1. 使用专用版本管理工具

对于开发语言，推荐使用专用工具而非 Homebrew 原生版本管理：

```bash
# Python
brew install pyenv

# Node.js
brew install fnm

# Java
brew install jenv
```

### 2. 锁定关键版本

```bash
# 锁定生产环境依赖的版本
brew pin postgresql@14
brew pin redis
```

### 3. 使用 Brewfile 记录版本

```ruby
# Brewfile
brew "python@3.12"
brew "node@20"
brew "postgresql@14"
brew "redis"
```

### 4. 定期检查版本

```bash
# 查看过时软件包
brew outdated

# 查看特定软件包版本
brew info --json=v2 python@3.12 | jq '.formulae[0].version'
```

---

## 常见问题

### Q: 如何安装已移除的旧版本？

```bash
# 方法 1: 使用 brew extract
brew extract <package> <tap> --version=<version>
brew install <tap>/<package>@<version>

# 方法 2: 从历史 commit 安装
cd "$(brew --repo homebrew/core)"
git log --oneline -- Formula/<package>.rb
git checkout <commit-hash> -- Formula/<package>.rb
brew install <package>
git checkout HEAD -- Formula/<package>.rb
```

### Q: 切换版本后命令不生效？

```bash
# 重新加载 shell 配置
source ~/.zshrc

# 或重新打开终端

# 检查 PATH
which python3
echo $PATH
```

### Q: 如何查看可用的版本？

```bash
# 搜索版本化的包
brew search python@

# 查看所有版本
brew info --json=v2 --installed | jq '.formulae[].name' | grep python
```

### Q: 版本冲突怎么办？

```bash
# 取消所有链接
brew unlink python@3.11
brew unlink python@3.12

# 重新链接需要的版本
brew link python@3.12
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `brew list --versions` | 查看版本 |
| `brew link` | 链接版本 |
| `brew unlink` | 取消链接 |
| `brew pin` | 锁定版本 |
| `brew info` | 查看信息 |

---

*最后更新: 2026年2月28日*
