# 场景七：缓存与清理

## 场景描述

管理 Homebrew 的缓存目录，清理旧版本软件包，释放磁盘空间。

## 涉及命令

### 1. brew cleanup

**用途**: 清理旧版本软件包和缓存

**语法**:
```bash
brew cleanup                   # 清理所有旧版本
brew cleanup <package>         # 清理指定软件包
brew cleanup -n                # 预览将要清理的内容
brew cleanup --prune=<days>    # 清理指定天数前的缓存
brew cleanup --prune=all       # 清理所有缓存
brew cleanup -s                # 清理所有缓存（包括下载缓存）
```

**示例**:
```bash
# 预览清理内容
$ brew cleanup -n
Would remove: /opt/homebrew/Cellar/git/2.44.0 (1,234 files, 30MB)
Would remove: /opt/homebrew/Cellar/node/20.10.0 (2,345 files, 50MB)
Would remove: ~/Library/Caches/Homebrew/node--20.10.0.arm64_sonoma.bottle.tar.gz (20MB)

# 清理所有旧版本
$ brew cleanup
Removing: /opt/homebrew/Cellar/git/2.44.0... (1,234 files, 30MB)
Removing: /opt/homebrew/Cellar/node/20.10.0... (2,345 files, 50MB)
Removing: ~/Library/Caches/Homebrew/node--20.10.0.arm64_sonoma.bottle.tar.gz... (20MB)
==> This operation has freed approximately 100MB of disk space.

# 清理指定软件包
$ brew cleanup node

# 清理 30 天前的缓存
$ brew cleanup --prune=30

# 清理所有缓存
$ brew cleanup --prune=all
```

---

### 2. brew cache

**用途**: 管理 Homebrew 缓存目录

**语法**:
```bash
brew cache                     # 显示缓存目录路径
brew cache --cask              # 显示 Cask 缓存目录
brew cache list                # 列出缓存内容
brew cache cleanup             # 清理缓存
```

**示例**:
```bash
# 查看缓存目录
$ brew cache
/Users/lihaizhong/Library/Caches/Homebrew

# 列出缓存内容
$ brew cache list
node--20.12.0.arm64_sonoma.bottle.tar.gz
python@3.12--3.12.2.arm64_sonoma.bottle.tar.gz
git--2.45.0.arm64_sonoma.bottle.tar.gz

# 清理缓存
$ brew cache cleanup
```

---

### 3. brew autoremove

**用途**: 自动移除不再需要的依赖包

**语法**:
```bash
brew autoremove                # 移除未使用的依赖
brew autoremove -n             # 预览将要移除的内容
```

**示例**:
```bash
# 预览
$ brew autoremove -n
Would autoremove 5 unneeded packages:
openssl@1.1
readline
sqlite
xz
gdbm

# 执行移除
$ brew autoremove
Uninstalling openssl@1.1... (100 files, 5MB)
Uninstalling readline... (200 files, 3MB)
...
==> This operation has freed approximately 20MB of disk space.
```

---

### 4. brew --cache

**用途**: 查看缓存路径

**语法**:
```bash
brew --cache                   # 缓存根目录
brew --cache <package>         # 特定软件包的缓存
brew --cache --cask <app>      # Cask 应用的缓存
```

**示例**:
```bash
# 缓存根目录
$ brew --cache
/Users/lihaizhong/Library/Caches/Homebrew

# 特定软件包缓存
$ brew --cache node
/Users/lihaizhong/Library/Caches/Homebrew/downloads/xxx--node--20.12.0.arm64_sonoma.bottle.tar.gz
```

---

## 缓存目录结构

```
~/Library/Caches/Homebrew/           # macOS 缓存目录
├── api/                             # API 缓存
│   └── formula.jws.json
├── downloads/                       # 下载文件缓存
│   ├── xxx--node--20.12.0.bottle.tar.gz
│   └── xxx--python@3.12--3.12.2.bottle.tar.gz
├── Cask/                            # Cask 缓存
│   ├── visual-studio-code/
│   └── docker/
├── font/                            # 字体缓存
├── bottles/                         # Bottle 缓存
└── logs/                            # 日志缓存
```

---

## 使用场景

### 场景 1: 定期清理磁盘空间

```bash
# 1. 查看可清理的空间
brew cleanup -n

# 2. 执行清理
brew cleanup

# 3. 清理未使用的依赖
brew autoremove

# 4. 验证磁盘空间
df -h /
```

### 场景 2: 完全清理 Homebrew 缓存

```bash
# 清理所有旧版本和缓存
brew cleanup --prune=all -s

# 或手动删除缓存目录
rm -rf "$(brew --cache)"
```

### 场景 3: 清理特定软件包

```bash
# 清理特定软件包的旧版本
brew cleanup node

# 清理特定软件包的缓存
rm -rf "$(brew --cache node)"
```

### 场景 4: 查看磁盘使用情况

```bash
# 查看 Homebrew 占用空间
du -sh "$(brew --prefix)"

# 查看缓存占用
du -sh "$(brew --cache)"

# 查看 Cellar 占用
du -sh "$(brew --cellar)"

# 查看各软件包占用
du -sh "$(brew --cellar)"/* | sort -hr | head -10
```

### 场景 5: 迁移缓存到其他位置

```bash
# 设置缓存目录
export HOMEBREW_CACHE="/path/to/cache"
export HOMEBREW_CASK_CACHE="/path/to/cask-cache"

# 写入 shell 配置
echo 'export HOMEBREW_CACHE="/path/to/cache"' >> ~/.zshrc
```

---

## 清理策略

### 自动清理

Homebrew 默认会定期自动清理：

```bash
# 查看自动清理设置
brew config | grep HOMEBREW_AUTO_UPDATE_SECS

# 禁用自动清理
export HOMEBREW_NO_INSTALL_CLEANUP=1

# 设置清理间隔（秒）
export HOMEBREW_AUTO_UPDATE_SECS=86400  # 每天
```

### 手动清理建议

```bash
# 每周执行一次
brew update
brew upgrade
brew cleanup
brew autoremove
brew doctor
```

---

## 最佳实践

### 1. 定期清理

```bash
# 创建清理脚本
cat > ~/.local/bin/brew-cleanup.sh << 'EOF'
#!/bin/bash
echo "=== Homebrew 清理开始 ==="

echo "1. 更新 Homebrew..."
brew update

echo "2. 查看过时的软件包..."
brew outdated

echo "3. 清理旧版本..."
brew cleanup -n
brew cleanup

echo "4. 移除未使用的依赖..."
brew autoremove -n
brew autoremove

echo "5. 检查系统..."
brew doctor

echo "6. 磁盘使用情况..."
echo "Homebrew 总占用: $(du -sh "$(brew --prefix)" | cut -f1)"
echo "缓存占用: $(du -sh "$(brew --cache)" 2>/dev/null | cut -f1)"

echo "=== Homebrew 清理完成 ==="
EOF

chmod +x ~/.local/bin/brew-cleanup.sh

# 运行
~/.local/bin/brew-cleanup.sh
```

### 2. 使用别名

```bash
# 添加到 ~/.zshrc 或 ~/.bashrc
alias bc='brew cleanup'
alias bca='brew cleanup --prune=all -s'
alias bar='brew autoremove'
alias bcp='brew cleanup -n'
alias bdu='du -sh "$(brew --cellar)"/* | sort -hr | head -10'
```

### 3. 清理前备份

```bash
# 导出软件包列表
brew bundle dump --file=~/Brewfile.backup

# 清理后恢复（如需要）
brew bundle install --file=~/Brewfile.backup
```

### 4. 监控磁盘空间

```bash
# 查看 Homebrew 占用
du -sh "$(brew --prefix)"/*

# 查看最大占用
du -sh "$(brew --cellar)"/* | sort -hr | head -10

# 查看缓存详情
brew cache list | wc -l
du -sh "$(brew --cache)"/*
```

---

## 常见问题

### Q: 清理后软件包还能用吗？

可以。`brew cleanup` 只删除旧版本和下载缓存，当前使用的版本不受影响。

### Q: 如何恢复被清理的软件包？

```bash
# 重新安装
brew reinstall <package>

# 如果是依赖被清理
brew install <package>
```

### Q: 清理不影响 Cask 应用吗？

不影响。Cask 应用的旧版本会被清理，但当前版本保留。

### Q: 缓存可以删除吗？

可以。缓存只是下载的安装包副本，删除后需要重新下载。

```bash
# 安全删除缓存
rm -rf "$(brew --cache)"
```

### Q: 如何查看清理释放了多少空间？

```bash
# 清理时会显示释放空间
brew cleanup

# 或提前查看
brew cleanup -n | grep "Would remove" | awk '{sum+=$NF} END {print "Total:", sum, "MB"}'
```

---

## 环境变量

| 变量 | 说明 |
|------|------|
| `HOMEBREW_CACHE` | 缓存目录 |
| `HOMEBREW_CASK_CACHE` | Cask 缓存目录 |
| `HOMEBREW_NO_INSTALL_CLEANUP` | 禁用安装后自动清理 |
| `HOMEBREW_CLEANUP_MAX_AGE_DAYS` | 清理超过指定天数的缓存（默认 120） |

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `brew cleanup` | 清理旧版本 |
| `brew cache` | 管理缓存 |
| `brew autoremove` | 移除未使用依赖 |
| `brew --cache` | 查看缓存路径 |
| `du -sh` | 查看磁盘占用 |

---

*最后更新: 2026年2月28日*
