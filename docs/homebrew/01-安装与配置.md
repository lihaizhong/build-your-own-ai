# 场景一：安装与配置

## 场景描述

在 macOS 或 Linux 系统上安装 Homebrew，并进行基本的环境配置。

## 涉及命令

### 1. 安装 Homebrew

**用途**: 在系统上安装 Homebrew 包管理器

**语法**:
```bash
# 官方安装脚本（macOS / Linux）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

**安装后配置（Apple Silicon Mac）**:
```bash
# 将 Homebrew 添加到 PATH
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"
```

**安装后配置（Linux）**:
```bash
# 将 Homebrew 添加到 PATH
test -d ~/.linuxbrew && eval "$(~/.linuxbrew/bin/brew shellenv)"
test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
echo "eval \"\$($(brew --prefix)/bin/brew shellenv)\"" >> ~/.bashrc
```

---

### 2. 卸载 Homebrew

**用途**: 完全卸载 Homebrew

**语法**:
```bash
# 官方卸载脚本
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"

# 静默卸载
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)" -- --quiet
```

---

### 3. brew --prefix

**用途**: 查看 Homebrew 安装路径

**语法**:
```bash
brew --prefix              # 显示 Homebrew 根目录
brew --prefix <package>    # 显示指定软件包的安装路径
```

**示例**:
```bash
# 查看 Homebrew 安装目录
$ brew --prefix
/opt/homebrew              # Apple Silicon Mac
/usr/local                 # Intel Mac

# 查看特定软件包路径
$ brew --prefix node
/opt/homebrew/opt/node
```

---

### 4. brew --cellar

**用途**: 查看 Cellar 目录路径

**语法**:
```bash
brew --cellar              # 显示 Cellar 目录
brew --cellar <package>    # 显示指定软件包的 Cellar 路径
```

---

### 5. brew config

**用途**: 查看 Homebrew 配置信息

**语法**:
```bash
brew config                # 显示完整配置
```

**输出示例**:
```
HOMEBREW_VERSION: 4.3.2
ORIGIN: https://github.com/Homebrew/brew
HEAD: 1a2b3c4d5e6f
Last commit: 1 week ago
Core tap JSON: 28 Feb 2026 12:00 UTC
Core tap origin: https://github.com/Homebrew/homebrew-core
Core tap HEAD: 1a2b3c4d5e6f
Core tap last commit: 1 day ago
Core tap branch: master
Core tap only: true
HOMEBREW_PREFIX: /opt/homebrew
HOMEBREW_CASK_OPTS: []
HOMEBREW_EDITOR: nano
HOMEBREW_MAKE_JOBS: 8
HOMEBREW_NO_INSTALL_FROM_API: set
Homebrew Ruby: 3.1.4 => /opt/homebrew/Library/Homebrew/vendor/portable-ruby/3.1.4/bin/ruby
CPU: octa-core 64-bit arm_blizzard_everest
Clang: 16.0.0 build 1600
Git: 2.53.0 => /opt/homebrew/bin/git
Curl: 8.7.1 => /usr/bin/curl
macOS: 15.3-arm64
CLT: 16.2.0.0.1.1733547573
Xcode: 16.2
```

---

### 6. brew env

**用途**: 查看或设置环境变量

**语法**:
```bash
brew env                   # 显示所有环境变量
brew env --shell           # 显示 shell 配置命令
```

---

## 环境变量配置

### 常用环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `HOMEBREW_PREFIX` | Homebrew 安装根目录 | `/opt/homebrew` 或 `/usr/local` |
| `HOMEBREW_CACHE` | 缓存目录 | `~/Library/Caches/Homebrew` |
| `HOMEBREW_TEMP` | 临时文件目录 | `/tmp` |
| `HOMEBREW_EDITOR` | 默认编辑器 | 系统编辑器 |
| `HOMEBREW_BREW_GIT_REMOTE` | brew Git 仓库地址 | GitHub |
| `HOMEBREW_CORE_GIT_REMOTE` | core Git 仓库地址 | GitHub |
| `HOMEBREW_NO_ANALYTICS` | 禁用分析统计 | 未设置 |
| `HOMEBREW_NO_AUTO_UPDATE` | 禁用自动更新 | 未设置 |
| `HOMEBREW_BOTTLE_DOMAIN` | Bottle 下载镜像 | 官方源 |

### 配置镜像源（中国大陆）

```bash
# 设置中科大镜像源
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.ustc.edu.cn/brew.git"
export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.ustc.edu.cn/homebrew-core.git"
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"
export HOMEBREW_API_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles/api"

# 写入 shell 配置文件
echo 'export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.ustc.edu.cn/brew.git"' >> ~/.zshrc
echo 'export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.ustc.edu.cn/homebrew-core.git"' >> ~/.zshrc
echo 'export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"' >> ~/.zshrc
echo 'export HOMEBREW_API_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles/api"' >> ~/.zshrc

# 清华镜像源
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git"
export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git"
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles"
```

### 常用配置

```bash
# 禁用自动更新（加快命令响应）
export HOMEBREW_NO_AUTO_UPDATE=1

# 禁用分析统计
export HOMEBREW_NO_ANALYTICS=1

# 设置编辑器
export HOMEBREW_EDITOR=vim

# 设置代理
export ALL_PROXY=socks5://127.0.0.1:7890
export http_proxy=http://127.0.0.1:7890
export https_proxy=http://127.0.0.1:7890
```

---

## 使用流程

### 流程 1: 全新安装 Homebrew

```bash
# 1. 安装 Xcode Command Line Tools（macOS）
xcode-select --install

# 2. 运行安装脚本
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 3. 配置 PATH（Apple Silicon Mac）
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"

# 4. 验证安装
brew --version

# 5. 更新到最新版本
brew update
```

### 流程 2: 配置镜像源

```bash
# 1. 设置环境变量
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.ustc.edu.cn/brew.git"
export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.ustc.edu.cn/homebrew-core.git"
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"

# 2. 写入配置文件
echo 'export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.ustc.edu.cn/brew.git"' >> ~/.zshrc
echo 'export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.ustc.edu.cn/homebrew-core.git"' >> ~/.zshrc
echo 'export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"' >> ~/.zshrc

# 3. 更新仓库
brew update
```

### 流程 3: 重置为官方源

```bash
# 1. 取消环境变量设置
unset HOMEBREW_BREW_GIT_REMOTE
unset HOMEBREW_CORE_GIT_REMOTE
unset HOMEBREW_BOTTLE_DOMAIN

# 2. 从配置文件中移除相关行
# 编辑 ~/.zshrc 或 ~/.bashrc

# 3. 重置 Git 远程地址
cd "$(brew --repo)"
git remote set-url origin https://github.com/Homebrew/brew.git

cd "$(brew --repo homebrew/core)"
git remote set-url origin https://github.com/Homebrew/homebrew-core.git

# 4. 更新
brew update
```

---

## 最佳实践

### 1. 定期更新

```bash
# 定期运行更新
brew update && brew upgrade
```

### 2. 使用 Bundle 管理软件包

```bash
# 创建 Brewfile
brew bundle dump

# 从 Brewfile 安装
brew bundle install

# 检查 Brewfile 一致性
brew bundle check
```

### 3. 配置自动补全

```bash
# zsh 配置
if type brew &>/dev/null; then
    FPATH=$(brew --prefix)/share/zsh-completions:$FPATH
    autoload -Uz compinit
    compinit
fi
```

### 4. 配置代理加速

```bash
# 设置代理
export ALL_PROXY=socks5://127.0.0.1:7890

# 或在需要时临时使用
export https_proxy=http://127.0.0.1:7890 brew install <package>
```

---

## 常见问题

### Q: Apple Silicon Mac 软件包不兼容？

确保使用正确的 Homebrew 路径：
```bash
# 检查架构
uname -m  # 应显示 arm64

# 确认 Homebrew 路径
brew --prefix  # 应为 /opt/homebrew
```

### Q: 如何查看当前使用的镜像源？

```bash
# 查看 Git 远程地址
cd "$(brew --repo)" && git remote -v
cd "$(brew --repo homebrew/core)" && git remote -v

# 查看环境变量
echo $HOMEBREW_BOTTLE_DOMAIN
```

### Q: 安装时权限不足？

```bash
# 修复权限（Intel Mac）
sudo chown -R $(whoami) /usr/local/Homebrew
sudo chown -R $(whoami) /usr/local/var/homebrew

# Apple Silicon Mac 通常不需要 sudo
```

### Q: Command Line Tools 问题？

```bash
# 重新安装 Command Line Tools
sudo rm -rf /Library/Developer/CommandLineTools
xcode-select --install
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `brew --version` | 查看版本 |
| `brew config` | 查看配置 |
| `brew doctor` | 诊断问题 |
| `brew update` | 更新 Homebrew |

---

*最后更新: 2026年2月28日*
