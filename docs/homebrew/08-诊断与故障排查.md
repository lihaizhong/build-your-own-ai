# 场景八：诊断与故障排查

## 场景描述

诊断 Homebrew 安装问题，排查软件包安装失败、链接错误等常见问题。

## 涉及命令

### 1. brew doctor

**用途**: 全面诊断 Homebrew 环境

**语法**:
```bash
brew doctor                    # 运行完整诊断
brew doctor --list-checks      # 列出所有检查项
brew doctor --audit-debug      # 调试模式
```

**示例**:
```bash
# 运行诊断
$ brew doctor
Your system is ready to brew.

# 如果有问题
$ brew doctor
Please note that these warnings are just used to help the Homebrew maintainers
with debugging if you file an issue. If everything you use Homebrew for is
working fine: please don't worry or file an issue; just ignore this. Thanks!

Warning: "config" scripts exist outside your system or Homebrew directories.
`./configure` scripts often look for *-config scripts to determine if
software packages are installed, and what additional flags to use when
compiling and linking.

Having additional scripts in your path can confuse software installed via
Homebrew if the config script overrides a system or Homebrew-provided
script of the same name. We found the following "config" scripts:
  /usr/local/bin/python-config
  /usr/local/bin/python3-config

Warning: You have unlinked kegs in your Cellar.
Leaving kegs unlinked can lead to build-trouble and cause formulae that depend on
those kegs to fail to compile properly, even if you specify your other formulae
correctly. Consider `brew link`ing them:
  node
  python@3.12
```

---

### 2. brew config

**用途**: 查看 Homebrew 配置信息

**语法**:
```bash
brew config                    # 显示完整配置
```

**输出说明**:
```bash
$ brew config
HOMEBREW_VERSION: 4.3.2
ORIGIN: https://github.com/Homebrew/brew
HEAD: 1a2b3c4d5e6f
Last commit: 1 week ago
Core tap JSON: 28 Feb 2026 12:00 UTC
Core tap origin: https://github.com/Homebrew/homebrew-core
Core tap HEAD: 1a2b3c4d5e6f
Core tap last commit: 1 day ago
Core tap branch: master
Core tap only: true
HOMEBREW_PREFIX: /opt/homebrew
HOMEBREW_CASK_OPTS: []
HOMEBREW_EDITOR: nano
HOMEBREW_MAKE_JOBS: 8
Homebrew Ruby: 3.1.4 => /opt/homebrew/Library/Homebrew/vendor/portable-ruby/3.1.4/bin/ruby
CPU: octa-core 64-bit arm_blizzard_everest
Clang: 16.0.0 build 1600
Git: 2.53.0 => /opt/homebrew/bin/git
Curl: 8.7.1 => /usr/bin/curl
macOS: 15.3-arm64
CLT: 16.2.0.0.1.1733547573
Xcode: 16.2
```

---

### 3. brew --env

**用途**: 查看构建环境变量

**语法**:
```bash
brew --env                     # 显示环境变量
brew --env --shell=bash        # Bash 格式输出
brew --env --shell=zsh         # Zsh 格式输出
```

---

### 4. brew missing

**用途**: 检查缺失的依赖

**语法**:
```bash
brew missing                   # 检查所有缺失依赖
brew missing <package>         # 检查特定软件包
```

**示例**:
```bash
$ brew missing
node: openssl@3
python@3.12: readline
```

---

### 5. brew linkage

**用途**: 检查软件包链接状态

**语法**:
```bash
brew linkage                   # 检查所有链接
brew linkage <package>         # 检查特定软件包
brew linkage --cached          # 显示缓存链接
brew linkage --reverse         # 反向查找
```

**示例**:
```bash
$ brew linkage node
System:
  /usr/lib/libSystem.B.dylib
  /usr/lib/libobjc.A.dylib

Homebrew:
  /opt/homebrew/opt/icu4c/lib/libicui18n.dylib
  /opt/homebrew/opt/icu4c/lib/libicuuc.dylib
  /opt/homebrew/opt/openssl@3/lib/libssl.3.dylib

Missing:
  libbrotli.1.dylib (libbrotlienc.1.dylib)
```

---

### 6. brew gist-logs

**用途**: 创建 Gist 分享日志

**语法**:
```bash
brew gist-logs <package>       # 上传构建日志到 Gist
brew gist-logs --new-issue <package> # 创建 GitHub Issue
```

---

## 常见问题诊断

### 问题 1: 权限问题

**症状**:
```
Error: Permission denied @ dir_s_mkdir - /usr/local/Cellar
```

**诊断与解决**:
```bash
# Intel Mac
sudo chown -R $(whoami) /usr/local/Homebrew
sudo chown -R $(whoami) /usr/local/var/homebrew
sudo chown -R $(whoami) /usr/local/Cellar
sudo chown -R $(whoami) /usr/local/var/log

# Apple Silicon Mac（通常不需要 sudo）
# 如果有问题，重新安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

---

### 问题 2: 链接问题

**症状**:
```
Error: Could not symlink bin/node
Target /opt/homebrew/bin/node
already exists. You may want to remove it:
```

**诊断与解决**:
```bash
# 查看链接状态
brew linkage <package>

# 强制覆盖链接
brew link --overwrite <package>

# 或手动删除冲突文件
rm /opt/homebrew/bin/node
brew link <package>
```

---

### 问题 3: 依赖问题

**症状**:
```
Error: An unexpected error occurred during the `brew link` step
```

**诊断与解决**:
```bash
# 检查缺失依赖
brew missing

# 安装缺失依赖
brew install <missing-package>

# 重新链接
brew unlink <package>
brew link <package>
```

---

### 问题 4: 下载失败

**症状**:
```
Error: Failed to download resource "node"
Download failed: https://ghcr.io/v2/homebrew/core/node/manifests/20.12.0
```

**诊断与解决**:
```bash
# 检查网络
curl -I https://ghcr.io

# 设置代理
export https_proxy=http://127.0.0.1:7890
export ALL_PROXY=socks5://127.0.0.1:7890

# 或使用镜像
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"

# 清理缓存重试
brew cleanup -s
brew install <package>
```

---

### 问题 5: 编译失败

**症状**:
```
Error: The following formulae cannot be compiled from source
```

**诊断与解决**:
```bash
# 安装 Xcode Command Line Tools
xcode-select --install

# 检查 CLT 状态
xcode-select -p

# 更新 CLT
sudo rm -rf /Library/Developer/CommandLineTools
xcode-select --install

# 使用预编译 Bottle
brew install --force-bottle <package>
```

---

### 问题 6: 版本冲突

**症状**:
```
Error: node 20.12.0 is already installed
```

**诊断与解决**:
```bash
# 查看已安装版本
brew list --versions node

# 升级
brew upgrade node

# 或重新安装
brew reinstall node
```

---

### 问题 7: Tap 问题

**症状**:
```
Error: No such file or directory @ rb_sysopen
```

**诊断与解决**:
```bash
# 更新 Tap
brew tap --repair

# 或删除重建
brew untap <user/repo>
brew tap <user/repo>

# 更新所有
brew update --force
```

---

### 问题 8: 服务无法启动

**症状**:
```
Error: Failure while executing; `/bin/launchctl load ...` exited with 5.
```

**诊断与解决**:
```bash
# 检查服务状态
brew services list

# 查看错误日志
brew services info <service>
tail -f /opt/homebrew/var/log/<service>.error.log

# 检查端口占用
lsof -i :<port>

# 手动运行诊断
brew services run <service>
```

---

## 使用场景

### 场景 1: 新环境诊断

```bash
# 完整诊断流程
brew doctor
brew config
brew missing
brew linkage

# 修复建议
brew cleanup
brew update
brew upgrade
```

### 场景 2: 安装失败排查

```bash
# 1. 查看错误日志
brew install <package> -v

# 2. 检查依赖
brew deps --tree <package>

# 3. 检查链接
brew linkage <package>

# 4. 尝试从源码编译
brew install --build-from-source <package>

# 5. 上传日志求助
brew gist-logs <package>
```

### 场景 3: 升级后问题

```bash
# 1. 检查状态
brew doctor
brew missing

# 2. 重新链接所有包
brew list --formula | xargs brew link --overwrite

# 3. 重新安装有问题的包
brew reinstall <package>
```

### 场景 4: 清理后修复

```bash
# 检查损坏的链接
brew linkage --cached

# 修复
brew linkage --fix

# 重新安装
brew reinstall <broken-package>
```

---

## 调试技巧

### 1. 详细日志

```bash
# 安装时显示详细输出
brew install -v <package>

# 调试模式
brew install --debug <package>

# 显示所有 shell 命令
brew install --display-times <package>
```

### 2. 查看 Formula

```bash
# 查看 Formula 源码
brew cat <package>

# 查看 Formula 路径
brew --repository homebrew/core
ls $(brew --repository homebrew/core)/Formula/

# 编辑 Formula
brew edit <package>
```

### 3. 检查环境

```bash
# 检查 PATH
echo $PATH | tr ':' '\n' | grep homebrew

# 检查 Git
which git
git --version

# 检查 Ruby
which ruby
ruby --version
```

---

## 最佳实践

### 1. 定期检查

```bash
# 每周执行
brew doctor
brew missing
```

### 2. 保持更新

```bash
# 定期更新
brew update
brew upgrade
```

### 3. 备份配置

```bash
# 导出 Brewfile
brew bundle dump

# 导出配置
brew config > ~/homebrew-config.txt
```

### 4. 记录错误

```bash
# 保存错误日志
brew install <package> 2>&1 | tee ~/install-error.log

# 上传 Gist
brew gist-logs <package>
```

---

## 重置 Homebrew

如果问题严重，可以考虑重置：

```bash
# 1. 备份 Brewfile
brew bundle dump --file=~/Brewfile.backup

# 2. 卸载 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"

# 3. 清理残留
rm -rf /opt/homebrew
rm -rf ~/Library/Caches/Homebrew
rm -rf ~/Library/Logs/Homebrew

# 4. 重新安装
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 5. 恢复软件包
brew bundle install --file=~/Brewfile.backup
```

---

## 相关命令

| 命令 | 说明 |
|------|------|
| `brew doctor` | 诊断问题 |
| `brew config` | 查看配置 |
| `brew missing` | 检查缺失依赖 |
| `brew linkage` | 检查链接状态 |
| `brew gist-logs` | 上传日志 |

---

## 获取帮助

### 官方资源

- [Homebrew 官方文档](https://docs.brew.sh/)
- [Homebrew GitHub Issues](https://github.com/Homebrew/brew/issues)
- [Homebrew Discourse 论坛](https://github.com/Homebrew/brew/discussions)

### 报告问题时提供的信息

```bash
# 收集诊断信息
brew config
brew doctor
brew install --debug --verbose <package> 2>&1 | head -100
```

---

*最后更新: 2026年2月28日*
